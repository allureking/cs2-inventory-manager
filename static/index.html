<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CS2 Inventory Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    /* ── Base ────────────────────────────────────────────────────────── */
    html { color-scheme: dark; scroll-behavior: smooth; }
    [x-cloak] { display: none !important; }
    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      background: #060d1a;
      background-image:
        radial-gradient(ellipse 70% 40% at 15% 5%, rgba(59,130,246,0.07) 0%, transparent 60%),
        radial-gradient(ellipse 50% 35% at 88% 90%, rgba(139,92,246,0.06) 0%, transparent 60%),
        radial-gradient(ellipse 30% 25% at 50% 50%, rgba(16,185,129,0.02) 0%, transparent 70%);
      min-height: 100vh;
    }

    /* ── Scrollbar ───────────────────────────────────────────────────── */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(71,85,105,0.5); border-radius: 2px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(100,116,139,0.7); }

    /* ── Form controls — force dark everywhere ───────────────────────── */
    input, select, textarea {
      background: rgba(8, 15, 30, 0.85) !important;
      color: #cbd5e1 !important;
      border-color: rgba(51,65,85,0.7) !important;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    input::placeholder { color: #475569 !important; }
    input:focus, select:focus {
      border-color: rgba(59,130,246,0.5) !important;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.08) !important;
      outline: none !important;
    }
    select option { background: #0d1829; color: #cbd5e1; }

    /* Custom select arrow */
    select {
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") !important;
      background-repeat: no-repeat !important;
      background-position: right 10px center !important;
      padding-right: 30px !important;
    }

    /* ── Top import progress bar ─────────────────────────────────────── */
    #progress-bar {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 2px;
      z-index: 99999;
      transform-origin: left center;
      background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
      background-size: 200% 100%;
      animation: shimmer 1.8s linear infinite;
      transition: transform 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.5s;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* ── Glass card ──────────────────────────────────────────────────── */
    .card {
      background: rgba(10, 18, 35, 0.7);
      border: 1px solid rgba(51,65,85,0.4);
      border-radius: 16px;
      backdrop-filter: blur(16px);
    }

    /* ── Table ───────────────────────────────────────────────────────── */
    .tbl-wrap {
      max-height: calc(100vh - 310px);
      overflow-y: auto;
      overflow-x: auto;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #080f1d;
      z-index: 5;
      white-space: nowrap;
    }
    .tbl-row {
      border-bottom: 1px solid rgba(51,65,85,0.15);
      transition: background 0.12s;
      cursor: pointer;
      position: relative;
    }
    .tbl-row:hover { background: rgba(59,130,246,0.04); }
    .tbl-row:hover::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0; width: 2px;
      background: linear-gradient(180deg, #3b82f6, #8b5cf6);
    }

    /* ── Stat card hover ─────────────────────────────────────────────── */
    .stat-card { transition: transform 0.2s, box-shadow 0.2s; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0,0,0,0.4); }

    /* ── Animations ──────────────────────────────────────────────────── */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .fade-up { animation: fadeUp 0.22s ease both; }

    @keyframes slideRight {
      from { opacity: 0; transform: translateX(100%); }
      to   { opacity: 1; transform: translateX(0); }
    }
    .slide-right { animation: slideRight 0.22s cubic-bezier(0.16,1,0.3,1) both; }

    @keyframes toastPop {
      from { opacity: 0; transform: translateY(10px) scale(0.95); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }
    .toast-pop { animation: toastPop 0.18s ease both; }

    /* ── Filter pill toggle ──────────────────────────────────────────── */
    .pill-toggle {
      display: flex; align-items: center; gap: 8px;
      padding: 7px 12px; border-radius: 10px;
      border: 1px solid rgba(51,65,85,0.5);
      cursor: pointer; transition: all 0.15s;
      font-size: 12px; color: #64748b;
      background: rgba(8,15,30,0.6);
      user-select: none;
    }
    .pill-toggle:hover { border-color: rgba(71,85,105,0.7); color: #94a3b8; }
    .pill-toggle.active-blue { border-color: rgba(59,130,246,0.4); background: rgba(59,130,246,0.08); color: #93c5fd; }
    .pill-toggle.active-slate { border-color: rgba(100,116,139,0.4); background: rgba(100,116,139,0.1); color: #94a3b8; }

    .toggle-track {
      width: 28px; height: 16px; border-radius: 8px;
      transition: background 0.2s; flex-shrink: 0;
    }
    .toggle-thumb {
      width: 12px; height: 12px; border-radius: 50%; background: #fff;
      transition: transform 0.2s; position: absolute; top: 2px; left: 2px;
    }

    /* ── Pagination button ───────────────────────────────────────────── */
    .pg-btn {
      min-width: 28px; height: 28px; border-radius: 8px; font-size: 12px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s; border: 1px solid rgba(51,65,85,0.3);
      background: rgba(20,30,48,0.7); color: #64748b; cursor: pointer;
    }
    .pg-btn:hover:not(:disabled) { color: #cbd5e1; border-color: rgba(71,85,105,0.6); }
    .pg-btn.active {
      background: linear-gradient(135deg, #1d4ed8, #2563eb);
      border-color: rgba(37,99,235,0.5);
      color: #fff; font-weight: 600;
      box-shadow: 0 0 14px rgba(37,99,235,0.3);
    }
    .pg-btn:disabled { opacity: 0.25; cursor: not-allowed; }
  </style>
</head>

<body x-data="app()" x-init="init()" class="text-slate-300 antialiased">

  <!-- ── Top progress bar ──────────────────────────────────────────────── -->
  <div id="progress-bar" x-show="importProgress >= 0" x-cloak
    :style="`transform: scaleX(${importProgress / 100}); opacity: ${importProgress >= 100 ? 0 : 1}`"></div>

  <!-- ── Navbar ─────────────────────────────────────────────────────────── -->
  <header class="sticky top-0 z-40"
    style="background: rgba(6,13,26,0.88); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(51,65,85,0.25);">
    <div class="max-w-[1800px] mx-auto px-6 h-14 flex items-center gap-3">

      <!-- Logo -->
      <div class="flex items-center gap-2.5 mr-3 flex-shrink-0">
        <div class="w-8 h-8 rounded-lg flex items-center justify-center text-xs font-black text-slate-900"
          style="background: linear-gradient(135deg,#f59e0b,#ea580c); box-shadow: 0 0 18px rgba(245,158,11,0.35);">CS</div>
        <div class="hidden sm:block">
          <p class="text-sm font-bold text-white leading-tight tracking-tight">CS2 Inventory</p>
          <p class="text-[10px] text-slate-600 leading-tight">Portfolio Manager</p>
        </div>
      </div>

      <!-- Tabs -->
      <nav class="flex gap-0.5 p-1 rounded-xl" style="background: rgba(20,30,48,0.7); border: 1px solid rgba(51,65,85,0.3)">
        <button @click="activeTab='inventory'"
          class="px-3.5 py-1.5 rounded-lg text-xs font-medium transition-all duration-150"
          :class="activeTab==='inventory' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300'">
          持仓列表
        </button>
        <button @click="activeTab='overview'"
          class="px-3.5 py-1.5 rounded-lg text-xs font-medium transition-all duration-150"
          :class="activeTab==='overview' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300'">
          资产概览
        </button>
      </nav>

      <!-- Right side -->
      <div class="ml-auto flex items-center gap-3">
        <!-- Import status -->
        <div x-show="importing" x-cloak class="flex items-center gap-2 text-xs text-slate-500">
          <span class="w-1.5 h-1.5 rounded-full bg-blue-400 animate-pulse inline-block"></span>
          同步中，请耐心等待…
        </div>
        <span x-show="lastImportAt && !importing" x-cloak class="text-[11px] text-slate-700 hidden md:block">
          上次同步 <span class="text-slate-500" x-text="lastImportAt"></span>
        </span>

        <!-- Refresh Prices button -->
        <div class="flex items-center gap-2">
          <button @click="triggerRefreshPrices()" :disabled="refreshing"
            class="flex items-center gap-1.5 px-3 py-2 rounded-xl text-xs font-medium transition-all duration-150 disabled:opacity-40 disabled:cursor-not-allowed"
            style="background: rgba(16,185,129,0.12); border: 1px solid rgba(16,185,129,0.2); color:#6ee7b7"
            @mouseenter="if(!refreshing) $el.style.background='rgba(16,185,129,0.2)'"
            @mouseleave="$el.style.background='rgba(16,185,129,0.12)'">
            <svg class="w-3 h-3 flex-shrink-0" :class="refreshing?'animate-spin':''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span x-show="!refreshing">刷新市价</span>
            <span x-show="refreshing" x-cloak x-text="refreshProgress + '%'"></span>
          </button>
          <span x-show="overview.price_updated_at && !refreshing" x-cloak
            class="text-[10px] text-slate-700 hidden lg:block">
            市价 <span class="text-slate-600" x-text="overview.price_updated_at"></span>
          </span>
        </div>

        <!-- Import button -->
        <button @click="triggerImport()" :disabled="importing"
          class="flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium transition-all duration-150 disabled:opacity-40 disabled:cursor-not-allowed text-white"
          style="background: linear-gradient(135deg,#1d4ed8,#2563eb); box-shadow: 0 0 20px rgba(37,99,235,0.3);"
          @mouseenter="$el.style.boxShadow='0 0 28px rgba(37,99,235,0.5)'"
          @mouseleave="$el.style.boxShadow='0 0 20px rgba(37,99,235,0.3)'">
          <svg class="w-3.5 h-3.5 flex-shrink-0" :class="importing?'animate-spin':''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          <span x-text="importing ? '同步中…' : '同步数据'"></span>
        </button>
      </div>
    </div>
  </header>

  <!-- ── Main ───────────────────────────────────────────────────────────── -->
  <main class="max-w-[1800px] mx-auto px-6 py-6">

    <!-- ════════════ OVERVIEW TAB ════════════ -->
    <div x-show="activeTab==='overview'" class="fade-up">

      <!-- Stat cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-5">

        <!-- Total cost -->
        <div class="card stat-card p-5 relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 rounded-full pointer-events-none"
            style="background: radial-gradient(circle, rgba(59,130,246,0.08), transparent 70%)"></div>
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2">总持仓成本</p>
          <p class="text-3xl font-bold text-white mb-1">¥<span x-text="fmt(overview.total_cost)">—</span></p>
          <div class="flex gap-3 text-[11px] text-slate-700 mb-3">
            <span>出租 ¥<span x-text="fmt(overview.cost_breakdown?.rented_out)"></span></span>
            <span>·</span>
            <span>Steam ¥<span x-text="fmt(overview.cost_breakdown?.in_steam)"></span></span>
          </div>
          <div class="h-1 rounded-full overflow-hidden" style="background: rgba(51,65,85,0.4)">
            <div class="h-full rounded-full transition-all duration-1000"
              style="background: linear-gradient(90deg,#3b82f6,#8b5cf6)"
              :style="'width:' + (overview.coverage_pct||0) + '%'"></div>
          </div>
          <p class="text-[11px] text-slate-700 mt-1.5">定价覆盖
            <span class="text-blue-400 font-medium" x-text="(overview.coverage_pct||0) + '%'"></span>
          </p>
        </div>

        <!-- Active breakdown -->
        <div class="card stat-card p-5">
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2">活跃持仓</p>
          <p class="text-3xl font-bold text-white mb-3" x-text="overview.total_active ?? '—'"></p>
          <div class="space-y-1.5">
            <div class="flex justify-between items-center text-xs">
              <span class="text-slate-500 flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>出租中
              </span>
              <span class="font-mono font-semibold text-green-300" x-text="overview.status_breakdown?.rented_out ?? 0"></span>
            </div>
            <div class="flex justify-between items-center text-xs">
              <span class="text-slate-500 flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span>Steam中
              </span>
              <span class="font-mono font-semibold text-blue-300" x-text="overview.status_breakdown?.in_steam ?? 0"></span>
            </div>
            <div class="flex justify-between items-center text-xs">
              <span class="text-slate-500 flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-purple-400"></span>收藏
              </span>
              <span class="font-mono font-semibold text-purple-300" x-text="overview.status_breakdown?.in_storage ?? 0"></span>
            </div>
            <div class="flex justify-between items-center text-xs pt-1.5" style="border-top: 1px solid rgba(51,65,85,0.3)">
              <span class="text-slate-700">已售</span>
              <span class="font-mono text-slate-700" x-text="overview.status_breakdown?.sold ?? 0"></span>
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="card stat-card p-5">
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2">定价情况</p>
          <p class="text-3xl font-bold text-white mb-3" x-text="overview.priced_count ?? '—'"></p>
          <div class="space-y-1.5">
            <div class="flex justify-between items-center text-xs">
              <span class="text-slate-500">自动定价</span>
              <span class="font-mono text-slate-300" x-text="(overview.priced_count??0)-(overview.manual_price_count??0)"></span>
            </div>
            <div class="flex justify-between items-center text-xs">
              <span class="text-yellow-500/70">手动定价</span>
              <span class="font-mono text-yellow-300 font-semibold" x-text="overview.manual_price_count ?? 0"></span>
            </div>
            <div class="flex justify-between items-center text-xs pt-1.5" style="border-top: 1px solid rgba(51,65,85,0.3)">
              <span class="text-red-500/60">未定价</span>
              <span class="font-mono text-red-400" x-text="overview.unpriced_count ?? 0"></span>
            </div>
          </div>
        </div>

        <!-- Quick actions -->
        <div class="card stat-card p-5 flex flex-col gap-2">
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-1">快捷操作</p>
          <button @click="activeTab='inventory'; filters.status=''; showSold=false; filters.pricedFilter='unpriced'; page=1; loadItems()"
            class="w-full text-left px-3 py-2.5 rounded-xl text-xs transition-all duration-150"
            style="background: rgba(239,68,68,0.07); border: 1px solid rgba(239,68,68,0.15); color: #fca5a5;"
            @mouseenter="$el.style.background='rgba(239,68,68,0.13)'"
            @mouseleave="$el.style.background='rgba(239,68,68,0.07)'">
            → 未定价饰品 (<span x-text="overview.unpriced_count??0"></span>)
          </button>
          <button @click="activeTab='inventory'; filters.status='rented_out'; showSold=false; page=1; loadItems()"
            class="w-full text-left px-3 py-2.5 rounded-xl text-xs transition-all duration-150"
            style="background: rgba(34,197,94,0.07); border: 1px solid rgba(34,197,94,0.15); color: #86efac;"
            @mouseenter="$el.style.background='rgba(34,197,94,0.13)'"
            @mouseleave="$el.style.background='rgba(34,197,94,0.07)'">
            → 出租中 (<span x-text="overview.status_breakdown?.rented_out??0"></span>)
          </button>
          <button @click="activeTab='inventory'; filters.status=''; showSold=false; filters.pricedFilter=''; page=1; loadItems()"
            class="w-full text-left px-3 py-2.5 rounded-xl text-xs transition-all duration-150"
            style="background: rgba(71,85,105,0.15); border: 1px solid rgba(71,85,105,0.25); color: #94a3b8;"
            @mouseenter="$el.style.background='rgba(71,85,105,0.25)'"
            @mouseleave="$el.style.background='rgba(71,85,105,0.15)'">
            → 全部持仓
          </button>
        </div>
      </div>

      <!-- P&L row -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">

        <!-- Market Value -->
        <div class="card stat-card p-5 relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 rounded-full pointer-events-none"
            style="background: radial-gradient(circle, rgba(16,185,129,0.07), transparent 70%)"></div>
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2">当前市值</p>
          <template x-if="overview.market_value > 0">
            <div>
              <p class="text-3xl font-bold text-emerald-300 mb-1">¥<span x-text="fmt(overview.market_value)"></span></p>
              <p class="text-[11px] text-slate-700">
                覆盖 <span class="text-emerald-500/70" x-text="overview.market_priced_count ?? 0"></span> 件
                / 共 <span x-text="overview.total_active ?? 0"></span> 件
              </p>
            </div>
          </template>
          <template x-if="!overview.market_value">
            <div>
              <p class="text-2xl font-bold text-slate-700 mb-1">暂无市价</p>
              <p class="text-[11px] text-slate-700">点击「刷新市价」获取实时数据</p>
            </div>
          </template>
        </div>

        <!-- P&L -->
        <div class="card stat-card p-5 relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 rounded-full pointer-events-none"
            :style="overview.pnl > 0 ? 'background: radial-gradient(circle, rgba(16,185,129,0.07), transparent 70%)' : overview.pnl < 0 ? 'background: radial-gradient(circle, rgba(239,68,68,0.07), transparent 70%)' : ''"></div>
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2">盈亏金额</p>
          <template x-if="overview.pnl != null">
            <div>
              <p class="text-3xl font-bold mb-1"
                :class="overview.pnl >= 0 ? 'text-emerald-300' : 'text-red-400'">
                <span x-text="overview.pnl >= 0 ? '+¥' : '-¥'"></span><span x-text="fmt(Math.abs(overview.pnl))"></span>
              </p>
              <p class="text-[11px] text-slate-700">基于已有市价估算</p>
            </div>
          </template>
          <template x-if="overview.pnl == null">
            <div>
              <p class="text-2xl font-bold text-slate-700 mb-1">—</p>
              <p class="text-[11px] text-slate-700">需要成本价 + 市价数据</p>
            </div>
          </template>
        </div>

        <!-- P&L% -->
        <div class="card stat-card p-5 relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 rounded-full pointer-events-none"
            :style="overview.pnl_pct > 0 ? 'background: radial-gradient(circle, rgba(16,185,129,0.07), transparent 70%)' : overview.pnl_pct < 0 ? 'background: radial-gradient(circle, rgba(239,68,68,0.07), transparent 70%)' : ''"></div>
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2">盈亏率</p>
          <template x-if="overview.pnl_pct != null">
            <div>
              <p class="text-3xl font-bold mb-1"
                :class="overview.pnl_pct >= 0 ? 'text-emerald-300' : 'text-red-400'">
                <span x-text="(overview.pnl_pct >= 0 ? '+' : '') + overview.pnl_pct + '%'"></span>
              </p>
              <div class="flex items-center gap-2 mt-2">
                <div class="flex-1 h-1 rounded-full overflow-hidden" style="background: rgba(51,65,85,0.4)">
                  <div class="h-full rounded-full transition-all duration-1000"
                    :style="'width:' + Math.min(Math.abs(overview.pnl_pct ?? 0), 100) + '%; background:' + (overview.pnl_pct >= 0 ? 'linear-gradient(90deg,#10b981,#059669)' : 'linear-gradient(90deg,#ef4444,#dc2626)')"></div>
                </div>
              </div>
            </div>
          </template>
          <template x-if="overview.pnl_pct == null">
            <div>
              <p class="text-2xl font-bold text-slate-700 mb-1">—</p>
              <p class="text-[11px] text-slate-700">待市价刷新后计算</p>
            </div>
          </template>
        </div>
      </div>

      <!-- Distribution bar -->
      <div class="card p-5">
        <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-4">持仓状态分布</p>
        <div class="flex h-3 rounded-full overflow-hidden gap-0.5" x-show="overview.total_active > 0">
          <div class="rounded-sm transition-all duration-1000"
            style="background: linear-gradient(90deg,#22c55e,#16a34a)"
            :style="'width:'+pct(overview.status_breakdown?.rented_out,overview.total_active)+'%'"></div>
          <div class="rounded-sm transition-all duration-1000"
            style="background: linear-gradient(90deg,#3b82f6,#2563eb)"
            :style="'width:'+pct(overview.status_breakdown?.in_steam,overview.total_active)+'%'"></div>
          <div class="rounded-sm transition-all duration-1000"
            style="background: linear-gradient(90deg,#a855f7,#7c3aed)"
            :style="'width:'+pct(overview.status_breakdown?.in_storage,overview.total_active)+'%'"></div>
        </div>
        <div class="flex flex-wrap gap-x-6 gap-y-1 mt-3 text-xs text-slate-600">
          <span><span class="text-green-400">●</span> 出租中
            <span class="font-mono text-green-300 ml-1" x-text="overview.status_breakdown?.rented_out??0"></span>
            (<span x-text="pct(overview.status_breakdown?.rented_out,overview.total_active)+'%'"></span>)
          </span>
          <span><span class="text-blue-400">●</span> Steam中
            <span class="font-mono text-blue-300 ml-1" x-text="overview.status_breakdown?.in_steam??0"></span>
            (<span x-text="pct(overview.status_breakdown?.in_steam,overview.total_active)+'%'"></span>)
          </span>
          <span><span class="text-purple-400">●</span> 收藏
            <span class="font-mono text-purple-300 ml-1" x-text="overview.status_breakdown?.in_storage??0"></span>
            (<span x-text="pct(overview.status_breakdown?.in_storage,overview.total_active)+'%'"></span>)
          </span>
        </div>
      </div>
    </div>

    <!-- ════════════ INVENTORY TAB ════════════ -->
    <div x-show="activeTab==='inventory'">

      <!-- Mini strip -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
        <div class="card px-4 py-3">
          <p class="text-[11px] text-slate-600 mb-0.5">总成本</p>
          <p class="text-base font-bold text-white">¥<span x-text="fmt(overview.total_cost)">—</span></p>
        </div>
        <div class="card px-4 py-3">
          <p class="text-[11px] text-slate-600 mb-0.5">活跃持仓</p>
          <p class="text-base font-bold text-white" x-text="overview.total_active??'—'"></p>
        </div>
        <div class="card px-4 py-3">
          <p class="text-[11px] text-slate-600 mb-0.5">定价覆盖</p>
          <p class="text-base font-bold">
            <span class="text-white" x-text="overview.priced_count??'—'"></span>
            <span class="text-slate-700 text-sm"> / </span>
            <span class="text-slate-500 text-sm" x-text="overview.total_active??'—'"></span>
          </p>
        </div>
        <div class="card px-4 py-3">
          <p class="text-[11px] text-slate-600 mb-0.5">手动定价</p>
          <p class="text-base font-bold text-yellow-300" x-text="overview.manual_price_count??'—'"></p>
        </div>
      </div>

      <!-- Filter bar -->
      <div class="card px-4 py-3 mb-4">
        <div class="flex flex-wrap items-center gap-2">

          <!-- Search -->
          <div class="relative flex-1 min-w-[180px]">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 pointer-events-none"
              style="color:#475569" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input type="text" x-model="filters.search"
              @input.debounce.400ms="page=1; loadItems()"
              placeholder="搜索饰品名称…"
              class="w-full pl-9 pr-3 py-2 rounded-xl text-sm border" />
          </div>

          <!-- Status -->
          <select x-model="filters.status" @change="page=1; loadItems()"
            class="py-2 pl-3 rounded-xl text-sm border" style="min-width: 108px">
            <option value="">全部状态</option>
            <option value="rented_out">出租中</option>
            <option value="in_steam">Steam中</option>
            <option value="in_storage">收藏</option>
          </select>

          <!-- Priced filter -->
          <select x-model="filters.pricedFilter" @change="page=1; loadItems()"
            class="py-2 pl-3 rounded-xl text-sm border" style="min-width: 96px">
            <option value="">全部</option>
            <option value="priced">已定价</option>
            <option value="unpriced">未定价</option>
          </select>

          <!-- Show sold toggle -->
          <label class="pill-toggle" :class="showSold ? 'active-slate' : ''"
            @click="showSold=!showSold; page=1; loadItems()">
            <span>显示已售</span>
            <div class="relative toggle-track" :style="showSold ? 'background:#475569' : 'background:#1e293b'">
              <div class="toggle-thumb" :style="showSold ? 'transform:translateX(12px)' : ''"></div>
            </div>
          </label>

          <!-- Dual price toggle -->
          <label class="pill-toggle" :class="dualPrice ? 'active-blue' : ''"
            @click="dualPrice=!dualPrice">
            <span>双价对比</span>
            <div class="relative toggle-track" :style="dualPrice ? 'background:#1d4ed8' : 'background:#1e293b'">
              <div class="toggle-thumb" :style="dualPrice ? 'transform:translateX(12px)' : ''"></div>
            </div>
          </label>

          <!-- Cost sort shortcut -->
          <button @click="setSort('effective_price')"
            class="pill-toggle" :class="sortBy==='effective_price' ? 'active-blue' : ''">
            成本排序 <span x-text="sortBy==='effective_price'?(sortOrder==='desc'?'↓':'↑'):'↕'"></span>
          </button>

          <!-- Page size -->
          <select x-model.number="pageSize" @change="page=1; loadItems()"
            class="py-2 pl-3 rounded-xl text-sm border ml-auto" style="width: 70px">
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
          </select>
        </div>
      </div>

      <!-- Table -->
      <div class="card overflow-hidden">
        <div class="tbl-wrap">
          <table class="w-full text-xs" style="border-collapse: separate; border-spacing: 0;">
            <thead>
              <tr style="border-bottom: 1px solid rgba(51,65,85,0.3);">
                <th class="py-3 px-4 text-left font-normal text-slate-700 uppercase tracking-wider w-8">#</th>
                <th class="py-3 px-4 text-left font-normal text-slate-700 uppercase tracking-wider">饰品</th>
                <th class="py-3 px-3 text-left font-normal text-slate-700 uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" @click="setSort('status')">
                  状态 <span x-text="sortIcon('status')"></span>
                </th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" @click="setSort('abrade')">
                  磨损 <span x-text="sortIcon('abrade')"></span>
                </th>
                <template x-if="!dualPrice">
                  <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" @click="setSort('effective_price')">
                    成本价 <span x-text="sortIcon('effective_price')"></span>
                  </th>
                </template>
                <template x-if="dualPrice">
                  <th class="py-3 px-3 text-right font-normal uppercase tracking-wider" style="color:#475569">自动价</th>
                </template>
                <template x-if="dualPrice">
                  <th class="py-3 px-3 text-right font-normal uppercase tracking-wider" style="color:rgba(202,138,4,0.7)">手动价</th>
                </template>
                <th class="py-3 px-3 text-right font-normal uppercase tracking-wider" style="color:#047857">市价</th>
                <th class="py-3 px-3 text-right font-normal uppercase tracking-wider" style="color:#475569">盈亏</th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" @click="setSort('purchase_date')">
                  购入日期 <span x-text="sortIcon('purchase_date')"></span>
                </th>
                <th class="py-3 px-3 text-left font-normal text-slate-700 uppercase tracking-wider">平台</th>
                <th class="py-3 px-4 w-10"></th>
              </tr>
            </thead>
            <tbody>
              <!-- Loading -->
              <template x-if="loading">
                <tr>
                  <td :colspan="dualPrice ? 11 : 10" class="py-24 text-center" style="color:#334155">
                    <div class="flex flex-col items-center gap-3">
                      <div class="w-6 h-6 rounded-full border-2 border-t-blue-500 animate-spin" style="border-color: rgba(51,65,85,0.4); border-top-color: #3b82f6"></div>
                      <span class="text-xs">加载中…</span>
                    </div>
                  </td>
                </tr>
              </template>

              <!-- Empty -->
              <template x-if="!loading && items.length === 0">
                <tr>
                  <td :colspan="dualPrice ? 11 : 10" class="py-24 text-center text-xs" style="color:#334155">
                    没有找到匹配的饰品
                  </td>
                </tr>
              </template>

              <!-- Rows -->
              <template x-for="(item, idx) in items" :key="item.id">
                <tr class="tbl-row" @click="openPanel(item)">
                  <td class="py-2.5 px-4 font-mono" style="color:#334155" x-text="(page-1)*pageSize+idx+1"></td>

                  <!-- Item name + icon -->
                  <td class="py-2.5 px-4">
                    <div class="flex items-center gap-2.5">
                      <div class="w-9 h-9 rounded-lg overflow-hidden flex-shrink-0" style="background:rgba(20,30,48,0.8)">
                        <img :src="iconUrl(item.icon_url)" class="w-full h-full object-cover"
                          @error="$el.style.opacity='0'" loading="lazy" />
                      </div>
                      <div class="min-w-0">
                        <p class="text-slate-100 font-medium leading-tight truncate" style="max-width:260px" x-text="item.market_hash_name"></p>
                        <p class="leading-tight truncate mt-0.5" style="max-width:260px; color:#334155" x-text="item.name"></p>
                      </div>
                    </div>
                  </td>

                  <!-- Status badge -->
                  <td class="py-2.5 px-3">
                    <span class="px-2 py-0.5 rounded-full text-[11px] font-medium tracking-wide"
                      :class="statusCls(item.status)" x-text="statusLbl(item.status)"></span>
                  </td>

                  <!-- Abrade -->
                  <td class="py-2.5 px-3 text-right font-mono" style="color:#334155"
                    x-text="item.abrade!=null ? item.abrade.toFixed(6) : '—'"></td>

                  <!-- Single price -->
                  <template x-if="!dualPrice">
                    <td class="py-2.5 px-3 text-right">
                      <span x-show="item.effective_price!=null" class="font-semibold"
                        :class="item.purchase_price_manual!=null ? 'text-yellow-300' : 'text-slate-100'"
                        x-text="'¥'+fmt(item.effective_price)"></span>
                      <span x-show="item.effective_price==null" style="color:#1e293b">—</span>
                    </td>
                  </template>

                  <!-- Auto price (dual) -->
                  <template x-if="dualPrice">
                    <td class="py-2.5 px-3 text-right" style="color:#475569">
                      <span x-show="item.purchase_price!=null" x-text="'¥'+fmt(item.purchase_price)"></span>
                      <span x-show="item.purchase_price==null" style="color:#1e293b">—</span>
                    </td>
                  </template>

                  <!-- Manual price (dual) -->
                  <template x-if="dualPrice">
                    <td class="py-2.5 px-3 text-right">
                      <span x-show="item.purchase_price_manual!=null"
                        class="text-yellow-300 font-semibold"
                        x-text="'¥'+fmt(item.purchase_price_manual)"></span>
                      <span x-show="item.purchase_price_manual==null" style="color:#1e293b">—</span>
                    </td>
                  </template>

                  <!-- Current market price -->
                  <td class="py-2.5 px-3 text-right font-mono">
                    <span x-show="item.current_price != null"
                      class="text-emerald-400/80 text-xs"
                      x-text="'¥'+fmt(item.current_price)"></span>
                    <span x-show="item.current_price == null" style="color:#1e293b">—</span>
                  </td>

                  <!-- P&L -->
                  <td class="py-2.5 px-3 text-right font-mono">
                    <template x-if="item.pnl != null">
                      <div class="flex flex-col items-end leading-tight">
                        <span class="text-xs font-semibold"
                          :class="item.pnl >= 0 ? 'text-emerald-400' : 'text-red-400'"
                          x-text="(item.pnl >= 0 ? '+¥' : '-¥') + fmt(Math.abs(item.pnl))"></span>
                        <span class="text-[10px]"
                          :class="item.pnl_pct >= 0 ? 'text-emerald-600' : 'text-red-600'"
                          x-text="(item.pnl_pct >= 0 ? '+' : '') + item.pnl_pct + '%'"></span>
                      </div>
                    </template>
                    <template x-if="item.pnl == null">
                      <span style="color:#1e293b">—</span>
                    </template>
                  </td>

                  <!-- Date -->
                  <td class="py-2.5 px-3 text-right font-mono" style="color:#334155" x-text="item.purchase_date||'—'"></td>

                  <!-- Platform -->
                  <td class="py-2.5 px-3" style="color:#334155" x-text="item.purchase_platform||'—'"></td>

                  <!-- Edit btn -->
                  <td class="py-2.5 px-4 text-center">
                    <div class="w-6 h-6 rounded-md flex items-center justify-center transition-colors"
                      style="background: rgba(30,41,59,0.5); color:#334155"
                      @mouseenter="$el.style.color='#94a3b8'" @mouseleave="$el.style.color='#334155'">
                      <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                      </svg>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="px-5 py-3 flex items-center justify-between"
          style="border-top: 1px solid rgba(51,65,85,0.2)">
          <p class="text-xs" style="color:#334155">
            共 <span class="text-slate-400 font-medium" x-text="total"></span> 条 ·
            第 <span class="text-slate-500" x-text="page"></span> /
            <span class="text-slate-500" x-text="Math.max(1,Math.ceil(total/pageSize))"></span> 页
          </p>
          <div class="flex items-center gap-1">
            <button class="pg-btn" @click="gotoPage(page-1)" :disabled="page<=1">‹</button>
            <template x-for="(p,i) in pageNums" :key="i">
              <template x-if="p==='...'">
                <span class="text-xs px-1" style="color:#334155">…</span>
              </template>
              <template x-if="p!=='...'">
                <button class="pg-btn" :class="p===page?'active':''" @click="gotoPage(p)" x-text="p"></button>
              </template>
            </template>
            <button class="pg-btn" @click="gotoPage(page+1)" :disabled="page>=Math.ceil(total/pageSize)">›</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ── Detail Side Panel ─────────────────────────────────────────────── -->
  <template x-teleport="body">
    <div x-show="panel" x-cloak>
      <div class="fixed inset-0 backdrop-blur-sm"
        style="background:rgba(0,0,0,0.55); z-index:1000" @click="panel=null"></div>
      <div class="fixed top-0 right-0 h-full overflow-y-auto shadow-2xl slide-right"
        style="width:380px; background:#07101f; border-left:1px solid rgba(51,65,85,0.35); z-index:1001"
        x-show="panel">
        <div class="p-5 flex flex-col min-h-full">

          <!-- Header -->
          <div class="flex items-start gap-3 mb-4">
            <div class="flex-1 min-w-0">
              <h2 class="text-sm font-semibold text-white leading-snug" x-text="panel?.market_hash_name"></h2>
              <p class="text-xs mt-0.5" style="color:#475569" x-text="panel?.name"></p>
            </div>
            <button @click="panel=null"
              class="w-7 h-7 rounded-lg flex items-center justify-center transition-colors text-base leading-none flex-shrink-0"
              style="background:rgba(30,41,59,0.8); color:#475569"
              @mouseenter="$el.style.color='#e2e8f0'" @mouseleave="$el.style.color='#475569'">✕</button>
          </div>

          <!-- Image -->
          <div class="rounded-xl mb-4 flex items-center justify-center h-36 overflow-hidden"
            style="background:rgba(10,18,35,0.8); border:1px solid rgba(51,65,85,0.25)">
            <img :src="iconUrl(panel?.icon_url, 200)" class="max-h-full max-w-full object-contain"
              @error="$el.style.display='none'" x-show="panel?.icon_url" />
            <span x-show="!panel?.icon_url" class="text-xs" style="color:#1e293b">No image</span>
          </div>

          <!-- Info grid -->
          <div class="grid grid-cols-2 gap-2 mb-5">
            <template x-for="[label,val,wide,yellow] in panelFields()" :key="label">
              <div class="rounded-xl p-3" :class="wide ? 'col-span-2' : ''"
                style="background:rgba(10,18,35,0.7); border:1px solid rgba(51,65,85,0.25)">
                <p class="text-[11px] mb-1" style="color:#475569" x-text="label"></p>
                <p class="text-xs font-medium font-mono"
                  :class="yellow ? 'text-yellow-300' : 'text-slate-200'"
                  x-text="val || '—'"></p>
              </div>
            </template>
          </div>

          <!-- Manual price -->
          <div class="mt-auto pt-4" style="border-top:1px solid rgba(51,65,85,0.3)">
            <div class="flex items-center justify-between mb-1">
              <p class="text-sm font-medium text-slate-200">手动购入价</p>
              <span x-show="panel?.purchase_price_manual!=null"
                class="text-[11px] px-2 py-0.5 rounded-full font-medium"
                style="background:rgba(202,138,4,0.12); color:#fbbf24">已手动设置</span>
            </div>
            <p class="text-[11px] mb-3" style="color:#334155">优先于自动识别价，不被自动导入覆盖。</p>
            <div class="flex gap-2">
              <input type="number" x-model="manualInput" placeholder="金额（元）" step="0.01" min="0"
                @keydown.enter="saveManual()"
                class="flex-1 px-3 py-2 rounded-xl text-sm border" />
              <button @click="saveManual()" :disabled="saving"
                class="px-4 py-2 rounded-xl text-sm font-semibold text-slate-900 transition-all disabled:opacity-40"
                style="background:linear-gradient(135deg,#d97706,#b45309); box-shadow:0 0 12px rgba(217,119,6,0.2)">
                <span x-show="!saving">保存</span><span x-show="saving">…</span>
              </button>
            </div>
            <button x-show="panel?.purchase_price_manual!=null" @click="clearManual()"
              class="mt-2 text-[11px] transition-colors"
              style="color:rgba(239,68,68,0.5)"
              @mouseenter="$el.style.color='rgba(239,68,68,0.8)'"
              @mouseleave="$el.style.color='rgba(239,68,68,0.5)'">
              × 清除手动价格
            </button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- ── Import Result Modal ─────────────────────────────────────────────── -->
  <template x-teleport="body">
    <div x-show="importResult" x-cloak
      class="fixed inset-0 flex items-center justify-center backdrop-blur-sm"
      style="background:rgba(0,0,0,0.65); z-index:9999"
      @click.self="importResult=null; loadAll()"
      @keydown.escape.window="importResult=null; loadAll()">
      <div class="flex flex-col rounded-2xl shadow-2xl fade-up"
        style="background:#07101f; border:1px solid rgba(51,65,85,0.4); width:420px; max-width:95vw; max-height:80vh">
        <!-- Header -->
        <div class="flex items-center justify-between px-5 pt-5 pb-3 flex-shrink-0">
          <div class="flex items-center gap-2">
            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs"
              style="background:rgba(34,197,94,0.12); color:#22c55e">✓</div>
            <h3 class="text-sm font-semibold text-white">导入完成</h3>
          </div>
          <button @click="importResult=null; loadAll()"
            class="w-7 h-7 rounded-lg flex items-center justify-center text-base leading-none transition-colors"
            style="background:rgba(30,41,59,0.8); color:#475569"
            @mouseenter="$el.style.color='#e2e8f0'" @mouseleave="$el.style.color='#475569'">✕</button>
        </div>
        <!-- Scrollable content -->
        <div class="px-5 pb-3 overflow-y-auto flex-1 space-y-2">
          <template x-for="[sec,data] in Object.entries(importResult||{})" :key="sec">
            <div class="rounded-xl p-3.5" style="background:rgba(10,18,35,0.7); border:1px solid rgba(51,65,85,0.25)">
              <p class="text-xs font-semibold text-slate-300 mb-2.5" x-text="importLbl(sec)"></p>
              <template x-if="typeof data==='object' && data!==null">
                <div class="space-y-1.5">
                  <template x-for="[k,v] in importFields(data)" :key="k">
                    <div class="flex justify-between items-center">
                      <span class="text-[11px]" style="color:#475569" x-text="k"></span>
                      <span class="text-[11px] text-slate-200 font-mono font-medium" x-text="v"></span>
                    </div>
                  </template>
                </div>
              </template>
              <template x-if="typeof data!=='object' || data===null">
                <span class="text-[11px] text-slate-300 font-mono" x-text="data"></span>
              </template>
            </div>
          </template>
        </div>
        <!-- Sticky footer -->
        <div class="px-5 pb-5 pt-3 flex-shrink-0" style="border-top:1px solid rgba(51,65,85,0.25)">
          <button @click="importResult=null; loadAll()"
            class="w-full py-2.5 rounded-xl text-sm font-semibold text-white transition-all"
            style="background:linear-gradient(135deg,#1d4ed8,#2563eb); box-shadow:0 0 20px rgba(37,99,235,0.25)"
            @mouseenter="$el.style.boxShadow='0 0 28px rgba(37,99,235,0.4)'"
            @mouseleave="$el.style.boxShadow='0 0 20px rgba(37,99,235,0.25)'">
            刷新数据
          </button>
        </div>
      </div>
    </div>
  </template>

  <!-- ── Toast ──────────────────────────────────────────────────────────── -->
  <template x-teleport="body">
    <div x-show="toast.msg" x-cloak class="fixed bottom-6 right-6 toast-pop" style="z-index:9999">
      <div class="px-4 py-3 rounded-xl text-sm font-medium shadow-2xl"
        :style="toast.type==='success'
          ? 'background:rgba(21,128,61,0.95); color:#dcfce7; border:1px solid rgba(34,197,94,0.3)'
          : 'background:rgba(185,28,28,0.95); color:#fee2e2; border:1px solid rgba(239,68,68,0.3)'"
        x-text="toast.msg"></div>
    </div>
  </template>

  <script>
    function app() {
      return {
        activeTab: 'inventory',
        overview: {},
        items: [],
        total: 0,
        loading: false,

        page: 1,
        pageSize: 50,
        filters: { search: '', status: '', pricedFilter: '' },
        sortBy: 'first_seen_at',
        sortOrder: 'desc',
        dualPrice: false,
        showSold: false,

        panel: null,
        manualInput: '',
        saving: false,

        importing: false,
        importProgress: -1,
        _progressTimer: null,
        importResult: null,
        lastImportAt: '',

        refreshing: false,
        refreshProgress: 0,
        _refreshPollTimer: null,

        toast: { msg: '', type: 'success' },

        // ── Computed page numbers ──────────────────────────────────────
        get pageNums() {
          const total = Math.max(1, Math.ceil(this.total / this.pageSize));
          const cur = this.page;
          if (total <= 7) return Array.from({ length: total }, (_, i) => i + 1);
          if (cur <= 4) return [1, 2, 3, 4, 5, '...', total];
          if (cur >= total - 3) return [1, '...', total-4, total-3, total-2, total-1, total];
          return [1, '...', cur-1, cur, cur+1, '...', total];
        },

        // ── Init ──────────────────────────────────────────────────────
        async init() {
          await this.loadAll();
          // 如果服务器上已有刷新任务在跑，接续轮询
          const r = await fetch('/api/dashboard/refresh-prices/status');
          if (r.ok) {
            const s = await r.json();
            if (s.status === 'running') {
              this.refreshing = true;
              this.refreshProgress = s.progress;
              this._startRefreshPoll();
            }
          }
        },

        async loadAll() {
          await Promise.all([this.loadOverview(), this.loadItems()]);
        },

        async loadOverview() {
          try {
            const r = await fetch('/api/dashboard/overview');
            if (r.ok) this.overview = await r.json();
          } catch {}
        },

        async loadItems() {
          this.loading = true;
          try {
            const p = new URLSearchParams({
              page: this.page,
              page_size: this.pageSize,
              sort_by: this.sortBy,
              sort_order: this.sortOrder,
            });
            if (this.filters.search)        p.set('search', this.filters.search);
            if (this.filters.status)        p.set('status', this.filters.status);
            if (this.filters.pricedFilter)  p.set('priced_filter', this.filters.pricedFilter);
            if (!this.showSold)             p.set('exclude_sold', '1');
            const r = await fetch('/api/dashboard/items?' + p);
            if (r.ok) { const d = await r.json(); this.items = d.items; this.total = d.total; }
          } catch {}
          finally { this.loading = false; }
        },

        // ── Pagination ────────────────────────────────────────────────
        gotoPage(p) {
          const max = Math.ceil(this.total / this.pageSize);
          if (p < 1 || p > max) return;
          this.page = p;
          this.loadItems();
          document.querySelector('.tbl-wrap')?.scrollTo({ top: 0, behavior: 'smooth' });
        },

        // ── Sort ──────────────────────────────────────────────────────
        setSort(col) {
          if (this.sortBy === col) this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
          else { this.sortBy = col; this.sortOrder = 'desc'; }
          this.page = 1;
          this.loadItems();
        },
        sortIcon(col) {
          if (this.sortBy !== col) return '↕';
          return this.sortOrder === 'asc' ? '↑' : '↓';
        },

        // ── Detail panel ──────────────────────────────────────────────
        openPanel(item) {
          this.panel = { ...item };
          this.manualInput = item.purchase_price_manual != null ? item.purchase_price_manual : '';
        },

        panelFields() {
          if (!this.panel) return [];
          const p = this.panel;
          const eff = p.effective_price != null ? '¥' + this.fmt(p.effective_price) : null;
          const auto = p.purchase_price != null ? '¥' + this.fmt(p.purchase_price) : null;
          const date = p.first_seen_at ? new Date(p.first_seen_at).toLocaleString('zh-CN') : null;
          return [
            ['状态',       this.statusLbl(p.status),  false, false],
            ['来源',       p.class_id,                 false, false],
            ['磨损值',     p.abrade?.toFixed(10),      true,  false],
            ['购入日期',   p.purchase_date,            false, false],
            ['购入平台',   p.purchase_platform,        false, false],
            ['自动识别价', auto,                        false, false],
            ['生效价格',   eff, false, p.purchase_price_manual != null],
            ['首次发现',   date,                        true,  false],
          ];
        },

        async saveManual() {
          if (!this.panel) return;
          this.saving = true;
          try {
            const price = this.manualInput !== '' && this.manualInput !== null
              ? parseFloat(this.manualInput) : null;
            const r = await fetch(`/api/dashboard/items/${this.panel.id}/manual-price`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ price }),
            });
            if (!r.ok) throw new Error();
            const upd = await r.json();
            this.panel.purchase_price_manual = upd.purchase_price_manual;
            this.panel.effective_price = upd.effective_price;
            const row = this.items.find(i => i.id === this.panel.id);
            if (row) { row.purchase_price_manual = upd.purchase_price_manual; row.effective_price = upd.effective_price; }
            this.showToast('保存成功 ✓');
            await this.loadOverview();
          } catch { this.showToast('保存失败', 'error'); }
          finally { this.saving = false; }
        },

        async clearManual() {
          this.manualInput = '';
          await this.saveManual();
        },

        // ── Price Refresh ──────────────────────────────────────────────
        async triggerRefreshPrices() {
          if (this.refreshing) return;
          this.refreshing = true;
          this.refreshProgress = 0;
          try {
            const r = await fetch('/api/dashboard/refresh-prices', { method: 'POST' });
            if (!r.ok) throw new Error(await r.text());
            const d = await r.json();
            if (!d.started && d.state?.status !== 'running') {
              this.showToast('启动失败', 'error');
              this.refreshing = false;
              return;
            }
            this._startRefreshPoll();
          } catch (e) {
            this.refreshing = false;
            this.showToast('刷新启动失败：' + e.message, 'error');
          }
        },

        _startRefreshPoll() {
          clearInterval(this._refreshPollTimer);
          this._refreshPollTimer = setInterval(async () => {
            try {
              const r = await fetch('/api/dashboard/refresh-prices/status');
              if (!r.ok) return;
              const s = await r.json();
              this.refreshProgress = s.progress;
              if (s.status === 'done' || s.status === 'error') {
                clearInterval(this._refreshPollTimer);
                this.refreshing = false;
                if (s.status === 'done') {
                  this.showToast('市价刷新完成 ✓');
                  await this.loadAll();
                } else {
                  this.showToast('市价刷新失败：' + (s.error || '未知错误'), 'error');
                }
              }
            } catch {}
          }, 2500);
        },

        // ── Import ────────────────────────────────────────────────────
        async triggerImport() {
          this.importing = true;
          this.importProgress = 0;
          let elapsed = 0;
          // Asymptotic curve: approaches 80% over ~5 minutes
          this._progressTimer = setInterval(() => {
            elapsed += 300;
            this.importProgress = 80 * (1 - Math.exp(-elapsed / 250000));
          }, 300);

          try {
            const ctrl = new AbortController();
            const timer = setTimeout(() => ctrl.abort(), 12 * 60 * 1000);
            const r = await fetch('/api/youpin/import/all', { method: 'POST', signal: ctrl.signal });
            clearTimeout(timer);
            if (!r.ok) throw new Error(await r.text());
            clearInterval(this._progressTimer);
            this.importProgress = 100;
            setTimeout(() => { this.importProgress = -1; }, 700);
            const d = await r.json();
            this.importResult = d;
            this.lastImportAt = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
          } catch (e) {
            clearInterval(this._progressTimer);
            this.importProgress = -1;
            this.showToast(e.name === 'AbortError' ? '导入超时，请稍后刷新' : '导入失败：' + e.message, 'error');
          } finally {
            this.importing = false;
          }
        },

        // ── Helpers ───────────────────────────────────────────────────
        fmt(n) {
          if (n == null) return '—';
          return Number(n).toLocaleString('zh-CN', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        },
        pct(part, total) {
          if (!total || part == null) return 0;
          return Math.round(part / total * 100);
        },
        iconUrl(url, size = 62) {
          if (!url) return '';
          return `https://community.fastly.steamstatic.com/economy/image/${url}/${size}fx${size}f`;
        },
        statusLbl(s) {
          return { in_steam: 'Steam中', rented_out: '出租中', in_storage: '收藏', sold: '已售' }[s] || s || '—';
        },
        statusCls(s) {
          return {
            in_steam:   'bg-blue-500/10 text-blue-400',
            rented_out: 'bg-green-500/10 text-green-400',
            in_storage: 'bg-purple-500/10 text-purple-400',
            sold:       'bg-slate-800 text-slate-600',
          }[s] || 'bg-slate-800 text-slate-600';
        },
        importLbl(k) {
          return { stock:'库存 (STEAM_PROTECTED)', lease:'租赁 (rented_out)', buy:'购买记录匹配', sell:'出售记录标记' }[k] || k;
        },
        importFields(data) {
          const lm = {
            total_fetched:'拉取条数', upserted:'写入/更新', skipped:'跳过',
            total_records:'拉取条数', updated:'匹配更新', not_found_in_db:'未在库存',
            stats:'租赁统计', valuation:'悠悠估值',
          };
          return Object.entries(data)
            .filter(([k]) => !['items','not_found_names'].includes(k))
            .map(([k,v]) => [lm[k]||k, v]);
        },
        showToast(msg, type = 'success') {
          this.toast = { msg, type };
          setTimeout(() => { this.toast = { msg:'', type:'success' }; }, 3000);
        },
      };
    }
  </script>
</body>
</html>
