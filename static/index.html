<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CS2 Inventory Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    /* â”€â”€ Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    html { color-scheme: dark; scroll-behavior: smooth; }
    [x-cloak] { display: none !important; }
    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      background: #060d1a;
      background-image:
        radial-gradient(ellipse 70% 40% at 15% 5%, rgba(59,130,246,0.07) 0%, transparent 60%),
        radial-gradient(ellipse 50% 35% at 88% 90%, rgba(139,92,246,0.06) 0%, transparent 60%),
        radial-gradient(ellipse 30% 25% at 50% 50%, rgba(16,185,129,0.02) 0%, transparent 70%);
      min-height: 100vh;
    }

    /* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(71,85,105,0.5); border-radius: 2px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(100,116,139,0.7); }

    /* â”€â”€ Form controls â€” force dark everywhere â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    input, select, textarea {
      background: rgba(8, 15, 30, 0.85) !important;
      color: #cbd5e1 !important;
      border-color: rgba(51,65,85,0.7) !important;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    input::placeholder { color: #475569 !important; }
    input:focus, select:focus {
      border-color: rgba(59,130,246,0.5) !important;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.08) !important;
      outline: none !important;
    }
    select option { background: #0d1829; color: #cbd5e1; }

    /* Custom select arrow */
    select {
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") !important;
      background-repeat: no-repeat !important;
      background-position: right 10px center !important;
      padding-right: 30px !important;
    }

    /* â”€â”€ Top import progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #progress-bar {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 2px;
      z-index: 99999;
      transform-origin: left center;
      background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
      background-size: 200% 100%;
      animation: shimmer 1.8s linear infinite;
      transition: transform 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.5s;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* â”€â”€ Glass card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: rgba(10, 18, 35, 0.7);
      border: 1px solid rgba(51,65,85,0.4);
      border-radius: 16px;
      backdrop-filter: blur(16px);
    }

    /* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tbl-wrap {
      max-height: calc(100vh - 310px);
      overflow-y: auto;
      overflow-x: auto;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #080f1d;
      z-index: 5;
      white-space: nowrap;
    }
    .tbl-row {
      border-bottom: 1px solid rgba(51,65,85,0.15);
      transition: background 0.15s, box-shadow 0.15s;
      cursor: pointer;
    }
    .tbl-row:hover {
      background: rgba(59,130,246,0.07);
      box-shadow: inset 3px 0 0 rgba(99,102,241,0.55), 0 1px 10px rgba(0,0,0,0.22);
    }

    /* â”€â”€ Stat card hover â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stat-card { transition: transform 0.2s, box-shadow 0.2s; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0,0,0,0.4); }

    /* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .fade-up { animation: fadeUp 0.22s ease both; }

    @keyframes slideRight {
      from { opacity: 0; transform: translateX(100%); }
      to   { opacity: 1; transform: translateX(0); }
    }
    .slide-right { animation: slideRight 0.22s cubic-bezier(0.16,1,0.3,1) both; }

    @keyframes toastPop {
      from { opacity: 0; transform: translateY(10px) scale(0.95); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }
    .toast-pop { animation: toastPop 0.18s ease both; }

    /* â”€â”€ Filter pill toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pill-toggle {
      display: flex; align-items: center; gap: 8px;
      padding: 7px 12px; border-radius: 10px;
      border: 1px solid rgba(51,65,85,0.5);
      cursor: pointer; transition: all 0.15s;
      font-size: 12px; color: #64748b;
      background: rgba(8,15,30,0.6);
      user-select: none;
    }
    .pill-toggle:hover { border-color: rgba(71,85,105,0.7); color: #94a3b8; }
    .pill-toggle.active-blue { border-color: rgba(59,130,246,0.4); background: rgba(59,130,246,0.08); color: #93c5fd; }
    .pill-toggle.active-slate { border-color: rgba(100,116,139,0.4); background: rgba(100,116,139,0.1); color: #94a3b8; }

    .toggle-track {
      width: 28px; height: 16px; border-radius: 8px;
      transition: background 0.2s; flex-shrink: 0;
    }
    .toggle-thumb {
      width: 12px; height: 12px; border-radius: 50%; background: #fff;
      transition: transform 0.2s; position: absolute; top: 2px; left: 2px;
    }

    /* â”€â”€ Pagination button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pg-btn {
      min-width: 28px; height: 28px; border-radius: 8px; font-size: 12px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s; border: 1px solid rgba(51,65,85,0.3);
      background: rgba(20,30,48,0.7); color: #64748b; cursor: pointer;
    }
    .pg-btn:hover:not(:disabled) { color: #cbd5e1; border-color: rgba(71,85,105,0.6); }
    .pg-btn.active {
      background: linear-gradient(135deg, #1d4ed8, #2563eb);
      border-color: rgba(37,99,235,0.5);
      color: #fff; font-weight: 600;
      box-shadow: 0 0 14px rgba(37,99,235,0.3);
    }
    .pg-btn:disabled { opacity: 0.25; cursor: not-allowed; }
  </style>
</head>

<body x-data="app()" x-init="init()" class="text-slate-300 antialiased">

  <!-- â”€â”€ Top progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="progress-bar" x-show="importProgress >= 0" x-cloak
    :style="`transform: scaleX(${importProgress / 100}); opacity: ${importProgress >= 100 ? 0 : 1}`"></div>

  <!-- â”€â”€ Navbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header class="sticky top-0 z-40"
    style="background: rgba(6,13,26,0.88); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(51,65,85,0.25);">
    <div class="max-w-[1800px] mx-auto px-6 h-14 flex items-center gap-3">

      <!-- Logo -->
      <div class="flex items-center gap-2.5 mr-3 flex-shrink-0">
        <div class="w-8 h-8 rounded-lg flex items-center justify-center text-xs font-black text-slate-900"
          style="background: linear-gradient(135deg,#f59e0b,#ea580c); box-shadow: 0 0 18px rgba(245,158,11,0.35);">CS</div>
        <div class="hidden sm:block">
          <p class="text-sm font-bold text-white leading-tight tracking-tight">CS2 Inventory</p>
          <p class="text-[10px] text-slate-600 leading-tight">Portfolio Manager</p>
        </div>
      </div>

      <!-- Tabs -->
      <nav class="flex gap-0.5 p-1 rounded-xl" style="background: rgba(20,30,48,0.7); border: 1px solid rgba(51,65,85,0.3)">
        <button @click="activeTab='inventory'"
          class="px-3.5 py-1.5 rounded-lg text-xs font-medium transition-all duration-150"
          :class="activeTab==='inventory' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300'">
          æŒä»“åˆ—è¡¨
        </button>
        <button @click="activeTab='overview'"
          class="px-3.5 py-1.5 rounded-lg text-xs font-medium transition-all duration-150"
          :class="activeTab==='overview' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300'">
          èµ„äº§æ¦‚è§ˆ
        </button>
        <button @click="activeTab='listing'; loadShelf()"
          class="px-3.5 py-1.5 rounded-lg text-xs font-medium transition-all duration-150"
          :class="activeTab==='listing' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300'">
          ä¸Šæ¶ç®¡ç†
        </button>
      </nav>

      <!-- Right side -->
      <div class="ml-auto flex items-center gap-3">
        <!-- Import status -->
        <div x-show="importing" x-cloak class="flex items-center gap-2 text-xs text-slate-500">
          <span class="w-1.5 h-1.5 rounded-full bg-blue-400 animate-pulse inline-block"></span>
          åŒæ­¥ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…â€¦
        </div>
        <span x-show="lastImportAt && !importing" x-cloak class="text-[11px] text-slate-700 hidden md:block">
          ä¸Šæ¬¡åŒæ­¥ <span class="text-slate-500" x-text="lastImportAt"></span>
        </span>

        <!-- Refresh Prices button -->
        <div class="flex items-center gap-2">
          <button @click="triggerRefreshPrices()" :disabled="refreshing"
            class="flex items-center gap-1.5 px-3 py-2 rounded-xl text-xs font-medium transition-all duration-150 disabled:opacity-40 disabled:cursor-not-allowed"
            style="background: rgba(16,185,129,0.12); border: 1px solid rgba(16,185,129,0.2); color:#6ee7b7"
            @mouseenter="if(!refreshing) $el.style.background='rgba(16,185,129,0.2)'"
            @mouseleave="$el.style.background='rgba(16,185,129,0.12)'">
            <svg class="w-3 h-3 flex-shrink-0" :class="refreshing?'animate-spin':''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span x-show="!refreshing">åˆ·æ–°å¸‚ä»·</span>
            <span x-show="refreshing" x-cloak x-text="refreshProgress + '%'"></span>
          </button>
          <span x-show="overview.price_updated_at && !refreshing" x-cloak
            class="text-[10px] text-slate-700 hidden lg:block">
            å¸‚ä»· <span class="text-slate-600" x-text="overview.price_updated_at"></span>
          </span>
        </div>

        <!-- æ¶¨è·Œé¢œè‰² toggle -->
        <button @click="colorMode = colorMode==='cn' ? 'us' : 'cn'"
          class="flex items-center gap-1.5 px-3 py-2 rounded-xl text-xs font-medium transition-all"
          style="background:rgba(51,65,85,0.3); border:1px solid rgba(51,65,85,0.4); color:#94a3b8"
          :title="colorMode==='cn' ? 'å½“å‰ï¼šçº¢æ¶¨ç»¿è·Œï¼ˆAè‚¡æ¨¡å¼ï¼‰ï¼Œç‚¹å‡»åˆ‡æ¢' : 'å½“å‰ï¼šç»¿æ¶¨çº¢è·Œï¼ˆç¾è‚¡æ¨¡å¼ï¼‰ï¼Œç‚¹å‡»åˆ‡æ¢'">
          <span x-text="colorMode==='cn' ? 'ğŸ”´æ¶¨' : 'ğŸŸ¢æ¶¨'"></span>
          <span class="text-slate-600">/</span>
          <span x-text="colorMode==='cn' ? 'ğŸŸ¢è·Œ' : 'ğŸ”´è·Œ'"></span>
        </button>

        <!-- Import button -->
        <button @click="triggerImport()" :disabled="importing"
          class="flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium transition-all duration-150 disabled:opacity-40 disabled:cursor-not-allowed text-white"
          style="background: linear-gradient(135deg,#1d4ed8,#2563eb); box-shadow: 0 0 20px rgba(37,99,235,0.3);"
          @mouseenter="$el.style.boxShadow='0 0 28px rgba(37,99,235,0.5)'"
          @mouseleave="$el.style.boxShadow='0 0 20px rgba(37,99,235,0.3)'">
          <svg class="w-3.5 h-3.5 flex-shrink-0" :class="importing?'animate-spin':''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          <span x-text="importing ? 'åŒæ­¥ä¸­â€¦' : 'åŒæ­¥æ•°æ®'"></span>
        </button>
      </div>
    </div>
  </header>

  <!-- â”€â”€ æ”¹ä»·æ¨¡æ€æ¡† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <template x-teleport="body">
    <div x-show="repriceModal.show" x-cloak
      class="fixed inset-0 z-50 flex items-center justify-center p-4"
      style="background:rgba(0,0,0,0.6); backdrop-filter:blur(4px)"
      @keydown.escape.window="repriceModal.show=false">
      <div class="w-full max-w-sm rounded-2xl p-6" style="background:#0f172a; border:1px solid rgba(51,65,85,0.5)">
        <p class="text-slate-300 font-medium mb-1 truncate" x-text="repriceModal.item?.commodityHashName || repriceModal.item?.name || 'æ”¹ä»·'"></p>
        <p class="text-[11px] text-slate-600 mb-4">CommodityId: <span x-text="repriceModal.item?.commodityId"></span></p>

        <!-- Sell price -->
        <template x-if="shelfTab==='sell'">
          <div class="mb-4">
            <label class="block text-[11px] text-slate-600 mb-1">å‡ºå”®ä»·ï¼ˆå…ƒï¼‰</label>
            <input x-model.number="repriceModal.newPrice" type="number" step="0.01" min="0.01"
              class="w-full px-3 py-2 rounded-xl text-sm border" placeholder="0.01"/>
          </div>
        </template>

        <!-- Lease prices -->
        <template x-if="shelfTab==='lease'">
          <div class="space-y-3 mb-4">
            <div>
              <label class="block text-[11px] text-slate-600 mb-1">æ—¥ç§Ÿé‡‘ï¼ˆå…ƒ/å¤©ï¼‰</label>
              <input x-model.number="repriceModal.newLeaseUnit" type="number" step="0.01" min="0.01"
                class="w-full px-3 py-2 rounded-xl text-sm border" placeholder="0.01"/>
            </div>
            <div>
              <label class="block text-[11px] text-slate-600 mb-1">æŠ¼é‡‘ï¼ˆå…ƒï¼‰</label>
              <input x-model.number="repriceModal.newDeposit" type="number" step="0.01" min="0"
                class="w-full px-3 py-2 rounded-xl text-sm border" placeholder="0"/>
            </div>
          </div>
        </template>

        <div class="flex gap-3">
          <button @click="repriceModal.show=false"
            class="flex-1 py-2 rounded-xl text-sm transition-all"
            style="background:rgba(51,65,85,0.3); color:#94a3b8">å–æ¶ˆ</button>
          <button @click="saveReprice()" :disabled="repriceModal.saving"
            class="flex-1 py-2 rounded-xl text-sm font-medium text-white transition-all disabled:opacity-40"
            style="background:linear-gradient(135deg,#6366f1,#4f46e5)">
            <span x-show="!repriceModal.saving">ç¡®è®¤æ”¹ä»·</span>
            <span x-show="repriceModal.saving" x-cloak>ä¿å­˜ä¸­â€¦</span>
          </button>
        </div>
      </div>
    </div>
  </template>

  <!-- â”€â”€ Token è¿‡æœŸè­¦å‘Šæ¨ªå¹… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <template x-teleport="body">
    <div x-show="tokenExpired" x-cloak
      class="fixed top-14 left-0 right-0 z-30 flex items-center justify-between px-6 py-2.5 text-sm"
      style="background: rgba(185,28,28,0.95); border-bottom: 1px solid rgba(239,68,68,0.4);">
      <div class="flex items-center gap-2.5">
        <svg class="w-4 h-4 text-red-300 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <span class="text-red-100 font-medium">æ‚ æ‚ æœ‰å“ Token å·²è¿‡æœŸï¼Œæ‰€æœ‰åŒæ­¥/ä¸Šæ¶åŠŸèƒ½ä¸å¯ç”¨</span>
        <span class="text-red-300 text-xs">â†’ ç™»å½• www.youpin898.com â†’ DevTools â†’ Network â†’ å¤åˆ¶ Authorization header ä¸­çš„ Bearer Token â†’ æ›´æ–° .env é‡å¯æœåŠ¡</span>
      </div>
      <button @click="tokenExpired=false" class="text-red-300 hover:text-white text-lg leading-none ml-4">âœ•</button>
    </div>
  </template>

  <!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main class="max-w-[1800px] mx-auto px-6 py-6" :class="tokenExpired ? 'pt-14' : ''"  >

    <!-- â•â•â•â•â•â•â•â•â•â•â•â• OVERVIEW TAB â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div x-show="activeTab==='overview'" class="fade-up">

      <!-- Stat cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-5">

        <!-- Total cost -->
        <div class="card stat-card p-5 relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 rounded-full pointer-events-none"
            style="background: radial-gradient(circle, rgba(59,130,246,0.08), transparent 70%)"></div>
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2">æ€»æŒä»“æˆæœ¬</p>
          <p class="text-3xl font-bold text-white mb-1">Â¥<span x-text="fmt(overview.total_cost)">â€”</span></p>
          <div class="flex gap-3 text-[11px] text-slate-700 mb-3">
            <span>å‡ºç§Ÿ Â¥<span x-text="fmt(overview.cost_breakdown?.rented_out)"></span></span>
            <span>Â·</span>
            <span>Steam Â¥<span x-text="fmt(overview.cost_breakdown?.in_steam)"></span></span>
          </div>
          <div class="h-1 rounded-full overflow-hidden" style="background: rgba(51,65,85,0.4)">
            <div class="h-full rounded-full transition-all duration-1000"
              style="background: linear-gradient(90deg,#3b82f6,#8b5cf6)"
              :style="'width:' + (overview.coverage_pct||0) + '%'"></div>
          </div>
          <p class="text-[11px] text-slate-700 mt-1.5">å®šä»·è¦†ç›–
            <span class="text-blue-400 font-medium" x-text="(overview.coverage_pct||0) + '%'"></span>
          </p>
        </div>

        <!-- Active breakdown -->
        <div class="card stat-card p-5">
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2">æ´»è·ƒæŒä»“</p>
          <p class="text-3xl font-bold text-white mb-3" x-text="overview.total_active ?? 'â€”'"></p>
          <div class="space-y-1.5">
            <div class="flex justify-between items-center text-xs">
              <span class="text-slate-500 flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>å‡ºç§Ÿä¸­
              </span>
              <span class="font-mono font-semibold text-green-300" x-text="overview.status_breakdown?.rented_out ?? 0"></span>
            </div>
            <div class="flex justify-between items-center text-xs">
              <span class="text-slate-500 flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span>Steamä¸­
              </span>
              <span class="font-mono font-semibold text-blue-300" x-text="overview.status_breakdown?.in_steam ?? 0"></span>
            </div>
            <div class="flex justify-between items-center text-xs">
              <span class="text-slate-500 flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-purple-400"></span>æ”¶è—
              </span>
              <span class="font-mono font-semibold text-purple-300" x-text="overview.status_breakdown?.in_storage ?? 0"></span>
            </div>
            <div class="flex justify-between items-center text-xs pt-1.5" style="border-top: 1px solid rgba(51,65,85,0.3)">
              <span class="text-slate-700">å·²å”®</span>
              <span class="font-mono text-slate-700" x-text="overview.status_breakdown?.sold ?? 0"></span>
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="card stat-card p-5">
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2">å®šä»·æƒ…å†µ</p>
          <p class="text-3xl font-bold text-white mb-3" x-text="overview.priced_count ?? 'â€”'"></p>
          <div class="space-y-1.5">
            <div class="flex justify-between items-center text-xs">
              <span class="text-slate-500">è‡ªåŠ¨å®šä»·</span>
              <span class="font-mono text-slate-300" x-text="(overview.priced_count??0)-(overview.manual_price_count??0)"></span>
            </div>
            <div class="flex justify-between items-center text-xs">
              <span class="text-yellow-500/70">æ‰‹åŠ¨å®šä»·</span>
              <span class="font-mono text-yellow-300 font-semibold" x-text="overview.manual_price_count ?? 0"></span>
            </div>
            <div class="flex justify-between items-center text-xs pt-1.5" style="border-top: 1px solid rgba(51,65,85,0.3)">
              <span class="text-red-500/60">æœªå®šä»·</span>
              <span class="font-mono text-red-400" x-text="overview.unpriced_count ?? 0"></span>
            </div>
          </div>
        </div>

        <!-- Quick actions -->
        <div class="card stat-card p-5 flex flex-col gap-2">
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-1">å¿«æ·æ“ä½œ</p>
          <button @click="activeTab='inventory'; filters.status=''; showSold=false; filters.pricedFilter='unpriced'; page=1; loadItems()"
            class="w-full text-left px-3 py-2.5 rounded-xl text-xs transition-all duration-150"
            style="background: rgba(239,68,68,0.07); border: 1px solid rgba(239,68,68,0.15); color: #fca5a5;"
            @mouseenter="$el.style.background='rgba(239,68,68,0.13)'"
            @mouseleave="$el.style.background='rgba(239,68,68,0.07)'">
            â†’ æœªå®šä»·é¥°å“ (<span x-text="overview.unpriced_count??0"></span>)
          </button>
          <button @click="activeTab='inventory'; filters.status='rented_out'; showSold=false; page=1; loadItems()"
            class="w-full text-left px-3 py-2.5 rounded-xl text-xs transition-all duration-150"
            style="background: rgba(34,197,94,0.07); border: 1px solid rgba(34,197,94,0.15); color: #86efac;"
            @mouseenter="$el.style.background='rgba(34,197,94,0.13)'"
            @mouseleave="$el.style.background='rgba(34,197,94,0.07)'">
            â†’ å‡ºç§Ÿä¸­ (<span x-text="overview.status_breakdown?.rented_out??0"></span>)
          </button>
          <button @click="activeTab='inventory'; filters.status=''; showSold=false; filters.pricedFilter=''; page=1; loadItems()"
            class="w-full text-left px-3 py-2.5 rounded-xl text-xs transition-all duration-150"
            style="background: rgba(71,85,105,0.15); border: 1px solid rgba(71,85,105,0.25); color: #94a3b8;"
            @mouseenter="$el.style.background='rgba(71,85,105,0.25)'"
            @mouseleave="$el.style.background='rgba(71,85,105,0.15)'">
            â†’ å…¨éƒ¨æŒä»“
          </button>
        </div>
      </div>

      <!-- P&L row -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">

        <!-- Market Value -->
        <div class="card stat-card p-5 relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 rounded-full pointer-events-none"
            style="background: radial-gradient(circle, rgba(16,185,129,0.07), transparent 70%)"></div>
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2">å½“å‰å¸‚å€¼</p>
          <template x-if="overview.market_value > 0">
            <div>
              <p class="text-3xl font-bold text-emerald-300 mb-1">Â¥<span x-text="fmt(overview.market_value)"></span></p>
              <p class="text-[11px] text-slate-700">
                è¦†ç›– <span class="text-emerald-500/70" x-text="overview.market_priced_count ?? 0"></span> ä»¶
                / å…± <span x-text="overview.total_active ?? 0"></span> ä»¶
              </p>
            </div>
          </template>
          <template x-if="!overview.market_value">
            <div>
              <p class="text-2xl font-bold text-slate-700 mb-1">æš‚æ— å¸‚ä»·</p>
              <p class="text-[11px] text-slate-700">ç‚¹å‡»ã€Œåˆ·æ–°å¸‚ä»·ã€è·å–å®æ—¶æ•°æ®</p>
            </div>
          </template>
        </div>

        <!-- P&L -->
        <div class="card stat-card p-5 relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 rounded-full pointer-events-none"
            :style="overview.pnl != null ? 'background: radial-gradient(circle, ' + pnlBg(overview.pnl) + ', transparent 70%)' : ''"></div>
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2">ç›ˆäºé‡‘é¢</p>
          <template x-if="overview.pnl != null">
            <div>
              <p class="text-3xl font-bold mb-1" :class="pnlClass(overview.pnl)">
                <span x-text="overview.pnl >= 0 ? '+Â¥' : '-Â¥'"></span><span x-text="fmt(Math.abs(overview.pnl))"></span>
              </p>
              <p class="text-[11px] text-slate-700">åŸºäºå·²æœ‰å¸‚ä»·ä¼°ç®—</p>
            </div>
          </template>
          <template x-if="overview.pnl == null">
            <div>
              <p class="text-2xl font-bold text-slate-700 mb-1">â€”</p>
              <p class="text-[11px] text-slate-700">éœ€è¦æˆæœ¬ä»· + å¸‚ä»·æ•°æ®</p>
            </div>
          </template>
        </div>

        <!-- P&L% -->
        <div class="card stat-card p-5 relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 rounded-full pointer-events-none"
            :style="overview.pnl_pct != null ? 'background: radial-gradient(circle, ' + pnlBg(overview.pnl_pct) + ', transparent 70%)' : ''"></div>
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2">ç›ˆäºç‡</p>
          <template x-if="overview.pnl_pct != null">
            <div>
              <p class="text-3xl font-bold mb-1" :class="pnlClass(overview.pnl_pct)">
                <span x-text="(overview.pnl_pct >= 0 ? '+' : '') + overview.pnl_pct + '%'"></span>
              </p>
              <div class="flex items-center gap-2 mt-2">
                <div class="flex-1 h-1 rounded-full overflow-hidden" style="background: rgba(51,65,85,0.4)">
                  <div class="h-full rounded-full transition-all duration-1000"
                    :style="'width:' + Math.min(Math.abs(overview.pnl_pct ?? 0), 100) + '%; background:' + (colorMode==='cn' ? (overview.pnl_pct >= 0 ? 'linear-gradient(90deg,#ef4444,#dc2626)' : 'linear-gradient(90deg,#10b981,#059669)') : (overview.pnl_pct >= 0 ? 'linear-gradient(90deg,#10b981,#059669)' : 'linear-gradient(90deg,#ef4444,#dc2626)'))"></div>
                </div>
              </div>
            </div>
          </template>
          <template x-if="overview.pnl_pct == null">
            <div>
              <p class="text-2xl font-bold text-slate-700 mb-1">â€”</p>
              <p class="text-[11px] text-slate-700">å¾…å¸‚ä»·åˆ·æ–°åè®¡ç®—</p>
            </div>
          </template>
        </div>
      </div>

      <!-- Distribution bar -->
      <div class="card p-5">
        <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-4">æŒä»“çŠ¶æ€åˆ†å¸ƒ</p>
        <div class="flex h-3 rounded-full overflow-hidden gap-0.5" x-show="overview.total_active > 0">
          <div class="rounded-sm transition-all duration-1000"
            style="background: linear-gradient(90deg,#22c55e,#16a34a)"
            :style="'width:'+pct(overview.status_breakdown?.rented_out,overview.total_active)+'%'"></div>
          <div class="rounded-sm transition-all duration-1000"
            style="background: linear-gradient(90deg,#3b82f6,#2563eb)"
            :style="'width:'+pct(overview.status_breakdown?.in_steam,overview.total_active)+'%'"></div>
          <div class="rounded-sm transition-all duration-1000"
            style="background: linear-gradient(90deg,#a855f7,#7c3aed)"
            :style="'width:'+pct(overview.status_breakdown?.in_storage,overview.total_active)+'%'"></div>
        </div>
        <div class="flex flex-wrap gap-x-6 gap-y-1 mt-3 text-xs text-slate-600">
          <span><span class="text-green-400">â—</span> å‡ºç§Ÿä¸­
            <span class="font-mono text-green-300 ml-1" x-text="overview.status_breakdown?.rented_out??0"></span>
            (<span x-text="pct(overview.status_breakdown?.rented_out,overview.total_active)+'%'"></span>)
          </span>
          <span><span class="text-blue-400">â—</span> Steamä¸­
            <span class="font-mono text-blue-300 ml-1" x-text="overview.status_breakdown?.in_steam??0"></span>
            (<span x-text="pct(overview.status_breakdown?.in_steam,overview.total_active)+'%'"></span>)
          </span>
          <span><span class="text-purple-400">â—</span> æ”¶è—
            <span class="font-mono text-purple-300 ml-1" x-text="overview.status_breakdown?.in_storage??0"></span>
            (<span x-text="pct(overview.status_breakdown?.in_storage,overview.total_active)+'%'"></span>)
          </span>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â• LISTING TAB â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div x-show="activeTab==='listing'" class="fade-up">

      <!-- Sub-tab bar -->
      <div class="flex items-center gap-3 mb-4">
        <div class="flex gap-0.5 p-1 rounded-xl" style="background: rgba(20,30,48,0.7); border: 1px solid rgba(51,65,85,0.3)">
          <button @click="shelfTab='sell'; loadShelf()"
            class="px-3 py-1.5 rounded-lg text-xs font-medium transition-all"
            :class="shelfTab==='sell' ? 'bg-slate-700 text-white' : 'text-slate-500 hover:text-slate-300'">
            å‡ºå”®è´§æ¶ <span class="font-mono ml-1 text-slate-400" x-text="sellShelf.total??0"></span>
          </button>
          <button @click="shelfTab='lease'; loadShelf()"
            class="px-3 py-1.5 rounded-lg text-xs font-medium transition-all"
            :class="shelfTab==='lease' ? 'bg-slate-700 text-white' : 'text-slate-500 hover:text-slate-300'">
            å‡ºç§Ÿè´§æ¶ <span class="font-mono ml-1 text-slate-400" x-text="leaseShelf.total??0"></span>
          </button>
          <button @click="shelfTab='rented'; loadRentedList(1)"
            class="px-3 py-1.5 rounded-lg text-xs font-medium transition-all"
            :class="shelfTab==='rented' ? 'bg-slate-700 text-white' : 'text-slate-500 hover:text-slate-300'">
            å·²ç§Ÿå‡º <span class="font-mono ml-1 text-slate-400" x-text="rentedList.total??'â€”'"></span>
          </button>
          <button @click="shelfTab='sublet'; loadSubletList(1)"
            class="px-3 py-1.5 rounded-lg text-xs font-medium transition-all"
            :class="shelfTab==='sublet' ? 'bg-slate-700 text-white' : 'text-slate-500 hover:text-slate-300'">
            è½¬ç§Ÿä¸­/0CD <span class="font-mono ml-1 text-amber-500" x-text="subletList.total??'â€”'"></span>
          </button>
          <button @click="shelfTab='unlisted'; loadUnlistedItems(1)"
            class="px-3 py-1.5 rounded-lg text-xs font-medium transition-all"
            :class="shelfTab==='unlisted' ? 'bg-slate-700 text-white' : 'text-slate-500 hover:text-slate-300'">
            å¾…ä¸Šæ¶ <span class="font-mono ml-1 text-blue-400" x-text="unlistedItems.total??'â€”'"></span>
          </button>
        </div>

        <button @click="shelfTab==='rented'?loadRentedList(rentedPage):(shelfTab==='sublet'?loadSubletList(subletPage):(shelfTab==='unlisted'?loadUnlistedItems(unlistedPage):loadShelf()))"
          :disabled="shelfLoading || rentedLoading || subletLoading || unlistedLoading"
          class="flex items-center gap-1.5 px-3 py-1.5 rounded-xl text-xs transition-all disabled:opacity-40"
          style="background:rgba(51,65,85,0.3); border:1px solid rgba(51,65,85,0.4); color:#94a3b8">
          <svg class="w-3 h-3" :class="(shelfLoading||rentedLoading||subletLoading||unlistedLoading)?'animate-spin':''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          åˆ·æ–°
        </button>

        <div class="ml-auto text-[11px] text-slate-700">
          æ™ºèƒ½ä¸Šæ¶åŠŸèƒ½éœ€å…ˆå®Œæˆã€ŒåŒæ­¥æ•°æ®ã€â†’ã€ŒåŒæ­¥æ¨¡æ¿IDã€ä»¥è·å–å¸‚åœºå®šä»·å‚è€ƒ
        </div>
      </div>

      <!-- Template ID sync reminder (if needed, only for shelf tabs) -->
      <div x-show="(shelfTab==='sell'||shelfTab==='lease') && !shelfLoading && sellShelf.total === 0 && leaseShelf.total === 0" x-cloak
        class="card p-5 mb-4 text-center">
        <p class="text-slate-500 text-sm mb-3">è´§æ¶ä¸ºç©ºï¼Œæˆ–å°šæœªåŒæ­¥æ¨¡æ¿IDï¼ˆç”¨äºå¸‚åœºå®šä»·ï¼‰</p>
        <button @click="syncTemplateIds()" :disabled="syncing"
          class="px-5 py-2 rounded-xl text-sm font-medium text-white transition-all disabled:opacity-40"
          style="background:linear-gradient(135deg,#7c3aed,#6d28d9); box-shadow:0 0 16px rgba(124,58,237,0.25)">
          <span x-show="!syncing">åŒæ­¥æ¨¡æ¿IDï¼ˆç”¨äºå¸‚åœºå®šä»·ï¼‰</span>
          <span x-show="syncing" x-cloak>åŒæ­¥ä¸­â€¦</span>
        </button>
      </div>

      <!-- Shelf table (sell / lease shelves) -->
      <div x-show="shelfTab==='sell' || shelfTab==='lease'" class="card overflow-hidden">
        <div class="tbl-wrap">
          <table class="w-full text-xs" style="border-collapse: separate; border-spacing: 0;">
            <thead>
              <tr style="border-bottom: 1px solid rgba(51,65,85,0.3);">
                <th class="py-3 px-4 text-left font-normal text-slate-700 uppercase tracking-wider">é¥°å“</th>
                <template x-if="shelfTab==='sell'">
                  <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider">å‡ºå”®ä»·</th>
                </template>
                <template x-if="shelfTab==='lease'">
                  <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider">æ—¥ç§Ÿé‡‘</th>
                </template>
                <template x-if="shelfTab==='lease'">
                  <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider">æŠ¼é‡‘</th>
                </template>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider">ç£¨æŸ</th>
                <th class="py-3 px-3 text-left font-normal text-slate-700 uppercase tracking-wider">çŠ¶æ€</th>
                <th class="py-3 px-4 w-24 text-center font-normal text-slate-700 uppercase tracking-wider">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <template x-if="shelfLoading">
                <tr><td colspan="6" class="py-16 text-center" style="color:#334155">
                  <div class="flex flex-col items-center gap-2">
                    <div class="w-5 h-5 rounded-full border-2 animate-spin" style="border-color:rgba(51,65,85,0.4);border-top-color:#3b82f6"></div>
                    <span class="text-xs">åŠ è½½è´§æ¶â€¦</span>
                  </div>
                </td></tr>
              </template>
              <template x-if="!shelfLoading && currentShelf.length === 0">
                <tr><td colspan="6" class="py-16 text-center text-xs" style="color:#334155">è´§æ¶ä¸ºç©º</td></tr>
              </template>
              <template x-for="item in currentShelf" :key="item.commodityId || item.CommodityId">
                <tr class="tbl-row">
                  <td class="py-2.5 px-4">
                    <div class="flex items-center gap-2.5">
                      <div class="min-w-0">
                        <p class="text-slate-100 font-medium leading-tight truncate" style="max-width:300px"
                          x-text="item.commodityHashName || item.marketHashName || item.market_hash_name || 'â€”'"></p>
                        <p class="text-[11px] mt-0.5 truncate" style="color:#334155; max-width:300px"
                          x-text="item.name || item.Name || ''"></p>
                      </div>
                    </div>
                  </td>
                  <template x-if="shelfTab==='sell'">
                    <td class="py-2.5 px-3 text-right font-semibold text-slate-100"
                      x-text="'Â¥' + fmt(item.price || item.Price || item.sellPrice)"></td>
                  </template>
                  <template x-if="shelfTab==='lease'">
                    <td class="py-2.5 px-3 text-right font-semibold text-emerald-300"
                      x-text="'Â¥' + fmt(item.leaseUnitPrice || item.LeaseUnitPrice) + '/å¤©'"></td>
                  </template>
                  <template x-if="shelfTab==='lease'">
                    <td class="py-2.5 px-3 text-right font-mono text-slate-400"
                      x-text="'Â¥' + fmt(item.leaseDeposit || item.LeaseDeposit)"></td>
                  </template>
                  <td class="py-2.5 px-3 text-right font-mono" style="color:#475569"
                    x-text="(item.abrade || item.Abrade) != null ? parseFloat(item.abrade || item.Abrade).toFixed(4) : 'â€”'"></td>
                  <td class="py-2.5 px-3">
                    <span class="px-2 py-0.5 rounded-full text-[11px]"
                      style="background:rgba(34,197,94,0.1); color:#4ade80">åœ¨å”®</span>
                  </td>
                  <td class="py-2.5 px-4 text-center">
                    <div class="flex items-center justify-center gap-1.5">
                      <button @click="openReprice(item)"
                        class="text-[11px] px-2 py-1 rounded-lg transition-all"
                        style="background:rgba(99,102,241,0.08); color:rgba(99,102,241,0.7); border:1px solid rgba(99,102,241,0.15)"
                        @mouseenter="$el.style.background='rgba(99,102,241,0.18)'"
                        @mouseleave="$el.style.background='rgba(99,102,241,0.08)'">
                        æ”¹ä»·
                      </button>
                      <button @click="delistItem(item.commodityId || item.CommodityId)"
                        class="text-[11px] px-2 py-1 rounded-lg transition-all"
                        style="background:rgba(239,68,68,0.08); color:rgba(239,68,68,0.6); border:1px solid rgba(239,68,68,0.15)"
                        @mouseenter="$el.style.background='rgba(239,68,68,0.15)'"
                        @mouseleave="$el.style.background='rgba(239,68,68,0.08)'">
                        ä¸‹æ¶
                      </button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <!-- â”€â”€ å·²ç§Ÿå‡ºåˆ—è¡¨ â”€â”€ -->
      <div x-show="shelfTab==='rented'" class="card overflow-hidden">
        <div x-show="rentedList.stats" x-cloak class="px-4 py-2 text-[11px] text-slate-500 border-b" style="border-color:rgba(51,65,85,0.3)"
          x-text="rentedList.stats"></div>
        <div class="tbl-wrap">
          <table class="w-full text-xs" style="border-collapse: separate; border-spacing: 0;">
            <thead>
              <tr style="border-bottom: 1px solid rgba(51,65,85,0.3);">
                <th class="py-3 px-4 text-left font-normal text-slate-700 uppercase tracking-wider">é¥°å“</th>
                <th class="py-3 px-3 text-left font-normal text-slate-700 uppercase tracking-wider">çŠ¶æ€</th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider">ç§Ÿé‡‘</th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider">åˆ°æœŸæ—¶é—´</th>
                <th class="py-3 px-3 text-center font-normal text-slate-700 uppercase tracking-wider">ç»­ç§Ÿ</th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider">ç£¨æŸ</th>
              </tr>
            </thead>
            <tbody>
              <template x-if="rentedLoading">
                <tr><td colspan="6" class="py-16 text-center" style="color:#334155">
                  <div class="flex flex-col items-center gap-2">
                    <div class="w-5 h-5 rounded-full border-2 animate-spin" style="border-color:rgba(51,65,85,0.4);border-top-color:#3b82f6"></div>
                    <span class="text-xs">åŠ è½½ä¸­â€¦</span>
                  </div>
                </td></tr>
              </template>
              <template x-if="!rentedLoading && (rentedList.items||[]).length === 0">
                <tr><td colspan="6" class="py-16 text-center text-xs" style="color:#334155">æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»ã€Œåˆ·æ–°ã€</td></tr>
              </template>
              <template x-for="item in (rentedList.items||[])" :key="item.orderId">
                <tr class="tbl-row">
                  <td class="py-2.5 px-4">
                    <div class="min-w-0">
                      <p class="text-slate-100 font-medium leading-tight truncate" style="max-width:300px"
                        x-text="item.hashName || item.name || 'â€”'"></p>
                      <p class="text-[11px] mt-0.5 truncate font-mono" style="color:#334155; max-width:300px"
                        x-text="item.orderId"></p>
                    </div>
                  </td>
                  <td class="py-2.5 px-3">
                    <span class="px-2 py-0.5 rounded-full text-[11px]"
                      :style="item.isSublet ? 'background:rgba(234,179,8,0.1);color:#fbbf24' : 'background:rgba(99,102,241,0.1);color:#818cf8'"
                      x-text="item.isSublet ? 'è½¬ç§Ÿä¸­' : (item.orderStatusDesc || 'ç§Ÿå‡ºä¸­')"></span>
                  </td>
                  <td class="py-2.5 px-3 text-right font-semibold text-emerald-300" x-text="item.leaseAmountDesc || 'â€”'"></td>
                  <td class="py-2.5 px-3 text-right font-mono text-slate-400"
                    x-text="item.leaseExpireTime ? item.leaseExpireTime.slice(0,16).replace('T',' ') : (item.leaseDaysDesc || 'â€”')"></td>
                  <td class="py-2.5 px-3 text-center">
                    <span x-show="item.hasRenewal" class="px-1.5 py-0.5 rounded text-[10px]" style="background:rgba(234,179,8,0.1);color:#fbbf24">ç»­ç§Ÿ</span>
                    <span x-show="!item.hasRenewal" class="text-slate-700">â€”</span>
                  </td>
                  <td class="py-2.5 px-3 text-right font-mono" style="color:#475569"
                    x-text="item.abrade != null ? parseFloat(item.abrade).toFixed(4) : 'â€”'"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <div x-show="!rentedLoading && rentedList.total > (rentedList.page_size||50)"
          class="flex items-center justify-between px-4 py-3 border-t" style="border-color:rgba(51,65,85,0.3)">
          <span class="text-[11px] text-slate-600">å…± <span class="font-mono text-slate-400" x-text="rentedList.total"></span> æ¡ Â· ç¬¬ <span class="font-mono text-slate-400" x-text="rentedPage"></span> é¡µ</span>
          <div class="flex gap-2">
            <button @click="loadRentedList(rentedPage-1)" :disabled="rentedPage<=1"
              class="px-3 py-1 rounded-lg text-xs disabled:opacity-30" style="background:rgba(51,65,85,0.3);color:#94a3b8">ä¸Šä¸€é¡µ</button>
            <button @click="loadRentedList(rentedPage+1)" :disabled="rentedPage*(rentedList.page_size||50)>=rentedList.total"
              class="px-3 py-1 rounded-lg text-xs disabled:opacity-30" style="background:rgba(51,65,85,0.3);color:#94a3b8">ä¸‹ä¸€é¡µ</button>
          </div>
        </div>
      </div>

      <!-- â”€â”€ è½¬ç§Ÿä¸­/0CDåˆ—è¡¨ â”€â”€ -->
      <div x-show="shelfTab==='sublet'" class="card overflow-hidden">
        <div x-show="subletList.stats" x-cloak class="px-4 py-2 text-[11px] text-slate-500 border-b" style="border-color:rgba(51,65,85,0.3)"
          x-text="subletList.stats"></div>
        <div class="tbl-wrap">
          <table class="w-full text-xs" style="border-collapse: separate; border-spacing: 0;">
            <thead>
              <tr style="border-bottom: 1px solid rgba(51,65,85,0.3);">
                <th class="py-3 px-4 text-left font-normal text-slate-700 uppercase tracking-wider">é¥°å“</th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider">ç§Ÿé‡‘</th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider">åˆ°æœŸæ—¶é—´</th>
                <th class="py-3 px-3 text-center font-normal text-slate-700 uppercase tracking-wider">ç»­ç§Ÿ</th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider">ç£¨æŸ</th>
                <th class="py-3 px-4 text-center font-normal text-slate-700 uppercase tracking-wider">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <template x-if="subletLoading">
                <tr><td colspan="6" class="py-16 text-center" style="color:#334155">
                  <div class="flex flex-col items-center gap-2">
                    <div class="w-5 h-5 rounded-full border-2 animate-spin" style="border-color:rgba(51,65,85,0.4);border-top-color:#f59e0b"></div>
                    <span class="text-xs">åŠ è½½è½¬ç§Ÿä¸­é¥°å“â€¦</span>
                  </div>
                </td></tr>
              </template>
              <template x-if="!subletLoading && (subletList.items||[]).length === 0">
                <tr><td colspan="6" class="py-16 text-center text-xs" style="color:#334155">æš‚æ— è½¬ç§Ÿä¸­é¥°å“ï¼Œè¯·ç‚¹å‡»ã€Œåˆ·æ–°ã€</td></tr>
              </template>
              <template x-for="item in (subletList.items||[])" :key="item.orderId">
                <tr class="tbl-row">
                  <td class="py-2.5 px-4">
                    <div class="min-w-0">
                      <p class="text-slate-100 font-medium leading-tight truncate" style="max-width:280px"
                        x-text="item.hashName || item.name || 'â€”'"></p>
                      <p class="text-[11px] mt-0.5 truncate font-mono" style="color:#334155; max-width:280px"
                        x-text="item.orderId"></p>
                    </div>
                  </td>
                  <td class="py-2.5 px-3 text-right font-semibold text-emerald-300" x-text="item.leaseAmountDesc || 'â€”'"></td>
                  <td class="py-2.5 px-3 text-right font-mono text-slate-400"
                    x-text="item.leaseExpireTime ? item.leaseExpireTime.slice(0,16).replace('T',' ') : (item.leaseDaysDesc || 'â€”')"></td>
                  <td class="py-2.5 px-3 text-center">
                    <span x-show="item.hasRenewal" class="px-1.5 py-0.5 rounded text-[10px]" style="background:rgba(234,179,8,0.1);color:#fbbf24">ç»­ç§Ÿ</span>
                    <span x-show="!item.hasRenewal" class="text-slate-700">â€”</span>
                  </td>
                  <td class="py-2.5 px-3 text-right font-mono" style="color:#475569"
                    x-text="item.abrade != null ? parseFloat(item.abrade).toFixed(4) : 'â€”'"></td>
                  <td class="py-2.5 px-4 text-center">
                    <button @click="cancelSubletOrder(item.orderId)"
                      class="text-[11px] px-2 py-1 rounded-lg transition-all"
                      style="background:rgba(234,179,8,0.08); color:rgba(234,179,8,0.7); border:1px solid rgba(234,179,8,0.15)"
                      @mouseenter="$el.style.background='rgba(234,179,8,0.18)'"
                      @mouseleave="$el.style.background='rgba(234,179,8,0.08)'">
                      å–æ¶ˆè½¬ç§Ÿ
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <div x-show="!subletLoading && subletList.total > (subletList.page_size||50)"
          class="flex items-center justify-between px-4 py-3 border-t" style="border-color:rgba(51,65,85,0.3)">
          <span class="text-[11px] text-slate-600">å…± <span class="font-mono text-slate-400" x-text="subletList.total"></span> æ¡ Â· ç¬¬ <span class="font-mono text-slate-400" x-text="subletPage"></span> é¡µ</span>
          <div class="flex gap-2">
            <button @click="loadSubletList(subletPage-1)" :disabled="subletPage<=1"
              class="px-3 py-1 rounded-lg text-xs disabled:opacity-30" style="background:rgba(51,65,85,0.3);color:#94a3b8">ä¸Šä¸€é¡µ</button>
            <button @click="loadSubletList(subletPage+1)" :disabled="subletPage*(subletList.page_size||50)>=subletList.total"
              class="px-3 py-1 rounded-lg text-xs disabled:opacity-30" style="background:rgba(51,65,85,0.3);color:#94a3b8">ä¸‹ä¸€é¡µ</button>
          </div>
        </div>
      </div>

      <!-- â”€â”€ å¾…ä¸Šæ¶é¥°å“ â”€â”€ -->
      <div x-show="shelfTab==='unlisted'" class="card overflow-hidden">
        <div x-show="unlistedItems.total > 0" x-cloak class="px-4 py-2 text-[11px] text-slate-500 border-b" style="border-color:rgba(51,65,85,0.3)">
          Steamåº“å­˜ <span class="text-slate-400 font-mono" x-text="unlistedItems.total_inventory"></span> ä»¶ Â·
          å·²ä¸Šæ¶ <span class="text-slate-400 font-mono" x-text="unlistedItems.total_listed"></span> ä»¶ Â·
          å¯ä¸Šæ¶ <span class="text-blue-400 font-mono" x-text="unlistedItems.total"></span> ä»¶
        </div>
        <div class="tbl-wrap">
          <table class="w-full text-xs" style="border-collapse: separate; border-spacing: 0;">
            <thead>
              <tr style="border-bottom: 1px solid rgba(51,65,85,0.3);">
                <th class="py-3 px-4 text-left font-normal text-slate-700 uppercase tracking-wider">é¥°å“</th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider">ç£¨æŸ</th>
                <th class="py-3 px-3 text-center font-normal text-slate-700 uppercase tracking-wider">æ¨¡æ¿ID</th>
                <th class="py-3 px-4 text-center font-normal text-slate-700 uppercase tracking-wider">å¿«æ·ä¸Šæ¶</th>
              </tr>
            </thead>
            <tbody>
              <template x-if="unlistedLoading">
                <tr><td colspan="4" class="py-16 text-center" style="color:#334155">
                  <div class="flex flex-col items-center gap-2">
                    <div class="w-5 h-5 rounded-full border-2 animate-spin" style="border-color:rgba(51,65,85,0.4);border-top-color:#60a5fa"></div>
                    <span class="text-xs">æ‹‰å–åº“å­˜å¯¹æ¯”ä¸­â€¦ï¼ˆéœ€å‡ ç§’ï¼‰</span>
                  </div>
                </td></tr>
              </template>
              <template x-if="!unlistedLoading && (unlistedItems.items||[]).length === 0">
                <tr><td colspan="4" class="py-16 text-center text-xs" style="color:#334155">
                  æš‚æ— å¾…ä¸Šæ¶é¥°å“ï¼Œæˆ–è¯·ç‚¹å‡»ã€Œåˆ·æ–°ã€åŠ è½½
                </td></tr>
              </template>
              <template x-for="item in (unlistedItems.items||[])" :key="item.assetId">
                <tr class="tbl-row">
                  <td class="py-2.5 px-4">
                    <div class="min-w-0">
                      <p class="text-slate-100 font-medium leading-tight truncate" style="max-width:320px"
                        x-text="item.commodityHashName || item.name || 'â€”'"></p>
                      <p class="text-[11px] mt-0.5 truncate" style="color:#334155; max-width:320px"
                        x-text="item.name || ''"></p>
                    </div>
                  </td>
                  <td class="py-2.5 px-3 text-right font-mono" style="color:#475569"
                    x-text="item.abrade != null ? parseFloat(item.abrade).toFixed(4) : 'â€”'"></td>
                  <td class="py-2.5 px-3 text-center font-mono text-slate-500"
                    x-text="item.templateId || 'â€”'"></td>
                  <td class="py-2.5 px-4 text-center">
                    <button x-show="item.templateId"
                      @click="quickList.assetId=item.assetId; quickList.templateId=item.templateId; shelfTab='sell'"
                      class="text-[11px] px-2 py-1 rounded-lg transition-all"
                      style="background:rgba(59,130,246,0.08); color:rgba(59,130,246,0.7); border:1px solid rgba(59,130,246,0.15)"
                      @mouseenter="$el.style.background='rgba(59,130,246,0.18)'"
                      @mouseleave="$el.style.background='rgba(59,130,246,0.08)'">
                      â†’ ä¸Šæ¶é¢æ¿
                    </button>
                    <span x-show="!item.templateId" class="text-[11px] text-slate-700">æ— æ¨¡æ¿ID</span>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <div x-show="!unlistedLoading && unlistedItems.total > (unlistedItems.page_size||50)"
          class="flex items-center justify-between px-4 py-3 border-t" style="border-color:rgba(51,65,85,0.3)">
          <span class="text-[11px] text-slate-600">å…± <span class="font-mono text-slate-400" x-text="unlistedItems.total"></span> ä»¶ Â· ç¬¬ <span class="font-mono text-slate-400" x-text="unlistedPage"></span> é¡µ</span>
          <div class="flex gap-2">
            <button @click="loadUnlistedItems(unlistedPage-1)" :disabled="unlistedPage<=1"
              class="px-3 py-1 rounded-lg text-xs disabled:opacity-30" style="background:rgba(51,65,85,0.3);color:#94a3b8">ä¸Šä¸€é¡µ</button>
            <button @click="loadUnlistedItems(unlistedPage+1)" :disabled="unlistedPage*(unlistedItems.page_size||50)>=unlistedItems.total"
              class="px-3 py-1 rounded-lg text-xs disabled:opacity-30" style="background:rgba(51,65,85,0.3);color:#94a3b8">ä¸‹ä¸€é¡µ</button>
          </div>
        </div>
      </div>

      <!-- Smart List panel (from inventory) -->
      <div class="card p-5 mt-4">
        <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-3">ä»æŒä»“å¿«é€Ÿä¸Šæ¶</p>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
          <div>
            <p class="text-[11px] text-slate-600 mb-1">Asset ID</p>
            <input x-model="quickList.assetId" type="text" placeholder="Steam Asset ID"
              class="w-full px-3 py-2 rounded-xl text-xs border" />
          </div>
          <div>
            <p class="text-[11px] text-slate-600 mb-1">Template ID</p>
            <input x-model.number="quickList.templateId" type="number" placeholder="æ‚ æ‚ æ¨¡æ¿ID"
              class="w-full px-3 py-2 rounded-xl text-xs border" />
          </div>
          <div>
            <p class="text-[11px] text-slate-600 mb-1">ä¸Šæ¶æ¨¡å¼</p>
            <select x-model="quickList.mode" class="w-full py-2 pl-3 rounded-xl text-xs border">
              <option value="sell">ä»…å‡ºå”®</option>
              <option value="lease">ä»…å‡ºç§Ÿ</option>
              <option value="both">å¯ç§Ÿå¯å”®</option>
            </select>
          </div>
          <div>
            <p class="text-[11px] text-slate-600 mb-1">è´­å…¥ä»·ï¼ˆæ­¢ç›ˆç”¨ï¼‰</p>
            <input x-model.number="quickList.buyPrice" type="number" placeholder="å…ƒ" step="0.01"
              class="w-full px-3 py-2 rounded-xl text-xs border" />
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <span class="text-[11px] text-slate-600">æ­¢ç›ˆç‡</span>
            <input x-model.number="quickList.takeProfitRatio" type="number" placeholder="0 = ä¸å¯ç”¨" step="0.01" min="0"
              class="w-24 px-2 py-1.5 rounded-lg text-xs border" />
          </div>
          <div class="flex items-center gap-2">
            <span class="text-[11px] text-slate-600">ä½ä¸€åˆ†</span>
            <label class="pill-toggle" :class="quickList.useUndercut ? 'active-blue' : ''"
              @click="quickList.useUndercut = !quickList.useUndercut">
              <div class="relative toggle-track" :style="quickList.useUndercut ? 'background:#1d4ed8' : 'background:#1e293b'">
                <div class="toggle-thumb" :style="quickList.useUndercut ? 'transform:translateX(12px)' : ''"></div>
              </div>
            </label>
          </div>
          <button @click="previewListPrice()" :disabled="!quickList.templateId || quickList.previewing"
            class="px-4 py-2 rounded-xl text-xs font-medium transition-all disabled:opacity-40"
            style="background:rgba(99,102,241,0.12); border:1px solid rgba(99,102,241,0.2); color:#a5b4fc">
            é¢„è§ˆå®šä»·
          </button>
          <button @click="smartListItem()" :disabled="!quickList.assetId || !quickList.templateId || quickList.listing"
            class="px-4 py-2 rounded-xl text-xs font-semibold text-white transition-all disabled:opacity-40"
            style="background:linear-gradient(135deg,#059669,#047857); box-shadow:0 0 14px rgba(5,150,105,0.2)">
            <span x-show="!quickList.listing">æ™ºèƒ½ä¸Šæ¶</span>
            <span x-show="quickList.listing" x-cloak>ä¸Šæ¶ä¸­â€¦</span>
          </button>
        </div>
        <!-- Preview result -->
        <div x-show="quickList.preview" x-cloak class="mt-3 p-3 rounded-xl text-xs"
          style="background:rgba(10,18,35,0.7); border:1px solid rgba(51,65,85,0.25)">
          <div class="grid grid-cols-2 gap-2">
            <div>
              <p class="text-slate-600 mb-0.5">å»ºè®®å‡ºå”®ä»·</p>
              <p class="font-semibold text-slate-100" x-text="quickList.preview?.suggested_sell ? 'Â¥'+fmt(quickList.preview.suggested_sell) : 'â€”'"></p>
            </div>
            <div x-show="quickList.preview?.suggested_lease">
              <p class="text-slate-600 mb-0.5">å»ºè®®ç§Ÿé‡‘/æŠ¼é‡‘</p>
              <p class="font-semibold text-emerald-300"
                x-text="quickList.preview?.suggested_lease ? 'Â¥'+fmt(quickList.preview.suggested_lease.lease_unit)+'/å¤©  æŠ¼é‡‘Â¥'+fmt(quickList.preview.suggested_lease.deposit) : 'â€”'"></p>
            </div>
          </div>
          <div class="mt-2" x-show="quickList.preview?.market_sell_top5?.length">
            <p class="text-slate-700 mb-1">å¸‚åœºå‰5æ¡£</p>
            <div class="flex gap-2 flex-wrap">
              <template x-for="p in (quickList.preview?.market_sell_top5||[])" :key="p.price">
                <span class="px-2 py-0.5 rounded-full text-[11px]" style="background:rgba(51,65,85,0.3); color:#94a3b8"
                  x-text="'Â¥'+fmt(p.price)"></span>
              </template>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â• INVENTORY TAB â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div x-show="activeTab==='inventory'">

      <!-- Mini strip -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
        <div class="card px-4 py-3">
          <p class="text-[11px] text-slate-600 mb-0.5">æ€»æˆæœ¬</p>
          <p class="text-base font-bold text-white">Â¥<span x-text="fmt(overview.total_cost)">â€”</span></p>
        </div>
        <div class="card px-4 py-3">
          <p class="text-[11px] text-slate-600 mb-0.5">æ´»è·ƒæŒä»“</p>
          <p class="text-base font-bold text-white" x-text="overview.total_active??'â€”'"></p>
        </div>
        <div class="card px-4 py-3">
          <p class="text-[11px] text-slate-600 mb-0.5">å®šä»·è¦†ç›–</p>
          <p class="text-base font-bold">
            <span class="text-white" x-text="overview.priced_count??'â€”'"></span>
            <span class="text-slate-700 text-sm"> / </span>
            <span class="text-slate-500 text-sm" x-text="overview.total_active??'â€”'"></span>
          </p>
        </div>
        <div class="card px-4 py-3">
          <p class="text-[11px] text-slate-600 mb-0.5">æ‰‹åŠ¨å®šä»·</p>
          <p class="text-base font-bold text-yellow-300" x-text="overview.manual_price_count??'â€”'"></p>
        </div>
      </div>

      <!-- Filter bar -->
      <div class="card px-4 py-3 mb-4">
        <div class="flex flex-wrap items-center gap-2">

          <!-- Search -->
          <div class="relative flex-1 min-w-[180px]">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 pointer-events-none"
              style="color:#475569" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input type="text" x-model="filters.search"
              @input.debounce.400ms="page=1; loadItems()"
              placeholder="æœç´¢é¥°å“åç§°â€¦"
              class="w-full pl-9 pr-3 py-2 rounded-xl text-sm border" />
          </div>

          <!-- Status -->
          <select x-model="filters.status" @change="page=1; loadItems()"
            class="py-2 pl-3 rounded-xl text-sm border" style="min-width: 108px">
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="rented_out">å‡ºç§Ÿä¸­</option>
            <option value="in_steam">Steamä¸­</option>
            <option value="in_storage">æ”¶è—</option>
          </select>

          <!-- Priced filter -->
          <select x-model="filters.pricedFilter" @change="page=1; loadItems()"
            class="py-2 pl-3 rounded-xl text-sm border" style="min-width: 96px">
            <option value="">å…¨éƒ¨</option>
            <option value="priced">å·²å®šä»·</option>
            <option value="unpriced">æœªå®šä»·</option>
          </select>

          <!-- Show sold toggle -->
          <label class="pill-toggle" :class="showSold ? 'active-slate' : ''"
            @click="showSold=!showSold; page=1; loadItems()">
            <span>æ˜¾ç¤ºå·²å”®</span>
            <div class="relative toggle-track" :style="showSold ? 'background:#475569' : 'background:#1e293b'">
              <div class="toggle-thumb" :style="showSold ? 'transform:translateX(12px)' : ''"></div>
            </div>
          </label>

          <!-- Dual price toggle -->
          <label class="pill-toggle" :class="dualPrice ? 'active-blue' : ''"
            @click="dualPrice=!dualPrice">
            <span>åŒä»·å¯¹æ¯”</span>
            <div class="relative toggle-track" :style="dualPrice ? 'background:#1d4ed8' : 'background:#1e293b'">
              <div class="toggle-thumb" :style="dualPrice ? 'transform:translateX(12px)' : ''"></div>
            </div>
          </label>

          <!-- Cost sort shortcut -->
          <button @click="setSort('effective_price')"
            class="pill-toggle" :class="sortBy==='effective_price' ? 'active-blue' : ''">
            æˆæœ¬æ’åº <span x-text="sortBy==='effective_price'?(sortOrder==='desc'?'â†“':'â†‘'):'â†•'"></span>
          </button>

          <!-- Page size -->
          <select x-model.number="pageSize" @change="page=1; loadItems()"
            class="py-2 pl-3 rounded-xl text-sm border ml-auto" style="width: 70px">
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
          </select>
        </div>
      </div>

      <!-- Table -->
      <div class="card overflow-hidden">
        <div class="tbl-wrap">
          <table class="w-full text-xs" style="border-collapse: separate; border-spacing: 0;">
            <thead>
              <tr style="border-bottom: 1px solid rgba(51,65,85,0.3);">
                <th class="py-3 px-4 text-left font-normal text-slate-700 uppercase tracking-wider w-8">#</th>
                <th class="py-3 px-4 text-left font-normal text-slate-700 uppercase tracking-wider">é¥°å“</th>
                <th class="py-3 px-3 text-left font-normal text-slate-700 uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" @click="setSort('status')">
                  çŠ¶æ€ <span x-text="sortIcon('status')"></span>
                </th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" @click="setSort('abrade')">
                  ç£¨æŸ <span x-text="sortIcon('abrade')"></span>
                </th>
                <template x-if="!dualPrice">
                  <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" @click="setSort('effective_price')">
                    æˆæœ¬ä»· <span x-text="sortIcon('effective_price')"></span>
                  </th>
                </template>
                <template x-if="dualPrice">
                  <th class="py-3 px-3 text-right font-normal uppercase tracking-wider" style="color:#475569">è‡ªåŠ¨ä»·</th>
                </template>
                <template x-if="dualPrice">
                  <th class="py-3 px-3 text-right font-normal uppercase tracking-wider" style="color:rgba(202,138,4,0.7)">æ‰‹åŠ¨ä»·</th>
                </template>
                <th class="py-3 px-3 text-right font-normal uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" style="color:#047857" @click="setSort('current_price')">
                  å¸‚ä»· <span x-text="sortIcon('current_price')"></span>
                </th>
                <th class="py-3 px-3 text-right font-normal uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" style="color:#475569" @click="setSort('pnl')">
                  ç›ˆäº <span x-text="sortIcon('pnl')"></span>
                </th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" @click="setSort('purchase_date')">
                  è´­å…¥æ—¥æœŸ <span x-text="sortIcon('purchase_date')"></span>
                </th>
                <th class="py-3 px-3 text-left font-normal text-slate-700 uppercase tracking-wider">å¹³å°</th>
                <th class="py-3 px-4 w-10"></th>
              </tr>
            </thead>
            <tbody>
              <!-- Loading -->
              <template x-if="loading">
                <tr>
                  <td :colspan="dualPrice ? 11 : 10" class="py-24 text-center" style="color:#334155">
                    <div class="flex flex-col items-center gap-3">
                      <div class="w-6 h-6 rounded-full border-2 border-t-blue-500 animate-spin" style="border-color: rgba(51,65,85,0.4); border-top-color: #3b82f6"></div>
                      <span class="text-xs">åŠ è½½ä¸­â€¦</span>
                    </div>
                  </td>
                </tr>
              </template>

              <!-- Empty -->
              <template x-if="!loading && items.length === 0">
                <tr>
                  <td :colspan="dualPrice ? 11 : 10" class="py-24 text-center text-xs" style="color:#334155">
                    æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é¥°å“
                  </td>
                </tr>
              </template>

              <!-- Rows -->
              <template x-for="(item, idx) in items" :key="item.id">
                <tr class="tbl-row" @click="openPanel(item)">
                  <td class="py-2.5 px-4 font-mono" style="color:#334155" x-text="(page-1)*pageSize+idx+1"></td>

                  <!-- Item name + icon -->
                  <td class="py-2.5 px-4">
                    <div class="flex items-center gap-2.5">
                      <div class="w-9 h-9 rounded-lg overflow-hidden flex-shrink-0" style="background:rgba(20,30,48,0.8)">
                        <img :src="iconUrl(item.icon_url)" class="w-full h-full object-cover"
                          @error="$el.style.opacity='0'" loading="lazy" />
                      </div>
                      <div class="min-w-0">
                        <p class="text-slate-100 font-medium leading-tight truncate" style="max-width:260px" x-text="item.market_hash_name"></p>
                        <p class="leading-tight truncate mt-0.5" style="max-width:260px; color:#334155" x-text="item.name"></p>
                      </div>
                    </div>
                  </td>

                  <!-- Status badge -->
                  <td class="py-2.5 px-3">
                    <span class="px-2 py-0.5 rounded-full text-[11px] font-medium tracking-wide"
                      :class="statusCls(item.status)" x-text="statusLbl(item.status)"></span>
                  </td>

                  <!-- Abrade -->
                  <td class="py-2.5 px-3 text-right font-mono" style="color:#334155"
                    x-text="item.abrade!=null ? item.abrade.toFixed(6) : 'â€”'"></td>

                  <!-- Single price -->
                  <template x-if="!dualPrice">
                    <td class="py-2.5 px-3 text-right">
                      <span x-show="item.effective_price!=null" class="font-semibold"
                        :class="item.purchase_price_manual!=null ? 'text-yellow-300' : 'text-slate-100'"
                        x-text="'Â¥'+fmt(item.effective_price)"></span>
                      <span x-show="item.effective_price==null" style="color:#1e293b">â€”</span>
                    </td>
                  </template>

                  <!-- Auto price (dual) -->
                  <template x-if="dualPrice">
                    <td class="py-2.5 px-3 text-right" style="color:#475569">
                      <span x-show="item.purchase_price!=null" x-text="'Â¥'+fmt(item.purchase_price)"></span>
                      <span x-show="item.purchase_price==null" style="color:#1e293b">â€”</span>
                    </td>
                  </template>

                  <!-- Manual price (dual) -->
                  <template x-if="dualPrice">
                    <td class="py-2.5 px-3 text-right">
                      <span x-show="item.purchase_price_manual!=null"
                        class="text-yellow-300 font-semibold"
                        x-text="'Â¥'+fmt(item.purchase_price_manual)"></span>
                      <span x-show="item.purchase_price_manual==null" style="color:#1e293b">â€”</span>
                    </td>
                  </template>

                  <!-- Current market price -->
                  <td class="py-2.5 px-3 text-right font-mono">
                    <span x-show="item.current_price != null"
                      class="text-emerald-400/80 text-xs"
                      x-text="'Â¥'+fmt(item.current_price)"></span>
                    <span x-show="item.current_price == null" style="color:#1e293b">â€”</span>
                  </td>

                  <!-- P&L -->
                  <td class="py-2.5 px-3 text-right font-mono">
                    <template x-if="item.pnl != null">
                      <div class="flex flex-col items-end leading-tight">
                        <span class="text-xs font-semibold" :class="pnlClass(item.pnl)"
                          x-text="(item.pnl >= 0 ? '+Â¥' : '-Â¥') + fmt(Math.abs(item.pnl))"></span>
                        <span class="text-[10px]" :class="pnlClassMd(item.pnl_pct)"
                          x-text="(item.pnl_pct >= 0 ? '+' : '') + item.pnl_pct + '%'"></span>
                      </div>
                    </template>
                    <template x-if="item.pnl == null">
                      <span style="color:#1e293b">â€”</span>
                    </template>
                  </td>

                  <!-- Date -->
                  <td class="py-2.5 px-3 text-right font-mono" style="color:#334155" x-text="item.purchase_date||'â€”'"></td>

                  <!-- Platform -->
                  <td class="py-2.5 px-3" style="color:#334155" x-text="item.purchase_platform||'â€”'"></td>

                  <!-- Edit btn -->
                  <td class="py-2.5 px-4 text-center">
                    <div class="w-6 h-6 rounded-md flex items-center justify-center transition-colors"
                      style="background: rgba(30,41,59,0.5); color:#334155"
                      @mouseenter="$el.style.color='#94a3b8'" @mouseleave="$el.style.color='#334155'">
                      <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                      </svg>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="px-5 py-3 flex items-center justify-between"
          style="border-top: 1px solid rgba(51,65,85,0.2)">
          <p class="text-xs" style="color:#334155">
            å…± <span class="text-slate-400 font-medium" x-text="total"></span> æ¡ Â·
            ç¬¬ <span class="text-slate-500" x-text="page"></span> /
            <span class="text-slate-500" x-text="Math.max(1,Math.ceil(total/pageSize))"></span> é¡µ
          </p>
          <div class="flex items-center gap-1">
            <button class="pg-btn" @click="gotoPage(page-1)" :disabled="page<=1">â€¹</button>
            <template x-for="(p,i) in pageNums" :key="i">
              <template x-if="p==='...'">
                <span class="text-xs px-1" style="color:#334155">â€¦</span>
              </template>
              <template x-if="p!=='...'">
                <button class="pg-btn" :class="p===page?'active':''" @click="gotoPage(p)" x-text="p"></button>
              </template>
            </template>
            <button class="pg-btn" @click="gotoPage(page+1)" :disabled="page>=Math.ceil(total/pageSize)">â€º</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- â”€â”€ Detail Side Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <template x-teleport="body">
    <div x-show="panel" x-cloak>
      <div class="fixed inset-0 backdrop-blur-sm"
        style="background:rgba(0,0,0,0.55); z-index:1000" @click="panel=null"></div>
      <div class="fixed top-0 right-0 h-full overflow-y-auto shadow-2xl slide-right"
        style="width:380px; background:#07101f; border-left:1px solid rgba(51,65,85,0.35); z-index:1001"
        x-show="panel">
        <div class="p-5 flex flex-col min-h-full">

          <!-- Header -->
          <div class="flex items-start gap-3 mb-4">
            <div class="flex-1 min-w-0">
              <h2 class="text-sm font-semibold text-white leading-snug" x-text="panel?.market_hash_name"></h2>
              <p class="text-xs mt-0.5" style="color:#475569" x-text="panel?.name"></p>
            </div>
            <button @click="panel=null"
              class="w-7 h-7 rounded-lg flex items-center justify-center transition-colors text-base leading-none flex-shrink-0"
              style="background:rgba(30,41,59,0.8); color:#475569"
              @mouseenter="$el.style.color='#e2e8f0'" @mouseleave="$el.style.color='#475569'">âœ•</button>
          </div>

          <!-- Image -->
          <div class="rounded-xl mb-4 flex items-center justify-center h-36 overflow-hidden"
            style="background:rgba(10,18,35,0.8); border:1px solid rgba(51,65,85,0.25)">
            <img :src="iconUrl(panel?.icon_url, 200)" class="max-h-full max-w-full object-contain"
              @error="$el.style.display='none'" x-show="panel?.icon_url" />
            <span x-show="!panel?.icon_url" class="text-xs" style="color:#1e293b">No image</span>
          </div>

          <!-- Info grid -->
          <div class="grid grid-cols-2 gap-2 mb-5">
            <template x-for="[label,val,wide,yellow] in panelFields()" :key="label">
              <div class="rounded-xl p-3" :class="wide ? 'col-span-2' : ''"
                style="background:rgba(10,18,35,0.7); border:1px solid rgba(51,65,85,0.25)">
                <p class="text-[11px] mb-1" style="color:#475569" x-text="label"></p>
                <p class="text-xs font-medium font-mono"
                  :class="yellow ? 'text-yellow-300' : 'text-slate-200'"
                  x-text="val || 'â€”'"></p>
              </div>
            </template>
          </div>

          <!-- Manual price -->
          <div class="mt-auto pt-4" style="border-top:1px solid rgba(51,65,85,0.3)">
            <div class="flex items-center justify-between mb-1">
              <p class="text-sm font-medium text-slate-200">æ‰‹åŠ¨è´­å…¥ä»·</p>
              <span x-show="panel?.purchase_price_manual!=null"
                class="text-[11px] px-2 py-0.5 rounded-full font-medium"
                style="background:rgba(202,138,4,0.12); color:#fbbf24">å·²æ‰‹åŠ¨è®¾ç½®</span>
            </div>
            <p class="text-[11px] mb-3" style="color:#334155">ä¼˜å…ˆäºè‡ªåŠ¨è¯†åˆ«ä»·ï¼Œä¸è¢«è‡ªåŠ¨å¯¼å…¥è¦†ç›–ã€‚</p>
            <div class="flex gap-2">
              <input type="number" x-model="manualInput" placeholder="é‡‘é¢ï¼ˆå…ƒï¼‰" step="0.01" min="0"
                @keydown.enter="saveManual()"
                class="flex-1 px-3 py-2 rounded-xl text-sm border" />
              <button @click="saveManual()" :disabled="saving"
                class="px-4 py-2 rounded-xl text-sm font-semibold text-slate-900 transition-all disabled:opacity-40"
                style="background:linear-gradient(135deg,#d97706,#b45309); box-shadow:0 0 12px rgba(217,119,6,0.2)">
                <span x-show="!saving">ä¿å­˜</span><span x-show="saving">â€¦</span>
              </button>
            </div>
            <button x-show="panel?.purchase_price_manual!=null" @click="clearManual()"
              class="mt-2 text-[11px] transition-colors"
              style="color:rgba(239,68,68,0.5)"
              @mouseenter="$el.style.color='rgba(239,68,68,0.8)'"
              @mouseleave="$el.style.color='rgba(239,68,68,0.5)'">
              Ã— æ¸…é™¤æ‰‹åŠ¨ä»·æ ¼
            </button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- â”€â”€ Import Result Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <template x-teleport="body">
    <div x-show="importResult" x-cloak
      class="fixed inset-0 flex items-center justify-center backdrop-blur-sm"
      style="background:rgba(0,0,0,0.65); z-index:9999"
      @click.self="importResult=null; loadAll()"
      @keydown.escape.window="importResult=null; loadAll()">
      <div class="flex flex-col rounded-2xl shadow-2xl fade-up"
        style="background:#07101f; border:1px solid rgba(51,65,85,0.4); width:420px; max-width:95vw; max-height:80vh">
        <!-- Header -->
        <div class="flex items-center justify-between px-5 pt-5 pb-3 flex-shrink-0">
          <div class="flex items-center gap-2">
            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs"
              style="background:rgba(34,197,94,0.12); color:#22c55e">âœ“</div>
            <h3 class="text-sm font-semibold text-white">å¯¼å…¥å®Œæˆ</h3>
          </div>
          <button @click="importResult=null; loadAll()"
            class="w-7 h-7 rounded-lg flex items-center justify-center text-base leading-none transition-colors"
            style="background:rgba(30,41,59,0.8); color:#475569"
            @mouseenter="$el.style.color='#e2e8f0'" @mouseleave="$el.style.color='#475569'">âœ•</button>
        </div>
        <!-- Scrollable content -->
        <div class="px-5 pb-3 overflow-y-auto flex-1 space-y-2">
          <template x-for="[sec,data] in Object.entries(importResult||{})" :key="sec">
            <div class="rounded-xl p-3.5" style="background:rgba(10,18,35,0.7); border:1px solid rgba(51,65,85,0.25)">
              <p class="text-xs font-semibold text-slate-300 mb-2.5" x-text="importLbl(sec)"></p>
              <template x-if="typeof data==='object' && data!==null">
                <div class="space-y-1.5">
                  <template x-for="[k,v] in importFields(data)" :key="k">
                    <div class="flex justify-between items-center">
                      <span class="text-[11px]" style="color:#475569" x-text="k"></span>
                      <span class="text-[11px] text-slate-200 font-mono font-medium" x-text="v"></span>
                    </div>
                  </template>
                </div>
              </template>
              <template x-if="typeof data!=='object' || data===null">
                <span class="text-[11px] text-slate-300 font-mono" x-text="data"></span>
              </template>
            </div>
          </template>
        </div>
        <!-- Sticky footer -->
        <div class="px-5 pb-5 pt-3 flex-shrink-0" style="border-top:1px solid rgba(51,65,85,0.25)">
          <button @click="importResult=null; loadAll()"
            class="w-full py-2.5 rounded-xl text-sm font-semibold text-white transition-all"
            style="background:linear-gradient(135deg,#1d4ed8,#2563eb); box-shadow:0 0 20px rgba(37,99,235,0.25)"
            @mouseenter="$el.style.boxShadow='0 0 28px rgba(37,99,235,0.4)'"
            @mouseleave="$el.style.boxShadow='0 0 20px rgba(37,99,235,0.25)'">
            åˆ·æ–°æ•°æ®
          </button>
        </div>
      </div>
    </div>
  </template>

  <!-- â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <template x-teleport="body">
    <div x-show="toast.msg" x-cloak class="fixed bottom-6 right-6 toast-pop" style="z-index:9999">
      <div class="px-4 py-3 rounded-xl text-sm font-medium shadow-2xl"
        :style="toast.type==='success'
          ? 'background:rgba(21,128,61,0.95); color:#dcfce7; border:1px solid rgba(34,197,94,0.3)'
          : 'background:rgba(185,28,28,0.95); color:#fee2e2; border:1px solid rgba(239,68,68,0.3)'"
        x-text="toast.msg"></div>
    </div>
  </template>

  <script>
    function app() {
      return {
        activeTab: 'inventory',
        overview: {},
        items: [],
        total: 0,
        loading: false,

        page: 1,
        pageSize: 50,
        filters: { search: '', status: '', pricedFilter: '' },
        sortBy: 'first_seen_at',
        sortOrder: 'desc',
        dualPrice: false,
        showSold: false,

        panel: null,
        manualInput: '',
        saving: false,

        importing: false,
        importProgress: -1,
        _progressTimer: null,
        importResult: null,
        lastImportAt: '',

        refreshing: false,
        refreshProgress: 0,
        _refreshPollTimer: null,

        tokenExpired: false,
        syncing: false,

        // Listing tab
        shelfTab: 'sell',
        shelfLoading: false,
        sellShelf: { items: [], total: 0 },
        leaseShelf: { items: [], total: 0 },
        rentedList: { items: [], total: 0, stats: '', page_size: 50 },
        rentedLoading: false,
        rentedPage: 1,
        subletList: { items: [], total: 0, stats: '', page_size: 50 },
        subletLoading: false,
        subletPage: 1,
        unlistedItems: { items: [], total: 0, total_inventory: 0, total_listed: 0, page_size: 50 },
        unlistedLoading: false,
        unlistedPage: 1,
        repriceModal: { show: false, item: null, newPrice: '', newLeaseUnit: '', newDeposit: '', saving: false },
        quickList: {
          assetId: '', templateId: null, mode: 'sell',
          buyPrice: 0, takeProfitRatio: 0, useUndercut: true,
          previewing: false, listing: false, preview: null,
        },

        // æ¶¨è·Œè‰²æ¨¡å¼ï¼š'cn'=çº¢æ¶¨ç»¿è·Œï¼ˆé»˜è®¤ï¼‰ 'us'=ç»¿æ¶¨çº¢è·Œ
        colorMode: 'cn',

        toast: { msg: '', type: 'success' },

        // â”€â”€ Computed page numbers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        get pageNums() {
          const total = Math.max(1, Math.ceil(this.total / this.pageSize));
          const cur = this.page;
          if (total <= 7) return Array.from({ length: total }, (_, i) => i + 1);
          if (cur <= 4) return [1, 2, 3, 4, 5, '...', total];
          if (cur >= total - 3) return [1, '...', total-4, total-3, total-2, total-1, total];
          return [1, '...', cur-1, cur, cur+1, '...', total];
        },

        // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async init() {
          await this.loadAll();
          // æ£€æŸ¥ token çŠ¶æ€
          this._checkToken();
          // å¦‚æœæœåŠ¡å™¨ä¸Šå·²æœ‰åˆ·æ–°ä»»åŠ¡åœ¨è·‘ï¼Œæ¥ç»­è½®è¯¢
          const r = await fetch('/api/youpin/market/status');
          if (r.ok) {
            const s = await r.json();
            if (s.status === 'running') {
              this.refreshing = true;
              this.refreshProgress = s.progress;
              this._startRefreshPoll();
            }
          }
        },

        async _checkToken() {
          try {
            const r = await fetch('/api/youpin/token/status');
            if (r.ok) {
              const s = await r.json();
              this.tokenExpired = !s.valid;
            }
          } catch {}
        },

        get currentShelf() {
          return this.shelfTab === 'sell' ? (this.sellShelf.items || []) : (this.leaseShelf.items || []);
        },

        async loadAll() {
          await Promise.all([this.loadOverview(), this.loadItems()]);
        },

        async loadOverview() {
          try {
            const r = await fetch('/api/dashboard/overview');
            if (r.ok) this.overview = await r.json();
          } catch {}
        },

        async loadItems() {
          this.loading = true;
          try {
            const p = new URLSearchParams({
              page: this.page,
              page_size: this.pageSize,
              sort_by: this.sortBy,
              sort_order: this.sortOrder,
            });
            if (this.filters.search)        p.set('search', this.filters.search);
            if (this.filters.status)        p.set('status', this.filters.status);
            if (this.filters.pricedFilter)  p.set('priced_filter', this.filters.pricedFilter);
            if (!this.showSold)             p.set('exclude_sold', '1');
            const r = await fetch('/api/dashboard/items?' + p);
            if (r.ok) { const d = await r.json(); this.items = d.items; this.total = d.total; }
          } catch {}
          finally { this.loading = false; }
        },

        // â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        gotoPage(p) {
          const max = Math.ceil(this.total / this.pageSize);
          if (p < 1 || p > max) return;
          this.page = p;
          this.loadItems();
          document.querySelector('.tbl-wrap')?.scrollTo({ top: 0, behavior: 'smooth' });
        },

        // â”€â”€ Sort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        setSort(col) {
          if (this.sortBy === col) this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
          else { this.sortBy = col; this.sortOrder = 'desc'; }
          this.page = 1;
          this.loadItems();
        },
        sortIcon(col) {
          if (this.sortBy !== col) return 'â†•';
          return this.sortOrder === 'asc' ? 'â†‘' : 'â†“';
        },

        // â”€â”€ Detail panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        openPanel(item) {
          this.panel = { ...item };
          this.manualInput = item.purchase_price_manual != null ? item.purchase_price_manual : '';
        },

        panelFields() {
          if (!this.panel) return [];
          const p = this.panel;
          const eff = p.effective_price != null ? 'Â¥' + this.fmt(p.effective_price) : null;
          const auto = p.purchase_price != null ? 'Â¥' + this.fmt(p.purchase_price) : null;
          const date = p.first_seen_at ? new Date(p.first_seen_at).toLocaleString('zh-CN') : null;
          return [
            ['çŠ¶æ€',       this.statusLbl(p.status),  false, false],
            ['æ¥æº',       p.class_id,                 false, false],
            ['ç£¨æŸå€¼',     p.abrade?.toFixed(10),      true,  false],
            ['è´­å…¥æ—¥æœŸ',   p.purchase_date,            false, false],
            ['è´­å…¥å¹³å°',   p.purchase_platform,        false, false],
            ['è‡ªåŠ¨è¯†åˆ«ä»·', auto,                        false, false],
            ['ç”Ÿæ•ˆä»·æ ¼',   eff, false, p.purchase_price_manual != null],
            ['é¦–æ¬¡å‘ç°',   date,                        true,  false],
          ];
        },

        async saveManual() {
          if (!this.panel) return;
          this.saving = true;
          try {
            const price = this.manualInput !== '' && this.manualInput !== null
              ? parseFloat(this.manualInput) : null;
            const r = await fetch(`/api/dashboard/items/${this.panel.id}/manual-price`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ price }),
            });
            if (!r.ok) throw new Error();
            const upd = await r.json();
            this.panel.purchase_price_manual = upd.purchase_price_manual;
            this.panel.effective_price = upd.effective_price;
            const row = this.items.find(i => i.id === this.panel.id);
            if (row) { row.purchase_price_manual = upd.purchase_price_manual; row.effective_price = upd.effective_price; }
            this.showToast('ä¿å­˜æˆåŠŸ âœ“');
            await this.loadOverview();
          } catch { this.showToast('ä¿å­˜å¤±è´¥', 'error'); }
          finally { this.saving = false; }
        },

        async clearManual() {
          this.manualInput = '';
          await this.saveManual();
        },

        // â”€â”€ Price Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async triggerRefreshPrices() {
          if (this.refreshing) return;
          this.refreshing = true;
          this.refreshProgress = 0;
          try {
            const r = await fetch('/api/dashboard/refresh-prices', { method: 'POST' });
            if (!r.ok) throw new Error(await r.text());
            const d = await r.json();
            if (!d.started && d.state?.status !== 'running') {
              this.showToast('å¯åŠ¨å¤±è´¥', 'error');
              this.refreshing = false;
              return;
            }
            this._startRefreshPoll();
          } catch (e) {
            this.refreshing = false;
            this.showToast('åˆ·æ–°å¯åŠ¨å¤±è´¥ï¼š' + e.message, 'error');
          }
        },

        _startRefreshPoll() {
          clearInterval(this._refreshPollTimer);
          this._refreshPollTimer = setInterval(async () => {
            try {
              const r = await fetch('/api/youpin/market/status');
              if (!r.ok) return;
              const s = await r.json();
              this.refreshProgress = s.progress;
              if (s.status === 'done' || s.status === 'error' || s.status === 'token_expired') {
                clearInterval(this._refreshPollTimer);
                this.refreshing = false;
                if (s.status === 'done') {
                  this.showToast('å¸‚ä»·åˆ·æ–°å®Œæˆ âœ“');
                  await this.loadAll();
                } else if (s.status === 'token_expired') {
                  this.tokenExpired = true;
                  this.showToast('Token å·²è¿‡æœŸï¼Œå¸‚ä»·åˆ·æ–°ä¸­æ–­', 'error');
                } else {
                  this.showToast('å¸‚ä»·åˆ·æ–°å¤±è´¥ï¼š' + (s.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
              }
            } catch {}
          }, 2500);
        },

        // â”€â”€ Listing tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async loadShelf() {
          this.shelfLoading = true;
          try {
            const [sr, lr] = await Promise.all([
              fetch('/api/listing/shelf/sell?page_size=100'),
              fetch('/api/listing/shelf/lease?page_size=100'),
            ]);
            if (sr.ok) this.sellShelf = await sr.json();
            if (lr.ok) this.leaseShelf = await lr.json();
          } catch {}
          finally { this.shelfLoading = false; }
        },

        async loadRentedList(page = 1) {
          this.rentedLoading = true;
          this.rentedPage = page;
          try {
            const p = new URLSearchParams({ page, page_size: 50 });
            const r = await fetch('/api/youpin/lease/live-list?' + p);
            if (r.ok) this.rentedList = await r.json();
          } catch {}
          finally { this.rentedLoading = false; }
        },

        async loadSubletList(page = 1) {
          this.subletLoading = true;
          this.subletPage = page;
          try {
            const p = new URLSearchParams({ page, page_size: 50 });
            const r = await fetch('/api/youpin/lease/sublet-list?' + p);
            if (r.ok) this.subletList = await r.json();
          } catch {}
          finally { this.subletLoading = false; }
        },

        async loadUnlistedItems(page = 1) {
          this.unlistedLoading = true;
          this.unlistedPage = page;
          try {
            const p = new URLSearchParams({ page, page_size: 50 });
            const r = await fetch('/api/listing/shelf/unlisted?' + p);
            if (r.ok) this.unlistedItems = await r.json();
          } catch {}
          finally { this.unlistedLoading = false; }
        },

        async cancelSubletOrder(orderId) {
          if (!orderId || !confirm('ç¡®è®¤å–æ¶ˆè¯¥é¥°å“çš„0CDè½¬ç§Ÿï¼Ÿå–æ¶ˆåå°†æ¢å¤ä¸ºæ™®é€šç§Ÿå‡ºçŠ¶æ€ã€‚')) return;
          try {
            const r = await fetch('/api/listing/cancel-sublet', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ order_id: orderId }),
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'å–æ¶ˆå¤±è´¥');
            this.showToast('å·²å–æ¶ˆ0CDè½¬ç§Ÿ');
            await this.loadSubletList(this.subletPage);
          } catch (e) {
            this.showToast('å–æ¶ˆå¤±è´¥ï¼š' + e.message, 'error');
          }
        },

        openReprice(item) {
          this.repriceModal = {
            show: true, item,
            newPrice: item.price ?? '',
            newLeaseUnit: item.leaseUnitPrice ?? '',
            newDeposit: item.leaseDeposit ?? '',
            saving: false,
          };
        },

        async saveReprice() {
          const { item, newPrice, newLeaseUnit, newDeposit } = this.repriceModal;
          if (!item || !item.commodityId) return;
          this.repriceModal.saving = true;
          try {
            const isLease = this.shelfTab === 'lease';
            const body = {
              commodity_id: item.commodityId,
              is_can_sold: !isLease,
              is_can_lease: isLease,
              ...(isLease
                ? { lease_unit: parseFloat(newLeaseUnit), deposit: parseFloat(newDeposit) }
                : { sell_price: parseFloat(newPrice) }),
            };
            const r = await fetch('/api/listing/reprice', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body),
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'æ”¹ä»·å¤±è´¥');
            this.showToast('æ”¹ä»·æˆåŠŸ');
            this.repriceModal.show = false;
            await this.loadShelf();
          } catch (e) {
            this.showToast('æ”¹ä»·å¤±è´¥ï¼š' + e.message, 'error');
          }
          finally { this.repriceModal.saving = false; }
        },

        // æ¶¨è·Œé¢œè‰²ï¼švalä¸ºæ­£/è´Ÿï¼Œè¿”å› Tailwind class
        pnlClass(val) {
          const up = val >= 0;
          if (this.colorMode === 'cn') return up ? 'text-red-400' : 'text-emerald-400';
          return up ? 'text-emerald-400' : 'text-red-400';
        },
        pnlClassMd(val) {
          const up = val >= 0;
          if (this.colorMode === 'cn') return up ? 'text-red-600' : 'text-emerald-600';
          return up ? 'text-emerald-600' : 'text-red-600';
        },
        pnlBg(val) {
          const up = val >= 0;
          if (this.colorMode === 'cn') return up ? 'rgba(239,68,68,0.07)' : 'rgba(16,185,129,0.07)';
          return up ? 'rgba(16,185,129,0.07)' : 'rgba(239,68,68,0.07)';
        },

        async syncTemplateIds() {
          this.syncing = true;
          try {
            const r = await fetch('/api/youpin/sync/template-ids', { method: 'POST' });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'åŒæ­¥å¤±è´¥');
            this.showToast(`æ¨¡æ¿IDåŒæ­¥å®Œæˆï¼šæ›´æ–° ${d.synced} ä»¶ï¼Œæ˜ å°„ ${d.unique_names_mapped || 0} ä¸ªå“ç±»`);
          } catch (e) {
            this.showToast('åŒæ­¥å¤±è´¥ï¼š' + e.message, 'error');
          }
          finally { this.syncing = false; }
        },

        async delistItem(commodityId) {
          if (!commodityId || !confirm('ç¡®è®¤ä¸‹æ¶è¯¥ç‰©å“ï¼Ÿ')) return;
          try {
            const r = await fetch(`/api/listing/${commodityId}`, { method: 'DELETE' });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'ä¸‹æ¶å¤±è´¥');
            this.showToast('ä¸‹æ¶æˆåŠŸ');
            await this.loadShelf();
          } catch (e) {
            this.showToast('ä¸‹æ¶å¤±è´¥ï¼š' + e.message, 'error');
          }
        },

        async previewListPrice() {
          if (!this.quickList.templateId) return;
          this.quickList.previewing = true;
          try {
            const p = new URLSearchParams({
              template_id: this.quickList.templateId,
              buy_price: this.quickList.buyPrice || 0,
              take_profit_ratio: this.quickList.takeProfitRatio || 0,
            });
            if (this.quickList.abrade) p.set('abrade', this.quickList.abrade);
            const r = await fetch('/api/listing/preview?' + p);
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'é¢„è§ˆå¤±è´¥');
            this.quickList.preview = d;
          } catch (e) {
            this.showToast('é¢„è§ˆå¤±è´¥ï¼š' + e.message, 'error');
          }
          finally { this.quickList.previewing = false; }
        },

        async smartListItem() {
          if (!this.quickList.assetId || !this.quickList.templateId) return;
          this.quickList.listing = true;
          try {
            const r = await fetch('/api/listing/smart', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                asset_id: this.quickList.assetId,
                template_id: this.quickList.templateId,
                mode: this.quickList.mode,
                buy_price: this.quickList.buyPrice || 0,
                take_profit_ratio: this.quickList.takeProfitRatio || 0,
                use_undercut: this.quickList.useUndercut,
              }),
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'ä¸Šæ¶å¤±è´¥');
            if (d.ok) {
              const priceInfo = d.sell_price ? `å‡ºå”®ä»· Â¥${this.fmt(d.sell_price)}` : `ç§Ÿé‡‘ Â¥${this.fmt(d.lease_info?.lease_unit)}/å¤©`;
              this.showToast(`ä¸Šæ¶æˆåŠŸ ${priceInfo}`);
              this.quickList.assetId = '';
              await this.loadShelf();
            } else {
              this.showToast(d.error || 'ä¸Šæ¶å¤±è´¥', 'error');
            }
          } catch (e) {
            this.showToast('ä¸Šæ¶å¤±è´¥ï¼š' + e.message, 'error');
          }
          finally { this.quickList.listing = false; }
        },

        // â”€â”€ Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async triggerImport() {
          this.importing = true;
          this.importProgress = 0;
          let elapsed = 0;
          // Asymptotic curve: approaches 80% over ~5 minutes
          this._progressTimer = setInterval(() => {
            elapsed += 300;
            this.importProgress = 80 * (1 - Math.exp(-elapsed / 250000));
          }, 300);

          try {
            const ctrl = new AbortController();
            const timer = setTimeout(() => ctrl.abort(), 12 * 60 * 1000);
            const r = await fetch('/api/youpin/import/all', { method: 'POST', signal: ctrl.signal });
            clearTimeout(timer);
            if (!r.ok) throw new Error(await r.text());
            clearInterval(this._progressTimer);
            this.importProgress = 100;
            setTimeout(() => { this.importProgress = -1; }, 700);
            const d = await r.json();
            this.importResult = d;
            this.lastImportAt = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
          } catch (e) {
            clearInterval(this._progressTimer);
            this.importProgress = -1;
            this.showToast(e.name === 'AbortError' ? 'å¯¼å…¥è¶…æ—¶ï¼Œè¯·ç¨ååˆ·æ–°' : 'å¯¼å…¥å¤±è´¥ï¼š' + e.message, 'error');
          } finally {
            this.importing = false;
          }
        },

        // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        fmt(n) {
          if (n == null) return 'â€”';
          return Number(n).toLocaleString('zh-CN', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        },
        pct(part, total) {
          if (!total || part == null) return 0;
          return Math.round(part / total * 100);
        },
        iconUrl(url, size = 62) {
          if (!url) return '';
          return `https://community.fastly.steamstatic.com/economy/image/${url}/${size}fx${size}f`;
        },
        statusLbl(s) {
          return { in_steam: 'Steamä¸­', rented_out: 'å‡ºç§Ÿä¸­', in_storage: 'æ”¶è—', sold: 'å·²å”®' }[s] || s || 'â€”';
        },
        statusCls(s) {
          return {
            in_steam:   'bg-blue-500/10 text-blue-400',
            rented_out: 'bg-green-500/10 text-green-400',
            in_storage: 'bg-purple-500/10 text-purple-400',
            sold:       'bg-slate-800 text-slate-600',
          }[s] || 'bg-slate-800 text-slate-600';
        },
        importLbl(k) {
          return { stock:'åº“å­˜ (STEAM_PROTECTED)', lease:'ç§Ÿèµ (rented_out)', buy:'è´­ä¹°è®°å½•åŒ¹é…', sell:'å‡ºå”®è®°å½•æ ‡è®°' }[k] || k;
        },
        importFields(data) {
          const lm = {
            total_fetched:'æ‹‰å–æ¡æ•°', upserted:'å†™å…¥/æ›´æ–°', skipped:'è·³è¿‡',
            total_records:'æ‹‰å–æ¡æ•°', updated:'åŒ¹é…æ›´æ–°', not_found_in_db:'æœªåœ¨åº“å­˜',
            stats:'ç§Ÿèµç»Ÿè®¡', valuation:'æ‚ æ‚ ä¼°å€¼',
          };
          return Object.entries(data)
            .filter(([k]) => !['items','not_found_names'].includes(k))
            .map(([k,v]) => [lm[k]||k, v]);
        },
        showToast(msg, type = 'success') {
          this.toast = { msg, type };
          setTimeout(() => { this.toast = { msg:'', type:'success' }; }, 3000);
        },
      };
    }
  </script>
</body>
</html>
