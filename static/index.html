<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CS2 åº“å­˜ç®¡ç†ç³»ç»Ÿ â€” CS2 Inventory Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    /* â”€â”€ Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    html { color-scheme: dark; scroll-behavior: smooth; }
    html.light { color-scheme: light; }
    [x-cloak] { display: none !important; }
    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      background: #060d1a;
      background-image:
        radial-gradient(ellipse 70% 40% at 15% 5%, rgba(59,130,246,0.07) 0%, transparent 60%),
        radial-gradient(ellipse 50% 35% at 88% 90%, rgba(139,92,246,0.06) 0%, transparent 60%),
        radial-gradient(ellipse 30% 25% at 50% 50%, rgba(16,185,129,0.02) 0%, transparent 70%);
      min-height: 100vh;
    }
    /* â”€â”€ Light theme override â€” soft azure/cyan-white â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    html.light body {
      background: linear-gradient(160deg, #ecf5ff 0%, #f0fafb 30%, #f8fafc 60%, #eef4fb 100%);
      background-attachment: fixed;
      color: #1e293b;
    }
    html.light .card {
      background: rgba(255,255,255,0.88) !important;
      border-color: rgba(186,214,235,0.55) !important;
      box-shadow: 0 1px 4px rgba(56,132,188,0.07), 0 0 0 1px rgba(186,214,235,0.2);
    }
    html.light input, html.light select, html.light textarea {
      background: #fff !important;
      color: #1e293b !important;
      border-color: #bdd6eb !important;
    }
    html.light input:focus, html.light select:focus {
      border-color: #60a5fa !important;
      box-shadow: 0 0 0 3px rgba(96,165,250,0.15) !important;
    }
    html.light input::placeholder { color: #94a3b8 !important; }
    html.light select option { background: #fff; color: #1e293b; }
    html.light .tbl-row:hover { background: rgba(224,242,254,0.5) !important; }
    html.light .tbl-row { border-color: rgba(186,214,235,0.35) !important; }
    /* Fix text colors in light mode â€” ensure contrast */
    html.light [style*="color:#334155"],
    html.light [style*="color:#475569"],
    html.light [style*="color:#1e293b"] { color: #334155 !important; }
    html.light [style*="color:#94a3b8"] { color: #64748b !important; }
    html.light [style*="color:#64748b"] { color: #475569 !important; }
    html.light .text-slate-100, html.light .text-slate-200, html.light .text-slate-300 { color: #1e293b !important; }
    html.light .text-slate-400, html.light .text-slate-500 { color: #475569 !important; }
    html.light .text-slate-600, html.light .text-slate-700 { color: #64748b !important; }
    html.light .text-white { color: #0f172a !important; }
    /* Light mode backgrounds â€” dark inline styles â†’ white/azure */
    html.light [style*="background:rgba(15,23,42"],
    html.light [style*="background:rgba(10,18,35"],
    html.light [style*="background:rgba(20,30,48"],
    html.light [style*="background:rgba(8,15,30"],
    html.light [style*="background:#0f172a"],
    html.light [style*="background:#07101f"],
    html.light [style*="background:#080f1d"],
    html.light [style*="background:#0d1829"] { background: #fff !important; }
    html.light [style*="background:rgba(51,65,85,0.3)"],
    html.light [style*="background:rgba(51,65,85,0.2)"] { background: rgba(186,214,235,0.3) !important; }
    html.light [style*="border-color:rgba(51,65,85"] { border-color: rgba(186,214,235,0.5) !important; }
    html.light [style*="background: rgba(6,13,26"],
    html.light nav[style*="background: rgba(20,30,48"] {
      background: rgba(240,249,255,0.92) !important;
      border-color: rgba(186,214,235,0.5) !important;
      backdrop-filter: blur(20px) saturate(1.3);
    }
    html.light th { color: #475569 !important; }
    html.light thead th { background: #f0f7ff !important; }
    html.light .bg-slate-700 { background-color: #3b82f6 !important; }
    html.light .bg-slate-800 { background-color: #e0f2fe !important; }
    /* Light mode stat card hover */
    html.light .stat-card:hover { box-shadow: 0 8px 30px rgba(56,132,188,0.12) !important; }
    /* Light mode side panel */
    html.light [style*="background:#07101f"] { background: #f8fbff !important; }
    /* Light mode pill toggles */
    html.light .pill-toggle { background: rgba(240,249,255,0.8); border-color: rgba(186,214,235,0.5); color: #475569; }
    html.light .pill-toggle:hover { border-color: #93c5fd; color: #1e40af; }
    html.light .pill-toggle.active-blue { background: rgba(59,130,246,0.1); border-color: rgba(59,130,246,0.35); color: #1d4ed8; }
    /* Light mode pagination */
    html.light .pg-btn { background: #fff; border-color: rgba(186,214,235,0.5); color: #475569; }
    html.light .pg-btn:hover:not(:disabled) { color: #1e40af; border-color: #93c5fd; }
    html.light .pg-btn.active { background: linear-gradient(135deg,#2563eb,#3b82f6); color: #fff; }
    /* Light mode tooltip */
    html.light .info-tip .tip-text { background: #fff; color: #475569; border-color: rgba(186,214,235,0.5); box-shadow: 0 4px 16px rgba(56,132,188,0.12); }
    /* Light mode header background */
    html.light header.sticky { background: rgba(240,249,255,0.92) !important; border-bottom-color: rgba(186,214,235,0.5) !important; }
    /* Light modal overlays */
    html.light [style*="background:#0f172a"] { background: #f8fbff !important; }

    /* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(71,85,105,0.5); border-radius: 2px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(100,116,139,0.7); }

    /* â”€â”€ Form controls â€” force dark everywhere â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    input, select, textarea {
      background: rgba(8, 15, 30, 0.85) !important;
      color: #cbd5e1 !important;
      border-color: rgba(51,65,85,0.7) !important;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    input::placeholder { color: #475569 !important; }
    input:focus, select:focus {
      border-color: rgba(59,130,246,0.5) !important;
      box-shadow: 0 0 0 3px rgba(59,130,246,0.08) !important;
      outline: none !important;
    }
    select option { background: #0d1829; color: #cbd5e1; }

    /* Custom select arrow */
    select {
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") !important;
      background-repeat: no-repeat !important;
      background-position: right 10px center !important;
      padding-right: 30px !important;
    }

    /* â”€â”€ Info tooltip (CSS-based, works on mobile) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .info-tip { position: relative; display: inline-block; cursor: help; }
    .info-tip .tip-text {
      visibility: hidden; opacity: 0;
      position: absolute; z-index: 100;
      bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%);
      width: 220px; padding: 8px 10px;
      background: #0f172a; color: #94a3b8; border: 1px solid rgba(51,65,85,0.6);
      border-radius: 8px; font-size: 10px; line-height: 1.4;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      transition: opacity 0.15s, visibility 0.15s;
      pointer-events: none; text-align: left; font-weight: normal;
    }
    .info-tip:hover .tip-text { visibility: visible; opacity: 1; }
    html.light .info-tip .tip-text { background: #fff; color: #475569; border-color: #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

    /* â”€â”€ Top import progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #progress-bar {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 2px;
      z-index: 99999;
      transform-origin: left center;
      background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
      background-size: 200% 100%;
      animation: shimmer 1.8s linear infinite;
      transition: transform 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.5s;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* â”€â”€ Glass card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: rgba(10, 18, 35, 0.7);
      border: 1px solid rgba(51,65,85,0.4);
      border-radius: 16px;
      backdrop-filter: blur(16px);
    }

    /* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tbl-wrap {
      max-height: calc(100vh - 310px);
      overflow-y: auto;
      overflow-x: auto;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #080f1d;
      z-index: 5;
      white-space: nowrap;
    }
    .tbl-row {
      border-bottom: 1px solid rgba(51,65,85,0.15);
      transition: background 0.15s, box-shadow 0.15s;
      cursor: pointer;
    }
    .tbl-row:hover {
      background: rgba(59,130,246,0.07);
      box-shadow: inset 3px 0 0 rgba(99,102,241,0.55), 0 1px 10px rgba(0,0,0,0.22);
    }

    /* â”€â”€ Stat card hover â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stat-card { transition: transform 0.2s, box-shadow 0.2s; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0,0,0,0.4); }

    /* â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .fade-up { animation: fadeUp 0.22s ease both; }

    @keyframes slideRight {
      from { opacity: 0; transform: translateX(100%); }
      to   { opacity: 1; transform: translateX(0); }
    }
    .slide-right { animation: slideRight 0.22s cubic-bezier(0.16,1,0.3,1) both; }

    @keyframes toastPop {
      from { opacity: 0; transform: translateY(10px) scale(0.95); }
      to   { opacity: 1; transform: translateY(0) scale(1); }
    }
    .toast-pop { animation: toastPop 0.18s ease both; }

    /* â”€â”€ Filter pill toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pill-toggle {
      display: flex; align-items: center; gap: 8px;
      padding: 7px 12px; border-radius: 10px;
      border: 1px solid rgba(51,65,85,0.5);
      cursor: pointer; transition: all 0.15s;
      font-size: 12px; color: #64748b;
      background: rgba(8,15,30,0.6);
      user-select: none;
    }
    .pill-toggle:hover { border-color: rgba(71,85,105,0.7); color: #94a3b8; }
    .pill-toggle.active-blue { border-color: rgba(59,130,246,0.4); background: rgba(59,130,246,0.08); color: #93c5fd; }
    .pill-toggle.active-slate { border-color: rgba(100,116,139,0.4); background: rgba(100,116,139,0.1); color: #94a3b8; }

    .toggle-track {
      width: 28px; height: 16px; border-radius: 8px;
      transition: background 0.2s; flex-shrink: 0;
    }
    .toggle-thumb {
      width: 12px; height: 12px; border-radius: 50%; background: #fff;
      transition: transform 0.2s; position: absolute; top: 2px; left: 2px;
    }

    /* â”€â”€ Pagination button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pg-btn {
      min-width: 28px; height: 28px; border-radius: 8px; font-size: 12px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s; border: 1px solid rgba(51,65,85,0.3);
      background: rgba(20,30,48,0.7); color: #64748b; cursor: pointer;
    }
    .pg-btn:hover:not(:disabled) { color: #cbd5e1; border-color: rgba(71,85,105,0.6); }
    .pg-btn.active {
      background: linear-gradient(135deg, #1d4ed8, #2563eb);
      border-color: rgba(37,99,235,0.5);
      color: #fff; font-weight: 600;
      box-shadow: 0 0 14px rgba(37,99,235,0.3);
    }
    .pg-btn:disabled { opacity: 0.25; cursor: not-allowed; }
  </style>
</head>

<body x-data="app()" x-init="init()" class="text-slate-300 antialiased">

  <!-- â”€â”€ Top progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="progress-bar" x-show="importProgress >= 0" x-cloak
    :style="`transform: scaleX(${importProgress / 100}); opacity: ${importProgress >= 100 ? 0 : 1}`"></div>

  <!-- â”€â”€ Navbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header class="sticky top-0 z-40"
    style="background: rgba(6,13,26,0.88); backdrop-filter: blur(20px) saturate(1.2); border-bottom: 1px solid rgba(51,65,85,0.25);">
    <div class="max-w-[1800px] mx-auto px-6 h-14 flex items-center gap-3">

      <!-- Logo -->
      <div class="flex items-center gap-2.5 mr-3 flex-shrink-0">
        <img src="https://cdn.cloudflare.steamstatic.com/apps/csgo/images/csgo_react/global/logo_cs_sm.svg"
          alt="CS2" class="h-7 w-auto opacity-90" onerror="this.style.display='none'" />
        <div class="hidden sm:block">
          <p class="text-sm font-bold text-white leading-tight tracking-tight" x-text="nameLang==='cn'?'CS2 åº“å­˜ç®¡ç†ç³»ç»Ÿ':'CS2 Inventory Manager'"></p>
          <p class="text-[10px] text-slate-600 leading-tight" x-text="nameLang==='cn'?'é‡åŒ–äº¤æ˜“ Â· æ™ºèƒ½ç®¡ç†':'Quantitative Trading Â· Smart Management'"></p>
        </div>
      </div>

      <!-- Tabs -->
      <nav class="flex gap-0.5 p-1 rounded-xl" style="background: rgba(20,30,48,0.7); border: 1px solid rgba(51,65,85,0.3)">
        <button @click="activeTab='inventory'"
          class="px-3.5 py-1.5 rounded-lg text-xs font-medium transition-all duration-150"
          :class="activeTab==='inventory' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300'"
          x-text="t('tab_inventory')"></button>
        <button @click="activeTab='overview'"
          class="px-3.5 py-1.5 rounded-lg text-xs font-medium transition-all duration-150"
          :class="activeTab==='overview' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300'"
          x-text="t('tab_overview')"></button>
        <button @click="activeTab='listing'; loadShelf()"
          class="px-3.5 py-1.5 rounded-lg text-xs font-medium transition-all duration-150"
          :class="activeTab==='listing' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300'"
          x-text="t('tab_listing')"></button>
        <button @click="activeTab='analysis'; loadAnalysis()"
          class="px-3.5 py-1.5 rounded-lg text-xs font-medium transition-all duration-150 relative"
          :class="activeTab==='analysis' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-500 hover:text-slate-300'">
          <span x-text="t('tab_analysis')"></span>
          <span x-show="unreadAlertCount>0" x-cloak
            class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-[9px] text-white flex items-center justify-center font-bold"
            x-text="unreadAlertCount>9?'9+':unreadAlertCount"></span>
        </button>
      </nav>

      <!-- Right side -->
      <div class="ml-auto flex items-center gap-3">
        <!-- Global toggles -->
        <div class="flex items-center gap-1.5">
          <button @click="nameLang = nameLang==='cn' ? 'en' : 'cn'"
            class="px-2 py-1 rounded-lg text-[10px] transition-all"
            :style="nameLang==='en' ? 'background:rgba(59,130,246,0.12);color:#60a5fa' : 'background:rgba(51,65,85,0.2);color:#64748b'"
            x-text="nameLang==='cn' ? 'ä¸­' : 'EN'"></button>
          <button @click="toggleTheme()"
            class="px-2 py-1 rounded-lg text-[10px] transition-all"
            :style="theme==='light' ? 'background:rgba(251,191,36,0.15);color:#fbbf24' : 'background:rgba(51,65,85,0.2);color:#64748b'"
            x-text="theme==='light' ? 'â˜€' : 'ğŸŒ™'"></button>
        </div>
        <!-- Import status -->
        <div x-show="importing" x-cloak class="flex items-center gap-2 text-xs text-slate-500">
          <span class="w-1.5 h-1.5 rounded-full bg-blue-400 animate-pulse inline-block"></span>
          <span x-text="t('syncing_wait')"></span>
        </div>
        <span x-show="lastImportAt && !importing" x-cloak class="text-[11px] text-slate-700 hidden md:block">
          <span x-text="t('last_sync')"></span> <span class="text-slate-500" x-text="lastImportAt"></span>
        </span>

        <!-- Refresh Prices button -->
        <div class="flex items-center gap-2">
          <button @click="triggerRefreshPrices()" :disabled="refreshing"
            class="flex items-center gap-1.5 px-3 py-2 rounded-xl text-xs font-medium transition-all duration-150 disabled:opacity-40 disabled:cursor-not-allowed"
            style="background: rgba(16,185,129,0.12); border: 1px solid rgba(16,185,129,0.2); color:#6ee7b7"
            @mouseenter="if(!refreshing) $el.style.background='rgba(16,185,129,0.2)'"
            @mouseleave="$el.style.background='rgba(16,185,129,0.12)'">
            <svg class="w-3 h-3 flex-shrink-0" :class="refreshing?'animate-spin':''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span x-show="!refreshing" x-text="t('btn_refresh_price')"></span>
            <span x-show="refreshing" x-cloak x-text="refreshProgress + '%'"></span>
          </button>
          <span x-show="overview.price_updated_at && !refreshing" x-cloak
            class="text-[10px] text-slate-700 hidden lg:block">
            <span x-text="t('market_price')"></span> <span class="text-slate-600" x-text="overview.price_updated_at"></span>
          </span>
        </div>

        <!-- æ‚ æ‚ ç™»å½•çŠ¶æ€ -->
        <div class="flex items-center gap-1.5">
          <template x-if="authState.has_token && authState.nickname">
            <span class="px-2 py-1 rounded-lg text-[11px]"
              style="background:rgba(34,197,94,0.1);color:#4ade80;border:1px solid rgba(34,197,94,0.15)">
              <span x-text="authState.nickname"></span>
              <span class="text-emerald-700 ml-1" x-text="authState.token_source==='sms' ? '(APP)' : '(ENV)'"></span>
            </span>
          </template>
          <button @click="loginModal.show=true"
            class="flex items-center gap-1 px-2.5 py-1.5 rounded-xl text-[11px] font-medium transition-all"
            :style="authState.has_token ? 'background:rgba(51,65,85,0.2);color:#64748b;border:1px solid rgba(51,65,85,0.3)' : 'background:rgba(234,179,8,0.12);color:#fbbf24;border:1px solid rgba(234,179,8,0.2)'">
            <span x-text="authState.has_token ? t('btn_switch_account') : t('btn_login_youpin')"></span>
          </button>
        </div>

        <!-- æ¶¨è·Œé¢œè‰² toggle (åŠåœ†åˆ‡æ¢) -->
        <button @click="colorMode = colorMode==='cn' ? 'us' : 'cn'"
          class="w-5 h-5 rounded-full overflow-hidden flex-shrink-0 transition-transform hover:scale-110"
          :title="colorMode==='cn' ? t('color_cn_tip') : t('color_us_tip')"
          :style="colorMode==='cn'
            ? 'background:linear-gradient(135deg, #ef4444 50%, #10b981 50%)'
            : 'background:linear-gradient(135deg, #10b981 50%, #ef4444 50%)'">
        </button>

        <!-- ä¼šå‘˜ç­‰çº§: é»˜è®¤V3, å·²ç§»åˆ°å†…éƒ¨é…ç½® -->

        <!-- Import button -->
        <button @click="triggerImport()" :disabled="importing"
          class="flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium transition-all duration-150 disabled:opacity-40 disabled:cursor-not-allowed text-white"
          style="background: linear-gradient(135deg,#1d4ed8,#2563eb); box-shadow: 0 0 20px rgba(37,99,235,0.3);"
          @mouseenter="$el.style.boxShadow='0 0 28px rgba(37,99,235,0.5)'"
          @mouseleave="$el.style.boxShadow='0 0 20px rgba(37,99,235,0.3)'">
          <svg class="w-3.5 h-3.5 flex-shrink-0" :class="importing?'animate-spin':''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          <span x-text="importing ? t('btn_syncing') : t('btn_sync')"></span>
        </button>
      </div>
    </div>
  </header>

  <!-- â”€â”€ æ”¹ä»·æ¨¡æ€æ¡† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <template x-teleport="body">
    <div x-show="repriceModal.show" x-cloak
      class="fixed inset-0 z-50 flex items-center justify-center p-4"
      style="background:rgba(0,0,0,0.6); backdrop-filter:blur(4px)"
      @keydown.escape.window="repriceModal.show=false">
      <div class="w-full max-w-sm rounded-2xl p-6" style="background:#0f172a; border:1px solid rgba(51,65,85,0.5)">
        <p class="text-slate-300 font-medium mb-1 truncate" x-text="repriceModal.item?.commodityHashName || repriceModal.item?.name || t('reprice_title')"></p>
        <p class="text-[11px] text-slate-600 mb-4">
          CommodityId: <span x-text="repriceModal.item?.commodityId"></span>
          <span x-show="repriceModal.isSublet" class="ml-2 px-1.5 py-0.5 rounded text-[10px]" style="background:rgba(234,179,8,0.1);color:#fbbf24" x-text="t('subletting')+'â†’'+t('btn_reprice')"></span>
        </p>

        <!-- Sell price -->
        <template x-if="shelfTab==='sell' && !repriceModal.isSublet">
          <div class="mb-4">
            <label class="block text-[11px] text-slate-600 mb-1" x-text="t('sell_price_label')"></label>
            <input x-model.number="repriceModal.newPrice" type="number" step="0.01" min="0.01"
              class="w-full px-3 py-2 rounded-xl text-sm border" placeholder="0.01"/>
          </div>
        </template>

        <!-- Lease prices -->
        <template x-if="shelfTab==='lease' || repriceModal.isSublet">
          <div class="space-y-3 mb-4">
            <div>
              <label class="block text-[11px] text-slate-600 mb-1" x-text="t('short_rent_label')"></label>
              <input x-model.number="repriceModal.newLeaseUnit" type="number" step="0.01" min="0.01"
                class="w-full px-3 py-2 rounded-xl text-sm border" placeholder="0.01"/>
            </div>
            <div>
              <label class="block text-[11px] text-slate-600 mb-1" x-text="t('long_rent_label')"></label>
              <input x-model.number="repriceModal.newLongLeaseUnit" type="number" step="0.01" min="0.01"
                class="w-full px-3 py-2 rounded-xl text-sm border" :placeholder="t('long_rent_hint')"/>
            </div>
            <div>
              <label class="block text-[11px] text-slate-600 mb-1" x-text="t('deposit_label')"></label>
              <input x-model.number="repriceModal.newDeposit" type="number" step="0.01" min="0"
                class="w-full px-3 py-2 rounded-xl text-sm border" placeholder="0"/>
            </div>
          </div>
        </template>

        <div class="flex gap-3">
          <button @click="repriceModal.show=false"
            class="flex-1 py-2 rounded-xl text-sm transition-all"
            style="background:rgba(51,65,85,0.3); color:#94a3b8" x-text="t('btn_cancel')"></button>
          <button @click="saveReprice()" :disabled="repriceModal.saving"
            class="flex-1 py-2 rounded-xl text-sm font-medium text-white transition-all disabled:opacity-40"
            style="background:linear-gradient(135deg,#6366f1,#4f46e5)">
            <span x-show="!repriceModal.saving" x-text="t('btn_confirm_reprice')"></span>
            <span x-show="repriceModal.saving" x-cloak x-text="t('saving_text')"></span>
          </button>
        </div>
      </div>
    </div>
  </template>

  <!-- â”€â”€ ç™»å½•æ¨¡æ€æ¡† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <template x-teleport="body">
    <div x-show="loginModal.show" x-cloak
      class="fixed inset-0 z-50 flex items-center justify-center p-4"
      style="background:rgba(0,0,0,0.6);backdrop-filter:blur(4px)"
      @keydown.escape.window="loginModal.show=false">
      <div class="w-full max-w-sm rounded-2xl p-6" style="background:#0f172a;border:1px solid rgba(51,65,85,0.5)">
        <p class="text-slate-200 font-medium mb-4" x-text="t('login_title')"></p>
        <p class="text-[11px] text-slate-600 mb-4" x-text="t('login_desc')"></p>

        <div class="space-y-3 mb-4">
          <div>
            <label class="block text-[11px] text-slate-600 mb-1" x-text="t('phone_label')"></label>
            <div class="flex gap-2">
              <span class="flex items-center px-2 text-xs text-slate-500" style="background:rgba(51,65,85,0.3);border-radius:0.75rem">+86</span>
              <input x-model="loginModal.phone" type="tel" :placeholder="t('phone_label')"
                class="flex-1 px-3 py-2 rounded-xl text-sm border" />
            </div>
          </div>
          <div class="flex gap-2">
            <div class="flex-1">
              <label class="block text-[11px] text-slate-600 mb-1" x-text="t('code_label')"></label>
              <input x-model="loginModal.code" type="text" :placeholder="t('code_label')"
                class="w-full px-3 py-2 rounded-xl text-sm border" />
            </div>
            <div class="flex items-end">
              <button @click="sendSmsCode()" :disabled="loginModal.smsSending || loginModal.cooldown > 0"
                class="px-3 py-2 rounded-xl text-xs font-medium transition-all disabled:opacity-40"
                style="background:rgba(59,130,246,0.12);color:#60a5fa;border:1px solid rgba(59,130,246,0.2)">
                <span x-show="loginModal.cooldown <= 0" x-text="loginModal.smsSending ? t('sending_code') : t('btn_send_code')"></span>
                <span x-show="loginModal.cooldown > 0" x-text="loginModal.cooldown + 's'"></span>
              </button>
            </div>
          </div>
        </div>

        <div class="flex gap-3">
          <button @click="loginModal.show=false"
            class="flex-1 py-2 rounded-xl text-sm transition-all"
            style="background:rgba(51,65,85,0.3);color:#94a3b8" x-text="t('btn_cancel')"></button>
          <button @click="doSmsLogin()" :disabled="loginModal.logging || !loginModal.code"
            class="flex-1 py-2 rounded-xl text-sm font-medium text-white transition-all disabled:opacity-40"
            style="background:linear-gradient(135deg,#f59e0b,#d97706)">
            <span x-show="!loginModal.logging" x-text="t('btn_login')"></span>
            <span x-show="loginModal.logging" x-cloak x-text="t('logging_in')"></span>
          </button>
        </div>

        <!-- Manual token input -->
        <div class="mt-4 pt-4 border-t" style="border-color:rgba(51,65,85,0.3)">
          <p class="text-[11px] text-slate-600 mb-2" x-text="t('manual_token_desc')"></p>
          <div class="flex gap-2">
            <input x-model="loginModal.manualToken" type="text" placeholder="Bearer Tokenâ€¦"
              class="flex-1 px-3 py-2 rounded-xl text-xs border font-mono" style="background:rgba(15,23,42,0.8);border-color:rgba(51,65,85,0.3);color:#94a3b8" />
            <button @click="applyManualToken()" :disabled="!loginModal.manualToken"
              class="px-3 py-2 rounded-xl text-xs font-medium text-white transition-all disabled:opacity-40"
              style="background:rgba(16,185,129,0.2);color:#34d399;border:1px solid rgba(16,185,129,0.3)" x-text="t('btn_apply')"></button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- â”€â”€ Token è¿‡æœŸè­¦å‘Šæ¨ªå¹… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <template x-teleport="body">
    <div x-show="tokenExpired" x-cloak
      class="fixed top-14 left-0 right-0 z-30 flex items-center justify-between px-6 py-2.5 text-sm"
      style="background: rgba(185,28,28,0.95); border-bottom: 1px solid rgba(239,68,68,0.4);">
      <div class="flex items-center gap-2.5">
        <svg class="w-4 h-4 text-red-300 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <span class="text-red-100 font-medium" x-text="t('token_expired_msg')"></span>
        <span class="text-red-300 text-xs" x-text="t('token_expired_hint')"></span>
      </div>
      <button @click="tokenExpired=false" class="text-red-300 hover:text-white text-lg leading-none ml-4">âœ•</button>
    </div>
  </template>

  <!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main class="max-w-[1800px] mx-auto px-6 py-6" :class="tokenExpired ? 'pt-14' : ''"  >

    <!-- â•â•â•â•â•â•â•â•â•â•â•â• OVERVIEW TAB â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div x-show="activeTab==='overview'" class="fade-up">

      <!-- Stat cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-5">

        <!-- Total cost -->
        <div class="card stat-card p-5 relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 rounded-full pointer-events-none"
            style="background: radial-gradient(circle, rgba(59,130,246,0.08), transparent 70%)"></div>
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2" x-text="t('total_cost')"></p>
          <p class="text-3xl font-bold text-white mb-1">Â¥<span x-text="fmt(overview.total_cost)">â€”</span></p>
          <div class="flex gap-3 text-[11px] text-slate-700 mb-3">
            <span><span x-text="t('cost_rented')"></span> Â¥<span x-text="fmt(overview.cost_breakdown?.rented_out)"></span></span>
            <span>Â·</span>
            <span><span x-text="t('cost_steam')"></span> Â¥<span x-text="fmt(overview.cost_breakdown?.in_steam)"></span></span>
          </div>
          <div class="h-1 rounded-full overflow-hidden" style="background: rgba(51,65,85,0.4)">
            <div class="h-full rounded-full transition-all duration-1000"
              style="background: linear-gradient(90deg,#3b82f6,#8b5cf6)"
              :style="'width:' + (overview.coverage_pct||0) + '%'"></div>
          </div>
          <p class="text-[11px] text-slate-700 mt-1.5"><span x-text="t('price_coverage')"></span>
            <span class="text-blue-400 font-medium" x-text="(overview.coverage_pct||0) + '%'"></span>
          </p>
        </div>

        <!-- Active breakdown -->
        <div class="card stat-card p-5">
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2" x-text="t('active_holdings')"></p>
          <p class="text-3xl font-bold text-white mb-3" x-text="overview.total_active ?? 'â€”'"></p>
          <div class="space-y-1.5">
            <div class="flex justify-between items-center text-xs">
              <span class="text-slate-500 flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span><span x-text="t('status_rented')"></span>
              </span>
              <span class="font-mono font-semibold text-green-300" x-text="overview.status_breakdown?.rented_out ?? 0"></span>
            </div>
            <div class="flex justify-between items-center text-xs">
              <span class="text-slate-500 flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span><span x-text="t('status_steam')"></span>
              </span>
              <span class="font-mono font-semibold text-blue-300" x-text="overview.status_breakdown?.in_steam ?? 0"></span>
            </div>
            <div class="flex justify-between items-center text-xs">
              <span class="text-slate-500 flex items-center gap-1.5">
                <span class="w-1.5 h-1.5 rounded-full bg-purple-400"></span><span x-text="t('status_storage')"></span>
              </span>
              <span class="font-mono font-semibold text-purple-300" x-text="overview.status_breakdown?.in_storage ?? 0"></span>
            </div>
            <div class="flex justify-between items-center text-xs pt-1.5" style="border-top: 1px solid rgba(51,65,85,0.3)">
              <span class="text-slate-700" x-text="t('status_sold')"></span>
              <span class="font-mono text-slate-700" x-text="overview.status_breakdown?.sold ?? 0"></span>
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="card stat-card p-5">
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2" x-text="t('pricing_status')"></p>
          <p class="text-3xl font-bold text-white mb-3" x-text="overview.priced_count ?? 'â€”'"></p>
          <div class="space-y-1.5">
            <div class="flex justify-between items-center text-xs">
              <span class="text-slate-500" x-text="t('auto_priced')"></span>
              <span class="font-mono text-slate-300" x-text="(overview.priced_count??0)-(overview.manual_price_count??0)"></span>
            </div>
            <div class="flex justify-between items-center text-xs">
              <span class="text-yellow-500/70" x-text="t('manual_priced')"></span>
              <span class="font-mono text-yellow-300 font-semibold" x-text="overview.manual_price_count ?? 0"></span>
            </div>
            <div class="flex justify-between items-center text-xs pt-1.5" style="border-top: 1px solid rgba(51,65,85,0.3)">
              <span class="text-red-500/60" x-text="t('unpriced')"></span>
              <span class="font-mono text-red-400" x-text="overview.unpriced_count ?? 0"></span>
            </div>
          </div>
        </div>

        <!-- Quick actions -->
        <div class="card stat-card p-5 flex flex-col gap-2">
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-1" x-text="t('quick_actions')"></p>
          <button @click="activeTab='inventory'; filters.status=''; showSold=false; filters.pricedFilter='unpriced'; page=1; loadItems()"
            class="w-full text-left px-3 py-2.5 rounded-xl text-xs transition-all duration-150"
            style="background: rgba(239,68,68,0.07); border: 1px solid rgba(239,68,68,0.15); color: #fca5a5;"
            @mouseenter="$el.style.background='rgba(239,68,68,0.13)'"
            @mouseleave="$el.style.background='rgba(239,68,68,0.07)'">
            â†’ <span x-text="t('goto_unpriced')"></span> (<span x-text="overview.unpriced_count??0"></span>)
          </button>
          <button @click="activeTab='inventory'; filters.status='rented_out'; showSold=false; page=1; loadItems()"
            class="w-full text-left px-3 py-2.5 rounded-xl text-xs transition-all duration-150"
            style="background: rgba(34,197,94,0.07); border: 1px solid rgba(34,197,94,0.15); color: #86efac;"
            @mouseenter="$el.style.background='rgba(34,197,94,0.13)'"
            @mouseleave="$el.style.background='rgba(34,197,94,0.07)'">
            â†’ <span x-text="t('goto_rented')"></span> (<span x-text="overview.status_breakdown?.rented_out??0"></span>)
          </button>
          <button @click="activeTab='inventory'; filters.status=''; showSold=false; filters.pricedFilter=''; page=1; loadItems()"
            class="w-full text-left px-3 py-2.5 rounded-xl text-xs transition-all duration-150"
            style="background: rgba(71,85,105,0.15); border: 1px solid rgba(71,85,105,0.25); color: #94a3b8;"
            @mouseenter="$el.style.background='rgba(71,85,105,0.25)'"
            @mouseleave="$el.style.background='rgba(71,85,105,0.15)'">
            â†’ <span x-text="t('goto_all')"></span>
          </button>
        </div>
      </div>

      <!-- P&L row -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">

        <!-- Market Value -->
        <div class="card stat-card p-5 relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 rounded-full pointer-events-none"
            style="background: radial-gradient(circle, rgba(16,185,129,0.07), transparent 70%)"></div>
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2" x-text="t('market_value')"></p>
          <template x-if="overview.market_value > 0">
            <div>
              <p class="text-3xl font-bold text-emerald-300 mb-1">Â¥<span x-text="fmt(overview.market_value)"></span></p>
              <div class="space-y-1 mb-1">
                <div class="flex justify-between text-[11px]">
                  <span class="text-slate-600" x-text="t('inv_value')"></span>
                  <span class="text-blue-300 font-mono">Â¥<span x-text="fmt(overview.market_value_steam??0)"></span></span>
                </div>
                <div class="flex justify-between text-[11px]">
                  <span class="text-slate-600" x-text="t('rented_value')"></span>
                  <span class="text-green-300 font-mono">Â¥<span x-text="fmt(overview.market_value_rented??0)"></span></span>
                </div>
              </div>
              <p class="text-[11px] text-slate-700">
                <span x-text="t('covers')"></span> <span class="text-emerald-500/70" x-text="overview.market_priced_count ?? 0"></span> <span x-text="t('items_unit')"></span>
                / <span x-text="t('total_items')"></span> <span x-text="overview.total_active ?? 0"></span> <span x-text="t('items_unit')"></span>
              </p>
              <p class="text-[10px] mt-1" style="color:#1e3a5f">
                â“˜ <span x-text="t('rented_value_note')"></span>
              </p>
            </div>
          </template>
          <template x-if="!overview.market_value">
            <div>
              <p class="text-2xl font-bold text-slate-700 mb-1" x-text="t('no_market_price')"></p>
              <p class="text-[11px] text-slate-700" x-text="t('click_refresh')"></p>
            </div>
          </template>
        </div>

        <!-- P&L -->
        <div class="card stat-card p-5 relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 rounded-full pointer-events-none"
            :style="overview.pnl != null ? 'background: radial-gradient(circle, ' + pnlBg(overview.pnl) + ', transparent 70%)' : ''"></div>
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2" x-text="t('pnl_amount')"></p>
          <template x-if="overview.pnl != null">
            <div>
              <p class="text-3xl font-bold mb-1" :class="pnlClass(overview.pnl)">
                <span x-text="overview.pnl >= 0 ? '+Â¥' : '-Â¥'"></span><span x-text="fmt(Math.abs(overview.pnl))"></span>
              </p>
              <p class="text-[11px] text-slate-700" x-text="t('based_on_estimate')"></p>
            </div>
          </template>
          <template x-if="overview.pnl == null">
            <div>
              <p class="text-2xl font-bold text-slate-700 mb-1">â€”</p>
              <p class="text-[11px] text-slate-700" x-text="t('need_data')"></p>
            </div>
          </template>
        </div>

        <!-- P&L% -->
        <div class="card stat-card p-5 relative overflow-hidden">
          <div class="absolute -top-10 -right-10 w-40 h-40 rounded-full pointer-events-none"
            :style="overview.pnl_pct != null ? 'background: radial-gradient(circle, ' + pnlBg(overview.pnl_pct) + ', transparent 70%)' : ''"></div>
          <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-2" x-text="t('pnl_rate')"></p>
          <template x-if="overview.pnl_pct != null">
            <div>
              <p class="text-3xl font-bold mb-1" :class="pnlClass(overview.pnl_pct)">
                <span x-text="(overview.pnl_pct >= 0 ? '+' : '') + overview.pnl_pct + '%'"></span>
              </p>
              <div class="flex items-center gap-2 mt-2">
                <div class="flex-1 h-1 rounded-full overflow-hidden" style="background: rgba(51,65,85,0.4)">
                  <div class="h-full rounded-full transition-all duration-1000"
                    :style="'width:' + Math.min(Math.abs(overview.pnl_pct ?? 0), 100) + '%; background:' + (colorMode==='cn' ? (overview.pnl_pct >= 0 ? 'linear-gradient(90deg,#ef4444,#dc2626)' : 'linear-gradient(90deg,#10b981,#059669)') : (overview.pnl_pct >= 0 ? 'linear-gradient(90deg,#10b981,#059669)' : 'linear-gradient(90deg,#ef4444,#dc2626)'))"></div>
                </div>
              </div>
            </div>
          </template>
          <template x-if="overview.pnl_pct == null">
            <div>
              <p class="text-2xl font-bold text-slate-700 mb-1">â€”</p>
              <p class="text-[11px] text-slate-700" x-text="t('wait_refresh')"></p>
            </div>
          </template>
        </div>
      </div>

      <!-- Distribution bar -->
      <div class="card p-5">
        <p class="text-[11px] text-slate-600 uppercase tracking-widest mb-4" x-text="t('status_distribution')"></p>
        <div class="flex h-3 rounded-full overflow-hidden gap-0.5" x-show="overview.total_active > 0">
          <div class="rounded-sm transition-all duration-1000"
            style="background: linear-gradient(90deg,#22c55e,#16a34a)"
            :style="'width:'+pct(overview.status_breakdown?.rented_out,overview.total_active)+'%'"></div>
          <div class="rounded-sm transition-all duration-1000"
            style="background: linear-gradient(90deg,#3b82f6,#2563eb)"
            :style="'width:'+pct(overview.status_breakdown?.in_steam,overview.total_active)+'%'"></div>
          <div class="rounded-sm transition-all duration-1000"
            style="background: linear-gradient(90deg,#a855f7,#7c3aed)"
            :style="'width:'+pct(overview.status_breakdown?.in_storage,overview.total_active)+'%'"></div>
        </div>
        <div class="flex flex-wrap gap-x-6 gap-y-1 mt-3 text-xs text-slate-600">
          <span><span class="text-green-400">â—</span> <span x-text="t('status_rented')"></span>
            <span class="font-mono text-green-300 ml-1" x-text="overview.status_breakdown?.rented_out??0"></span>
            (<span x-text="pct(overview.status_breakdown?.rented_out,overview.total_active)+'%'"></span>)
          </span>
          <span><span class="text-blue-400">â—</span> <span x-text="t('status_steam')"></span>
            <span class="font-mono text-blue-300 ml-1" x-text="overview.status_breakdown?.in_steam??0"></span>
            (<span x-text="pct(overview.status_breakdown?.in_steam,overview.total_active)+'%'"></span>)
          </span>
          <span><span class="text-purple-400">â—</span> <span x-text="t('status_storage')"></span>
            <span class="font-mono text-purple-300 ml-1" x-text="overview.status_breakdown?.in_storage??0"></span>
            (<span x-text="pct(overview.status_breakdown?.in_storage,overview.total_active)+'%'"></span>)
          </span>
        </div>
      </div>

      <!-- Portfolio Value Trend Chart -->
      <div class="card p-5 mt-5">
        <div class="flex items-center justify-between mb-4">
          <p class="text-[11px] text-slate-600 uppercase tracking-widest" x-text="t('portfolio_trend')"></p>
          <div class="flex gap-0.5 p-0.5 rounded-lg" style="background: rgba(20,30,48,0.7); border: 1px solid rgba(51,65,85,0.3)">
            <template x-for="r in ['24h','7d','30d','90d','all']">
              <button @click="portfolioRange=r; loadPortfolioHistory()"
                class="px-2.5 py-1 rounded-md text-[10px] font-medium transition-all"
                :class="portfolioRange===r ? 'bg-slate-600 text-white' : 'text-slate-500 hover:text-slate-300'"
                x-text="r"></button>
            </template>
          </div>
        </div>
        <div class="relative" style="height: 320px;">
          <canvas id="portfolioChart"></canvas>
          <div x-show="!portfolioData.length" class="absolute inset-0 flex items-center justify-center">
            <p class="text-slate-600 text-sm" x-text="t('portfolio_no_data')"></p>
          </div>
        </div>
        <!-- Chart legend & stats -->
        <div x-show="portfolioData.length" class="flex flex-wrap gap-x-6 gap-y-1 mt-3 text-xs text-slate-600">
          <span><span class="text-emerald-400">â”â”</span> <span x-text="t('market_value')"></span></span>
          <span><span class="text-blue-400">â”â”</span> <span x-text="t('total_cost')"></span></span>
          <span><span class="text-amber-400">â”â”</span> <span x-text="t('pnl_amount')"></span></span>
          <span class="ml-auto text-[10px] text-slate-700" x-show="portfolioData.length">
            <span x-text="portfolioData.length"></span> <span x-text="t('data_points')"></span>
          </span>
        </div>
      </div>

      <!-- System Monitoring Status -->
      <div class="card p-5 mt-5">
        <div class="flex items-center justify-between mb-4">
          <p class="text-[11px] text-slate-600 uppercase tracking-widest" x-text="t('system_monitor')"></p>
          <button @click="loadMonitorStatus()" class="text-[10px] text-slate-600 hover:text-slate-400 transition-colors">
            â†» <span x-text="t('btn_refresh')"></span>
          </button>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="p-3 rounded-xl" style="background: rgba(15,23,42,0.5); border: 1px solid rgba(51,65,85,0.2)">
            <p class="text-[10px] text-slate-600 mb-1" x-text="t('sys_status')"></p>
            <p class="text-sm font-semibold"
              :class="monitorStatus.status==='healthy' ? 'text-emerald-400' : 'text-amber-400'"
              x-text="monitorStatus.status || 'â€”'"></p>
          </div>
          <div class="p-3 rounded-xl" style="background: rgba(15,23,42,0.5); border: 1px solid rgba(51,65,85,0.2)">
            <p class="text-[10px] text-slate-600 mb-1" x-text="t('sys_uptime')"></p>
            <p class="text-sm font-semibold text-slate-300" x-text="monitorStatus.uptime_human || 'â€”'"></p>
          </div>
          <div class="p-3 rounded-xl" style="background: rgba(15,23,42,0.5); border: 1px solid rgba(51,65,85,0.2)">
            <p class="text-[10px] text-slate-600 mb-1" x-text="t('sys_db_size')"></p>
            <p class="text-sm font-semibold text-slate-300" x-text="monitorStatus.database?.size_mb ? monitorStatus.database.size_mb + ' MB' : 'â€”'"></p>
          </div>
          <div class="p-3 rounded-xl" style="background: rgba(15,23,42,0.5); border: 1px solid rgba(51,65,85,0.2)">
            <p class="text-[10px] text-slate-600 mb-1" x-text="t('sys_collector')"></p>
            <p class="text-sm font-semibold"
              :class="monitorStatus.collector?.status==='running' ? 'text-blue-400' : 'text-slate-400'"
              x-text="monitorStatus.collector?.status || 'idle'"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â• LISTING TAB â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div x-show="activeTab==='listing'" class="fade-up">

      <!-- Sub-tab bar -->
      <div class="flex items-center gap-3 mb-4">
        <div class="flex gap-0.5 p-1 rounded-xl" style="background: rgba(20,30,48,0.7); border: 1px solid rgba(51,65,85,0.3)">
          <button @click="shelfTab='sell'; selectedItems=[]; loadShelf()"
            class="px-3 py-1.5 rounded-lg text-xs font-medium transition-all"
            :class="shelfTab==='sell' ? 'bg-slate-700 text-white' : 'text-slate-500 hover:text-slate-300'">
            <span x-text="t('shelf_sell')"></span> <span class="font-mono ml-1 text-slate-400" x-text="sellShelf.total??0"></span>
          </button>
          <button @click="shelfTab='lease'; selectedItems=[]; loadShelf()"
            class="px-3 py-1.5 rounded-lg text-xs font-medium transition-all"
            :class="shelfTab==='lease' ? 'bg-slate-700 text-white' : 'text-slate-500 hover:text-slate-300'">
            <span x-text="t('shelf_lease')"></span> <span class="font-mono ml-1 text-slate-400" x-text="leaseShelf.total??0"></span>
          </button>
          <button @click="shelfTab='rented'; selectedItems=[]; loadRentedList(1)"
            class="px-3 py-1.5 rounded-lg text-xs font-medium transition-all"
            :class="shelfTab==='rented' ? 'bg-slate-700 text-white' : 'text-slate-500 hover:text-slate-300'">
            <span x-text="t('shelf_rented')"></span> <span class="font-mono ml-1 text-slate-400" x-text="rentedList.total??'â€”'"></span>
          </button>
          <button @click="shelfTab='sublet'; selectedItems=[]; loadSubletList(1)"
            class="px-3 py-1.5 rounded-lg text-xs font-medium transition-all"
            :class="shelfTab==='sublet' ? 'bg-slate-700 text-white' : 'text-slate-500 hover:text-slate-300'">
            <span x-text="t('shelf_sublet')"></span> <span class="font-mono ml-1 text-amber-500" x-text="subletList.total??'â€”'"></span>
          </button>
          <button @click="shelfTab='unlisted'; selectedItems=[]; loadUnlistedItems(1)"
            class="px-3 py-1.5 rounded-lg text-xs font-medium transition-all"
            :class="shelfTab==='unlisted' ? 'bg-slate-700 text-white' : 'text-slate-500 hover:text-slate-300'">
            <span x-text="t('shelf_unlisted')"></span> <span class="font-mono ml-1 text-blue-400" x-text="unlistedItems.total??'â€”'"></span>
          </button>
        </div>

        <button @click="shelfTab==='rented'?loadRentedList(rentedPage):(shelfTab==='sublet'?loadSubletList(subletPage):(shelfTab==='unlisted'?loadUnlistedItems(unlistedPage):loadShelf()))"
          :disabled="shelfLoading || rentedLoading || subletLoading || unlistedLoading"
          class="flex items-center gap-1.5 px-3 py-1.5 rounded-xl text-xs transition-all disabled:opacity-40"
          style="background:rgba(51,65,85,0.3); border:1px solid rgba(51,65,85,0.4); color:#94a3b8">
          <svg class="w-3 h-3" :class="(shelfLoading||rentedLoading||subletLoading||unlistedLoading)?'animate-spin':''" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          <span x-text="t('btn_refresh')"></span>
        </button>

        <div class="ml-auto text-[11px] text-slate-700" x-text="t('smart_listing_note')">
        </div>
      </div>

      <!-- Template ID sync reminder (if needed, only for shelf tabs) -->
      <div x-show="(shelfTab==='sell'||shelfTab==='lease') && !shelfLoading && sellShelf.total === 0 && leaseShelf.total === 0" x-cloak
        class="card p-5 mb-4 text-center">
        <p class="text-slate-500 text-sm mb-3" x-text="t('shelf_empty_sync')"></p>
        <button @click="syncTemplateIds()" :disabled="syncing"
          class="px-5 py-2 rounded-xl text-sm font-medium text-white transition-all disabled:opacity-40"
          style="background:linear-gradient(135deg,#7c3aed,#6d28d9); box-shadow:0 0 16px rgba(124,58,237,0.25)">
          <span x-show="!syncing" x-text="t('btn_sync_template')"></span>
          <span x-show="syncing" x-cloak x-text="t('syncing_text')"></span>
        </button>
      </div>

      <!-- Shelf table (sell / lease shelves) -->
      <div x-show="shelfTab==='sell' || shelfTab==='lease'" class="card overflow-hidden">
        <!-- æ‰¹é‡æ“ä½œæ  -->
        <div x-show="selectedItems.length > 0"
          class="px-4 py-2 flex items-center gap-3 border-b" style="border-color:rgba(51,65,85,0.3);background:rgba(99,102,241,0.05)">
          <span class="text-[11px] text-indigo-400"><span x-text="t('selected_count')"></span> <span class="font-mono" x-text="selectedItems.length"></span></span>
          <button @click="batchDelist()"
            class="text-[11px] px-2 py-1 rounded-lg" style="background:rgba(239,68,68,0.08);color:rgba(239,68,68,0.7);border:1px solid rgba(239,68,68,0.15)"
            x-text="t('btn_batch_delist')"></button>
          <button @click="batchSmartReprice()" :disabled="batchRepricing"
            class="text-[11px] px-2 py-1 rounded-lg disabled:opacity-40" style="background:rgba(99,102,241,0.08);color:rgba(99,102,241,0.8);border:1px solid rgba(99,102,241,0.2)">
            <span x-show="!batchRepricing" x-text="t('btn_batch_reprice')"></span>
            <span x-show="batchRepricing" x-cloak><span x-text="t('btn_repricing')"></span> (<span x-text="batchRepriceProgress"></span>)</span>
          </button>
          <button @click="selectedItems=[]" class="text-[11px] text-slate-600 ml-auto" x-text="t('clear_selection')"></button>
        </div>
        <div class="tbl-wrap">
          <table class="w-full text-xs" style="border-collapse: separate; border-spacing: 0;">
            <thead>
              <tr style="border-bottom: 1px solid rgba(51,65,85,0.3);">
                <th class="py-3 px-2 w-8">
                  <input type="checkbox" @change="toggleSelectAll(currentShelf)" class="accent-indigo-500"
                    :checked="currentShelf.length>0 && currentShelf.every(i=>selectedItems.includes(i.commodityId))"/>
                </th>
                <th class="py-3 px-2 w-12"></th>
                <th class="py-3 px-4 text-left font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_item')"></th>
                <template x-if="shelfTab==='sell'">
                  <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_sell_price')"></th>
                </template>
                <template x-if="shelfTab==='sell'">
                  <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider" style="color:#0f766e" x-text="t('th_market_ref')"></th>
                </template>
                <template x-if="shelfTab==='lease'">
                  <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_daily_rent')"></th>
                </template>
                <template x-if="shelfTab==='lease'">
                  <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_deposit')"></th>
                </template>
                <template x-if="shelfTab==='lease'">
                  <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider" style="color:#0f766e" x-text="t('th_market_ref_rent')"></th>
                </template>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_abrade')"></th>
                <th class="py-3 px-3 text-left font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_status')"></th>
                <th class="py-3 px-4 w-32 text-center font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_operation')"></th>
              </tr>
            </thead>
            <tbody>
              <template x-if="shelfLoading">
                <tr><td colspan="10" class="py-16 text-center" style="color:#334155">
                  <div class="flex flex-col items-center gap-2">
                    <div class="w-5 h-5 rounded-full border-2 animate-spin" style="border-color:rgba(51,65,85,0.4);border-top-color:#3b82f6"></div>
                    <span class="text-xs" x-text="t('loading_shelf')"></span>
                  </div>
                </td></tr>
              </template>
              <template x-if="!shelfLoading && currentShelf.length === 0">
                <tr><td colspan="10" class="py-16 text-center text-xs" style="color:#334155" x-text="t('shelf_empty')"></td></tr>
              </template>
              <template x-for="item in currentShelf" :key="item.commodityId || item.CommodityId">
                <tr class="tbl-row">
                  <td class="py-2.5 px-2 w-8">
                    <input type="checkbox" :checked="selectedItems.includes(item.commodityId)"
                      @change="toggleSelectItem(item.commodityId)" class="accent-indigo-500"/>
                  </td>
                  <!-- Item image -->
                  <td class="py-2 px-1 w-12">
                    <div class="w-10 h-10 rounded-lg overflow-hidden flex-shrink-0" style="background:rgba(20,30,48,0.8)">
                      <img :src="shelfImgUrl(item)" class="w-full h-full object-cover"
                        @error="$el.style.opacity='0'" loading="lazy" />
                    </div>
                  </td>
                  <td class="py-2.5 px-4">
                    <div class="flex items-center gap-2.5">
                      <div class="min-w-0">
                        <p class="leading-tight truncate font-medium" style="max-width:280px"
                          :style="rarityStyle(item.commodityHashName || item.marketHashName)"
                          x-text="nameLang==='cn' ? (item.name||item.Name||item.commodityHashName||'â€”') : (item.commodityHashName||item.marketHashName||item.market_hash_name||'â€”')"></p>
                        <p class="text-[11px] mt-0.5 truncate" style="color:#334155; max-width:280px"
                          x-text="nameLang==='cn' ? (item.commodityHashName||item.marketHashName||'') : (item.name||item.Name||'')"></p>
                      </div>
                    </div>
                  </td>
                  <template x-if="shelfTab==='sell'">
                    <td class="py-2.5 px-3 text-right font-semibold text-slate-100"
                      x-text="'Â¥' + fmt(item.price || item.Price || item.sellPrice)"></td>
                  </template>
                  <!-- Market ref price (sell) -->
                  <template x-if="shelfTab==='sell'">
                    <td class="py-2.5 px-3 text-right">
                      <template x-if="item._mktSell != null">
                        <span class="text-teal-400 font-mono text-[11px]" x-text="'Â¥' + fmt(item._mktSell)"></span>
                      </template>
                      <template x-if="item._mktSell == null && !item._mktLoading">
                        <button @click.stop="fetchShelfMktPrice(item)"
                          class="text-[10px] px-1.5 py-0.5 rounded text-slate-600 hover:text-teal-400 transition-colors"
                          style="border:1px solid rgba(51,65,85,0.3)">æŸ¥</button>
                      </template>
                      <template x-if="item._mktLoading">
                        <span class="text-slate-700 text-[10px]">â€¦</span>
                      </template>
                    </td>
                  </template>
                  <template x-if="shelfTab==='lease'">
                    <td class="py-2.5 px-3 text-right font-semibold text-emerald-300"
                      x-text="'Â¥' + fmt(item.leaseUnitPrice || item.LeaseUnitPrice) + '/å¤©'"></td>
                  </template>
                  <template x-if="shelfTab==='lease'">
                    <td class="py-2.5 px-3 text-right font-mono text-slate-400"
                      x-text="'Â¥' + fmt(item.leaseDeposit || item.LeaseDeposit)"></td>
                  </template>
                  <!-- Market ref lease (lease) -->
                  <template x-if="shelfTab==='lease'">
                    <td class="py-2.5 px-3 text-right">
                      <template x-if="item._mktLease != null">
                        <span class="text-teal-400 font-mono text-[11px]"
                          x-text="'Â¥' + fmt(item._mktLease.leaseUnit) + '/å¤©'"></span>
                      </template>
                      <template x-if="item._mktLease == null && !item._mktLoading">
                        <button @click.stop="fetchShelfMktPrice(item)"
                          class="text-[10px] px-1.5 py-0.5 rounded text-slate-600 hover:text-teal-400 transition-colors"
                          style="border:1px solid rgba(51,65,85,0.3)">æŸ¥</button>
                      </template>
                      <template x-if="item._mktLoading">
                        <span class="text-slate-700 text-[10px]">â€¦</span>
                      </template>
                    </td>
                  </template>
                  <td class="py-2.5 px-3 text-right font-mono" style="color:#475569"
                    x-text="(item.abrade || item.Abrade) != null ? parseFloat(item.abrade || item.Abrade).toFixed(4) : 'â€”'"></td>
                  <td class="py-2.5 px-3">
                    <span class="px-2 py-0.5 rounded-full text-[11px]"
                      style="background:rgba(34,197,94,0.1); color:#4ade80" x-text="t('on_sale')"></span>
                  </td>
                  <td class="py-2.5 px-4 text-center">
                    <div class="flex items-center justify-center gap-1.5">
                      <button @click="openReprice(item)"
                        class="text-[11px] px-2 py-1 rounded-lg transition-all"
                        style="background:rgba(99,102,241,0.08); color:rgba(99,102,241,0.7); border:1px solid rgba(99,102,241,0.15)"
                        @mouseenter="$el.style.background='rgba(99,102,241,0.18)'"
                        @mouseleave="$el.style.background='rgba(99,102,241,0.08)'">
                        <span x-text="t('btn_reprice')"></span>
                      </button>
                      <button @click="delistItem(item.commodityId || item.CommodityId)"
                        class="text-[11px] px-2 py-1 rounded-lg transition-all"
                        style="background:rgba(239,68,68,0.08); color:rgba(239,68,68,0.6); border:1px solid rgba(239,68,68,0.15)"
                        @mouseenter="$el.style.background='rgba(239,68,68,0.15)'"
                        @mouseleave="$el.style.background='rgba(239,68,68,0.08)'"
                        x-text="t('btn_delist')">
                      </button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <!-- â”€â”€ å·²ç§Ÿå‡ºåˆ—è¡¨ â”€â”€ -->
      <div x-show="shelfTab==='rented'" class="card overflow-hidden">
        <div x-show="rentedList.stats" x-cloak class="px-4 py-2 text-[11px] text-slate-500 border-b" style="border-color:rgba(51,65,85,0.3)"
          x-text="rentedList.stats"></div>
        <div class="tbl-wrap">
          <table class="w-full text-xs" style="border-collapse: separate; border-spacing: 0;">
            <thead>
              <tr style="border-bottom: 1px solid rgba(51,65,85,0.3);">
                <th class="py-3 px-4 text-left font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_item')"></th>
                <th class="py-3 px-3 text-left font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_status')"></th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_daily_rent')"></th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_expire')"></th>
                <th class="py-3 px-3 text-center font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_renewal')"></th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_abrade')"></th>
              </tr>
            </thead>
            <tbody>
              <template x-if="rentedLoading">
                <tr><td colspan="6" class="py-16 text-center" style="color:#334155">
                  <div class="flex flex-col items-center gap-2">
                    <div class="w-5 h-5 rounded-full border-2 animate-spin" style="border-color:rgba(51,65,85,0.4);border-top-color:#3b82f6"></div>
                    <span class="text-xs" x-text="t('loading_data')"></span>
                  </div>
                </td></tr>
              </template>
              <template x-if="!rentedLoading && (rentedList.items||[]).length === 0">
                <tr><td colspan="6" class="py-16 text-center text-xs" style="color:#334155" x-text="t('no_data')"></td></tr>
              </template>
              <template x-for="item in (rentedList.items||[])" :key="item.orderId">
                <tr class="tbl-row">
                  <td class="py-2.5 px-4">
                    <div class="flex items-center gap-2.5">
                      <div class="w-9 h-9 rounded-lg overflow-hidden flex-shrink-0" style="background:rgba(20,30,48,0.8)">
                        <img :src="shelfImgUrl(item)" class="w-full h-full object-cover"
                          @error="$el.style.opacity='0'" loading="lazy" />
                      </div>
                      <div class="min-w-0">
                        <p class="font-medium leading-tight truncate" style="max-width:260px"
                          :style="rarityStyle(item.hashName)"
                          x-text="nameLang==='cn' ? (item.name||item.hashName||'â€”') : (item.hashName||item.name||'â€”')"></p>
                        <p class="leading-tight truncate mt-0.5" style="max-width:260px; color:#475569"
                          x-text="nameLang==='cn' ? (item.hashName||'') : (item.name||'')"></p>
                      </div>
                    </div>
                  </td>
                  <td class="py-2.5 px-3">
                    <span class="px-2 py-0.5 rounded-full text-[11px]"
                      :style="item.isSublet ? 'background:rgba(234,179,8,0.1);color:#fbbf24' : 'background:rgba(99,102,241,0.1);color:#818cf8'"
                      x-text="item.isSublet ? t('subletting') : (item.orderStatusDesc || t('status_rented'))"></span>
                  </td>
                  <td class="py-2.5 px-3 text-right font-semibold text-emerald-300" x-text="item.leaseAmountDesc || 'â€”'"></td>
                  <td class="py-2.5 px-3 text-right font-mono text-slate-400"
                    x-text="item.leaseExpireTime ? item.leaseExpireTime.slice(0,16).replace('T',' ') : (item.leaseDaysDesc || 'â€”')"></td>
                  <td class="py-2.5 px-3 text-center">
                    <span x-show="item.hasRenewal" class="px-1.5 py-0.5 rounded text-[10px]" style="background:rgba(234,179,8,0.1);color:#fbbf24">ç»­ç§Ÿ</span>
                    <span x-show="!item.hasRenewal" class="text-slate-700">â€”</span>
                  </td>
                  <td class="py-2.5 px-3 text-right font-mono" style="color:#475569"
                    x-text="item.abrade != null ? parseFloat(item.abrade).toFixed(4) : 'â€”'"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <div x-show="!rentedLoading && rentedList.total > (rentedList.page_size||50)"
          class="flex items-center justify-between px-4 py-3 border-t" style="border-color:rgba(51,65,85,0.3)">
          <span class="text-[11px] text-slate-600"><span x-text="t('total_records')"></span> <span class="font-mono text-slate-400" x-text="rentedList.total"></span> <span x-text="t('records_unit')"></span> Â· <span x-text="t('page_prefix')"></span> <span class="font-mono text-slate-400" x-text="rentedPage"></span> <span x-text="t('page_unit')"></span></span>
          <div class="flex gap-2">
            <button @click="loadRentedList(rentedPage-1)" :disabled="rentedPage<=1"
              class="px-3 py-1 rounded-lg text-xs disabled:opacity-30" style="background:rgba(51,65,85,0.3);color:#94a3b8">â€¹</button>
            <button @click="loadRentedList(rentedPage+1)" :disabled="rentedPage*(rentedList.page_size||50)>=rentedList.total"
              class="px-3 py-1 rounded-lg text-xs disabled:opacity-30" style="background:rgba(51,65,85,0.3);color:#94a3b8">â€º</button>
          </div>
        </div>
      </div>

      <!-- â”€â”€ è½¬ç§Ÿä¸­/0CDåˆ—è¡¨ â”€â”€ -->
      <div x-show="shelfTab==='sublet'" class="card overflow-hidden">
        <!-- æ‰¹é‡æ“ä½œæ  -->
        <div x-show="selectedItems.length > 0" class="px-4 py-2 flex items-center gap-3 border-b" style="border-color:rgba(51,65,85,0.3);background:rgba(234,179,8,0.05)">
          <span class="text-[11px] text-amber-400"><span x-text="t('selected_count')"></span> <span class="font-mono" x-text="selectedItems.length"></span></span>
          <button @click="batchDisableZeroCd()"
            class="text-[11px] px-2 py-1 rounded-lg" style="background:rgba(234,179,8,0.1);color:#fbbf24;border:1px solid rgba(234,179,8,0.15)"
            x-text="t('btn_cancel_sublet')+'('+t('btn_batch_delist')+')'"></button>
          <button @click="selectedItems=[]" class="text-[11px] text-slate-600 ml-auto" x-text="t('clear_selection')"></button>
        </div>
        <div class="tbl-wrap">
          <table class="w-full text-xs" style="border-collapse: separate; border-spacing: 0;">
            <thead>
              <tr style="border-bottom: 1px solid rgba(51,65,85,0.3);">
                <th class="py-3 px-2 w-8">
                  <input type="checkbox" @change="toggleSelectAll(subletList.items||[])" class="accent-amber-500"
                    :checked="(subletList.items||[]).length>0 && (subletList.items||[]).every(i=>selectedItems.includes(i.commodityId))"/>
                </th>
                <th class="py-3 px-2 w-12"></th>
                <th class="py-3 px-3 text-left font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_item')"></th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_daily_rent')"></th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_deposit')"></th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_abrade')"></th>
                <th class="py-3 px-4 text-center font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_operation')"></th>
              </tr>
            </thead>
            <tbody>
              <template x-if="subletLoading">
                <tr><td colspan="7" class="py-16 text-center" style="color:#334155">
                  <div class="flex flex-col items-center gap-2">
                    <div class="w-5 h-5 rounded-full border-2 animate-spin" style="border-color:rgba(51,65,85,0.4);border-top-color:#f59e0b"></div>
                    <span class="text-xs" x-text="t('loading_data')"></span>
                  </div>
                </td></tr>
              </template>
              <template x-if="!subletLoading && (subletList.items||[]).length === 0">
                <tr><td colspan="7" class="py-16 text-center text-xs" style="color:#334155" x-text="t('no_data')"></td></tr>
              </template>
              <template x-for="item in (subletList.items||[])" :key="item.commodityId">
                <tr class="tbl-row">
                  <td class="py-2.5 px-2 w-8">
                    <input type="checkbox" :checked="selectedItems.includes(item.commodityId)"
                      @change="toggleSelectItem(item.commodityId)" class="accent-amber-500"/>
                  </td>
                  <!-- Image -->
                  <td class="py-2 px-1 w-12">
                    <div class="w-10 h-10 rounded-lg overflow-hidden" style="background:rgba(20,30,48,0.8)">
                      <img :src="shelfImgUrl(item)" class="w-full h-full object-cover"
                        @error="$el.style.opacity='0'" loading="lazy" />
                    </div>
                  </td>
                  <td class="py-2.5 px-3">
                    <div class="min-w-0">
                      <p class="leading-tight truncate font-medium" style="max-width:260px"
                        :style="rarityStyle(item.commodityHashName)"
                        x-text="nameLang==='cn' ? (item.name||item.commodityHashName||'â€”') : (item.commodityHashName||item.name||'â€”')"></p>
                    </div>
                  </td>
                  <td class="py-2.5 px-3 text-right font-semibold text-emerald-300"
                    x-text="item.leaseUnitPrice ? 'Â¥'+item.leaseUnitPrice+'/å¤©' : (item.leaseAmountDesc || 'â€”')"></td>
                  <td class="py-2.5 px-3 text-right font-mono text-slate-400"
                    x-text="item.leaseDeposit ? 'Â¥'+item.leaseDeposit : (item.depositAmountDesc || 'â€”')"></td>
                  <td class="py-2.5 px-3 text-right font-mono" style="color:#475569"
                    x-text="item.abrade != null ? parseFloat(item.abrade).toFixed(4) : 'â€”'"></td>
                  <td class="py-2.5 px-4 text-center">
                    <div class="flex items-center justify-center gap-1.5">
                      <button @click="openSubletReprice(item)"
                        class="text-[11px] px-2 py-1 rounded-lg transition-all"
                        style="background:rgba(99,102,241,0.08);color:rgba(99,102,241,0.7);border:1px solid rgba(99,102,241,0.15)"
                        @mouseenter="$el.style.background='rgba(99,102,241,0.18)'"
                        @mouseleave="$el.style.background='rgba(99,102,241,0.08)'"
                        x-text="t('btn_reprice')"></button>
                      <button @click="cancelSubletOrder(item.orderId || item.commodityId)"
                        class="text-[11px] px-2 py-1 rounded-lg transition-all"
                        style="background:rgba(234,179,8,0.08);color:rgba(234,179,8,0.7);border:1px solid rgba(234,179,8,0.15)"
                        @mouseenter="$el.style.background='rgba(234,179,8,0.18)'"
                        @mouseleave="$el.style.background='rgba(234,179,8,0.08)'"
                        x-text="t('btn_cancel_sublet')"></button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <div x-show="!subletLoading && subletList.total > (subletList.page_size||50)"
          class="flex items-center justify-between px-4 py-3 border-t" style="border-color:rgba(51,65,85,0.3)">
          <span class="text-[11px] text-slate-600"><span x-text="t('total_records')"></span> <span class="font-mono text-slate-400" x-text="subletList.total"></span> Â· <span x-text="t('page_prefix')"></span> <span class="font-mono text-slate-400" x-text="subletPage"></span> <span x-text="t('page_unit')"></span></span>
          <div class="flex gap-2">
            <button @click="loadSubletList(subletPage-1)" :disabled="subletPage<=1"
              class="px-3 py-1 rounded-lg text-xs disabled:opacity-30" style="background:rgba(51,65,85,0.3);color:#94a3b8">â€¹</button>
            <button @click="loadSubletList(subletPage+1)" :disabled="subletPage*(subletList.page_size||50)>=subletList.total"
              class="px-3 py-1 rounded-lg text-xs disabled:opacity-30" style="background:rgba(51,65,85,0.3);color:#94a3b8">â€º</button>
          </div>
        </div>
      </div>

      <!-- â”€â”€ å¾…ä¸Šæ¶é¥°å“ â”€â”€ -->
      <div x-show="shelfTab==='unlisted'" class="card overflow-hidden">
        <div x-show="unlistedItems.total > 0" x-cloak class="px-4 py-2 text-[11px] text-slate-500 border-b" style="border-color:rgba(51,65,85,0.3)">
          Steam <span class="text-slate-400 font-mono" x-text="unlistedItems.total_inventory"></span> Â·
          <span x-text="t('on_sale')"></span> <span class="text-slate-400 font-mono" x-text="unlistedItems.total_listed"></span> Â·
          <span x-text="t('shelf_unlisted')"></span> <span class="text-blue-400 font-mono" x-text="unlistedItems.total"></span>
        </div>
        <div class="tbl-wrap">
          <table class="w-full text-xs" style="border-collapse: separate; border-spacing: 0;">
            <thead>
              <tr style="border-bottom: 1px solid rgba(51,65,85,0.3);">
                <th class="py-3 px-4 text-left font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_item')"></th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_abrade')"></th>
                <th class="py-3 px-3 text-center font-normal text-slate-700 uppercase tracking-wider">Template ID</th>
                <th class="py-3 px-4 text-center font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_operation')"></th>
              </tr>
            </thead>
            <tbody>
              <template x-if="unlistedLoading">
                <tr><td colspan="4" class="py-16 text-center" style="color:#334155">
                  <div class="flex flex-col items-center gap-2">
                    <div class="w-5 h-5 rounded-full border-2 animate-spin" style="border-color:rgba(51,65,85,0.4);border-top-color:#60a5fa"></div>
                    <span class="text-xs" x-text="t('loading_data')"></span>
                  </div>
                </td></tr>
              </template>
              <template x-if="!unlistedLoading && (unlistedItems.items||[]).length === 0">
                <tr><td colspan="4" class="py-16 text-center text-xs" style="color:#334155">
                  <span x-text="t('no_data')"></span>
                </td></tr>
              </template>
              <template x-for="item in (unlistedItems.items||[])" :key="item.assetId">
                <tr class="tbl-row">
                  <td class="py-2.5 px-4">
                    <div class="min-w-0">
                      <p class="text-slate-100 font-medium leading-tight truncate" style="max-width:320px"
                        x-text="item.commodityHashName || item.name || 'â€”'"></p>
                      <p class="text-[11px] mt-0.5 truncate" style="color:#334155; max-width:320px"
                        x-text="item.name || ''"></p>
                    </div>
                  </td>
                  <td class="py-2.5 px-3 text-right font-mono" style="color:#475569"
                    x-text="item.abrade != null ? parseFloat(item.abrade).toFixed(4) : 'â€”'"></td>
                  <td class="py-2.5 px-3 text-center font-mono text-slate-500"
                    x-text="item.templateId || 'â€”'"></td>
                  <td class="py-2.5 px-4 text-center">
                    <button x-show="item.templateId"
                      @click="quickList.assetId=item.assetId; quickList.templateId=item.templateId; shelfTab='sell'"
                      class="text-[11px] px-2 py-1 rounded-lg transition-all"
                      style="background:rgba(59,130,246,0.08); color:rgba(59,130,246,0.7); border:1px solid rgba(59,130,246,0.15)"
                      @mouseenter="$el.style.background='rgba(59,130,246,0.18)'"
                      @mouseleave="$el.style.background='rgba(59,130,246,0.08)'">
                      â†’ List
                    </button>
                    <span x-show="!item.templateId" class="text-[11px] text-slate-700">â€”</span>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <div x-show="!unlistedLoading && unlistedItems.total > (unlistedItems.page_size||50)"
          class="flex items-center justify-between px-4 py-3 border-t" style="border-color:rgba(51,65,85,0.3)">
          <span class="text-[11px] text-slate-600"><span x-text="t('total_records')"></span> <span class="font-mono text-slate-400" x-text="unlistedItems.total"></span> Â· <span x-text="t('page_prefix')"></span> <span class="font-mono text-slate-400" x-text="unlistedPage"></span> <span x-text="t('page_unit')"></span></span>
          <div class="flex gap-2">
            <button @click="loadUnlistedItems(unlistedPage-1)" :disabled="unlistedPage<=1"
              class="px-3 py-1 rounded-lg text-xs disabled:opacity-30" style="background:rgba(51,65,85,0.3);color:#94a3b8">â€¹</button>
            <button @click="loadUnlistedItems(unlistedPage+1)" :disabled="unlistedPage*(unlistedItems.page_size||50)>=unlistedItems.total"
              class="px-3 py-1 rounded-lg text-xs disabled:opacity-30" style="background:rgba(51,65,85,0.3);color:#94a3b8">â€º</button>
          </div>
        </div>
      </div>

      <!-- æç¤ºï¼šä½¿ç”¨å¾…ä¸Šæ¶ tab å¿«é€Ÿä¸Šæ¶ -->
      <div x-show="shelfTab==='sell' || shelfTab==='lease'" class="mt-3 px-4 py-2 text-[11px] text-slate-700 text-center" x-text="t('need_list_note')">
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â• ANALYSIS TAB â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div x-show="activeTab==='analysis'" class="fade-up">

      <!-- Sub-tabs -->
      <div class="flex gap-1 mb-4">
        <template x-for="tab in [{k:'overview',l:'analysis_overview'},{k:'detail',l:'analysis_detail'},{k:'alerts',l:'analysis_alerts'},{k:'spreads',l:'analysis_spreads'}]">
          <button @click="analysisTab=tab.k; loadAnalysisSubTab(tab.k)"
            class="px-3 py-1.5 rounded-lg text-xs font-medium transition-all"
            :class="analysisTab===tab.k ? 'bg-slate-700 text-white' : 'text-slate-500 hover:text-slate-300'"
            x-text="t(tab.l)"></button>
        </template>
      </div>

      <!-- â”€â”€ Sub: Overview â”€â”€ -->
      <div x-show="analysisTab==='overview'">
        <!-- Stat cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
          <div class="card p-4 cursor-pointer" @click="analysisTab='alerts'; loadAnalysisSubTab('alerts')">
            <p class="text-[10px] text-slate-600 uppercase tracking-widest mb-1" x-text="t('unread_alerts')"></p>
            <p class="text-2xl font-bold" :class="(ao.unread_alerts||0)>0?'text-red-400':'text-slate-400'" x-text="ao.unread_alerts||0"></p>
          </div>
          <div class="card p-4">
            <p class="text-[10px] text-slate-600 uppercase tracking-widest mb-1" x-text="t('avg_sell_score')"></p>
            <p class="text-2xl font-bold" :class="scoreColor(ao.avg_sell_score)" x-text="ao.avg_sell_score!==null?ao.avg_sell_score:'â€”'"></p>
            <p class="text-[10px] mt-1" :class="scoreColor(ao.avg_sell_score)" x-text="scoreLabel(ao.avg_sell_score)"></p>
          </div>
          <div class="card p-4">
            <p class="text-[10px] text-slate-600 uppercase tracking-widest mb-1" x-text="t('avg_momentum_30')"></p>
            <p class="text-2xl font-bold" :class="pnlClass(ao.avg_momentum_30)" x-text="ao.avg_momentum_30!==null?(ao.avg_momentum_30>0?'+':'')+ao.avg_momentum_30+'%':'â€”'"></p>
          </div>
          <div class="card p-4">
            <p class="text-[10px] text-slate-600 uppercase tracking-widest mb-1" x-text="t('data_status')"></p>
            <p class="text-xs text-slate-400 mt-1" x-text="ao.collector?.status==='running'?t('collecting'):ao.collector?.last_run?t('last_run')+': '+ao.collector.last_run.slice(5,16):t('not_started')"></p>
            <p class="text-[10px] text-slate-600 mt-0.5" x-text="ao.signal_date?t('signal_date')+': '+ao.signal_date:t('no_signal')"></p>
          </div>
        </div>

        <!-- Sell Score Distribution (clickable bars) -->
        <div class="card p-4 mb-5">
          <p class="text-[11px] text-slate-500 mb-3 font-medium"><span x-text="t('score_dist_title')"></span> <span class="text-slate-700">â€” <span x-text="t('score_dist_hint')"></span></span></p>
          <div class="flex items-end gap-1.5 h-20">
            <template x-for="(v,i) in (ao.score_distribution||[0,0,0,0,0])">
              <div class="flex-1 flex flex-col items-center gap-1 cursor-pointer"
                @click="openScoreBucket(i)">
                <span class="text-[10px] font-mono text-slate-400" x-text="v"></span>
                <div class="w-full rounded-t transition-all duration-500 hover:opacity-80"
                  :style="'height:'+Math.max(4, v/Math.max(1,...(ao.score_distribution||[1]))*60)+'px'"
                  :class="['bg-emerald-500/60','bg-slate-500/60','bg-yellow-500/60','bg-orange-500/60','bg-red-500/60'][i]"></div>
                <span class="text-[9px] text-slate-600" x-text="[t('score_hold'),t('score_neutral'),t('score_consider'),t('score_strong'),t('score_urgent')][i]"></span>
              </div>
            </template>
          </div>
          <!-- Expanded bucket list -->
          <div x-show="scoreBucket.show" x-cloak class="mt-3 border-t pt-3" style="border-color:rgba(51,65,85,0.3)">
            <div class="flex items-center justify-between mb-2">
              <p class="text-[11px] text-slate-400" x-text="scoreBucket.label+' (è¯„åˆ† '+scoreBucket.min+'~'+scoreBucket.max+')'"></p>
              <button @click="scoreBucket.show=false" class="text-[10px] text-slate-600 hover:text-slate-400">Ã—</button>
            </div>
            <div class="space-y-1 max-h-48 overflow-y-auto">
              <template x-for="s in scoreBucket.items">
                <div class="flex items-center justify-between px-2 py-1.5 rounded hover:bg-slate-800/30 cursor-pointer"
                  @click="analysisTab='detail'; analysisSelectedItem=s.market_hash_name; loadItemSignals(s.market_hash_name)">
                  <span class="text-xs truncate max-w-[250px]" :style="rarityStyle(s.market_hash_name)" x-text="s.market_hash_name"></span>
                  <span class="text-xs font-mono ml-2 flex-shrink-0" :class="scoreColor(s.sell_score)" x-text="s.sell_score"></span>
                </div>
              </template>
              <div x-show="!scoreBucket.items?.length" class="text-[10px] text-slate-700 text-center py-2">â€”</div>
            </div>
          </div>
        </div>

        <!-- Top 10 + Category Trends -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <!-- Top 10 Sell Signals -->
          <div class="card overflow-hidden">
            <div class="px-4 py-3 border-b" style="border-color:rgba(51,65,85,0.3)">
              <p class="text-[11px] text-slate-500 font-medium" x-text="t('top10_sell')"></p>
            </div>
            <table class="w-full text-xs">
              <thead><tr class="text-[10px] text-slate-600 uppercase" style="background:rgba(15,23,42,0.5)">
                <th class="py-2 px-3 text-left" x-text="t('th_item')"></th>
                <th class="py-2 px-2 text-right">Score</th>
                <th class="py-2 px-2 text-right">RSI</th>
                <th class="py-2 px-2 text-right">30D</th>
                <th class="py-2 px-2 text-right">ATH%</th>
              </tr></thead>
              <tbody>
                <template x-for="s in (ao.top_sell||[])">
                  <tr class="border-t cursor-pointer hover:bg-slate-800/30" style="border-color:rgba(51,65,85,0.2)"
                    @click="analysisTab='detail'; analysisSelectedItem=s.market_hash_name; loadItemSignals(s.market_hash_name)">
                    <td class="py-2 px-3">
                      <div class="flex items-center gap-2">
                        <div class="w-7 h-7 rounded overflow-hidden flex-shrink-0" style="background:rgba(20,30,48,0.8)">
                          <img :src="iconUrl(s.icon_url)" class="w-full h-full object-cover" @error="$el.style.opacity='0'" loading="lazy" x-show="s.icon_url" />
                        </div>
                        <div class="min-w-0">
                          <p class="font-medium truncate max-w-[160px]" :style="rarityStyle(s.market_hash_name)" :title="s.market_hash_name"
                            x-text="nameLang==='cn' ? (s.name||s.market_hash_name) : s.market_hash_name"></p>
                          <p class="text-[10px] truncate max-w-[160px]" style="color:#475569"
                            x-text="nameLang==='cn' ? s.market_hash_name : (s.name||'')"></p>
                        </div>
                      </div>
                    </td>
                    <td class="py-2 px-2 text-right font-mono font-bold" :class="scoreColor(s.sell_score)" x-text="s.sell_score"></td>
                    <td class="py-2 px-2 text-right font-mono" :class="s.rsi_14>70?'text-red-400':s.rsi_14<30?'text-emerald-400':'text-slate-400'" x-text="s.rsi_14??'â€”'"></td>
                    <td class="py-2 px-2 text-right font-mono" :class="pnlClass(s.momentum_30)" x-text="s.momentum_30!==null?(s.momentum_30>0?'+':'')+s.momentum_30+'%':'â€”'"></td>
                    <td class="py-2 px-2 text-right font-mono" :class="s.ath_pct>90?'text-yellow-300':'text-slate-400'" x-text="s.ath_pct?s.ath_pct+'%':'â€”'"></td>
                  </tr>
                </template>
                <tr x-show="!ao.top_sell?.length"><td colspan="5" class="py-6 text-center text-slate-600" x-text="t('no_signal_hint')"></td></tr>
              </tbody>
            </table>
          </div>

          <!-- Category Trends -->
          <div class="card overflow-hidden">
            <div class="px-4 py-3 border-b" style="border-color:rgba(51,65,85,0.3)">
              <p class="text-[11px] text-slate-500 font-medium" x-text="t('category_trends')"></p>
            </div>
            <table class="w-full text-xs">
              <thead><tr class="text-[10px] text-slate-600 uppercase" style="background:rgba(15,23,42,0.5)">
                <th class="py-2 px-3 text-left" x-text="nameLang==='cn'?'ç±»åˆ«':'Category'"></th>
                <th class="py-2 px-2 text-right" x-text="nameLang==='cn'?'æ•°é‡':'Count'"></th>
                <th class="py-2 px-2 text-right">7D</th>
                <th class="py-2 px-2 text-right">30D</th>
                <th class="py-2 px-2 text-right">RSI</th>
              </tr></thead>
              <tbody>
                <template x-for="c in (ao.category_trends||[])">
                  <tr class="border-t" style="border-color:rgba(51,65,85,0.2)">
                    <td class="py-2 px-3 font-medium text-slate-300" x-text="catLabel(c.category)"></td>
                    <td class="py-2 px-2 text-right font-mono text-slate-400" x-text="c.count"></td>
                    <td class="py-2 px-2 text-right font-mono" :class="pnlClass(c.avg_momentum_7)" x-text="c.avg_momentum_7!==null?(c.avg_momentum_7>0?'+':'')+c.avg_momentum_7+'%':'â€”'"></td>
                    <td class="py-2 px-2 text-right font-mono" :class="pnlClass(c.avg_momentum_30)" x-text="c.avg_momentum_30!==null?(c.avg_momentum_30>0?'+':'')+c.avg_momentum_30+'%':'â€”'"></td>
                    <td class="py-2 px-2 text-right font-mono text-slate-400" x-text="c.avg_rsi??'â€”'"></td>
                  </tr>
                </template>
                <tr x-show="!ao.category_trends?.length"><td colspan="5" class="py-6 text-center text-slate-600">â€”</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Action buttons -->
        <div class="flex gap-3 mt-4">
          <button @click="triggerBackfill()" :disabled="backfillRunning"
            class="px-4 py-2 rounded-lg text-xs font-medium bg-indigo-600 hover:bg-indigo-500 text-white disabled:opacity-50">
            <span x-show="!backfillRunning" x-text="t('btn_backfill')"></span>
            <span x-show="backfillRunning" x-cloak x-text="t('backfilling')+' '+backfillProgress"></span>
          </button>
          <button @click="triggerComputeNow()" :disabled="computingSignals"
            class="px-4 py-2 rounded-lg text-xs font-medium bg-slate-700 hover:bg-slate-600 text-white disabled:opacity-50">
            <span x-show="!computingSignals" x-text="t('btn_compute')"></span>
            <span x-show="computingSignals" x-cloak x-text="t('computing')"></span>
          </button>
          <button @click="collectNow()" :disabled="ao.collector?.status==='running'"
            class="px-4 py-2 rounded-lg text-xs font-medium bg-slate-700 hover:bg-slate-600 text-white disabled:opacity-50">
            <span x-text="ao.collector?.status==='running'?t('collecting'):t('btn_collect')"></span>
          </button>
        </div>
      </div>

      <!-- â”€â”€ Sub: Item Detail â”€â”€ -->
      <div x-show="analysisTab==='detail'">
        <!-- Search bar -->
        <div class="flex gap-3 mb-4">
          <div class="relative flex-1">
            <input type="text" x-model="analysisSearch" @input.debounce.300ms="searchAnalysisItems()"
              :placeholder="t('search_item_hint')" class="w-full px-4 py-2.5 rounded-xl text-sm text-white placeholder-slate-600"
              style="background:rgba(15,23,42,0.8); border:1px solid rgba(51,65,85,0.3)" />
            <div x-show="analysisSearchResults.length>0" x-cloak
              class="absolute z-50 left-0 right-0 top-full mt-1 rounded-xl overflow-hidden shadow-xl max-h-60 overflow-y-auto"
              style="background:rgba(15,23,42,0.95); border:1px solid rgba(51,65,85,0.4)">
              <template x-for="r in analysisSearchResults">
                <div @click="analysisSelectedItem=r.market_hash_name; analysisSearch=r.market_hash_name; analysisSearchResults=[]; loadItemSignals(r.market_hash_name)"
                  class="px-4 py-2 text-xs text-slate-300 hover:bg-slate-700/50 cursor-pointer truncate" x-text="r.market_hash_name"></div>
              </template>
            </div>
          </div>
        </div>

        <template x-if="itemSignals">
          <div>
            <!-- Price Chart -->
            <div class="card p-4 mb-4">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                  <div class="w-8 h-8 rounded-lg overflow-hidden flex-shrink-0" style="background:rgba(20,30,48,0.8)" x-show="itemSignals.icon_url">
                    <img :src="iconUrl(itemSignals.icon_url)" class="w-full h-full object-cover" @error="$el.style.opacity='0'" loading="lazy" />
                  </div>
                  <div>
                    <p class="text-sm font-medium" :style="rarityStyle(analysisSelectedItem)"
                      x-text="nameLang==='cn' ? (itemSignals.name||analysisSelectedItem) : analysisSelectedItem"></p>
                    <p class="text-[10px]" style="color:#475569" x-text="nameLang==='cn' ? analysisSelectedItem : (itemSignals.name||'')"></p>
                  </div>
                </div>
                <div class="flex gap-2">
                  <template x-for="d in [30,60,90]">
                    <button @click="chartDays=d; loadItemSignals(analysisSelectedItem)"
                      class="px-2 py-0.5 rounded text-[10px]"
                      :class="chartDays===d?'bg-slate-600 text-white':'text-slate-500 hover:text-slate-300'"
                      x-text="d+(nameLang==='cn'?'å¤©':'D')"></button>
                  </template>
                </div>
              </div>
              <div class="relative" style="height:280px">
                <canvas id="priceChart"></canvas>
              </div>
            </div>

            <!-- Signal Gauges -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 mb-4">
              <div class="card p-3 text-center">
                <p class="text-[10px] text-slate-600 mb-1">RSI(14)
                  <span class="info-tip"><span class="inline-block w-3 h-3 rounded-full text-[8px] leading-3 text-center bg-slate-800 text-slate-500 ml-0.5">i</span>
                    <span class="tip-text" x-text="nameLang==='cn'?'ç›¸å¯¹å¼ºå¼±æŒ‡æ ‡ (14æ—¥)ã€‚>70 è¶…ä¹°(å¯èƒ½å›è°ƒ)ï¼Œ<30 è¶…å–(å¯èƒ½åå¼¹)ï¼Œ50 ä¸­æ€§ã€‚':'RSI(14). >70 overbought, <30 oversold, 50 neutral.'"></span></span></p>
                <p class="text-xl font-bold font-mono" :class="(itemSignals.signal?.rsi_14||0)>70?'text-red-400':(itemSignals.signal?.rsi_14||0)<30?'text-emerald-400':'text-slate-300'" x-text="itemSignals.signal?.rsi_14??'â€”'"></p>
                <p class="text-[9px] mt-0.5" :class="(itemSignals.signal?.rsi_14||0)>70?'text-red-500':'text-slate-600'" x-text="(itemSignals.signal?.rsi_14||0)>70?t('overbought'):(itemSignals.signal?.rsi_14||0)<30?t('oversold'):t('neutral_rsi')"></p>
              </div>
              <div class="card p-3 text-center">
                <p class="text-[10px] text-slate-600 mb-1">Bollinger %B
                  <span class="info-tip"><span class="inline-block w-3 h-3 rounded-full text-[8px] leading-3 text-center bg-slate-800 text-slate-500 ml-0.5">i</span>
                    <span class="tip-text" x-text="nameLang==='cn'?'å¸ƒæ—å¸¦ä½ç½®ã€‚åŸºäº20æ—¥å‡çº¿Â±2Ïƒã€‚>1 çªç ´ä¸Šè½¨(è¶…æ¶¨)ï¼Œ<0 è·Œç ´ä¸‹è½¨(è¶…è·Œ)ï¼Œ0.5 å±…ä¸­ã€‚':'Bollinger %B. Based on 20D MA Â±2Ïƒ. >1 above upper band, <0 below lower, 0.5 mid.'"></span></span></p>
                <p class="text-xl font-bold font-mono" :class="(itemSignals.signal?.bb_position||0)>1?'text-red-400':(itemSignals.signal?.bb_position||0)<0?'text-emerald-400':'text-slate-300'" x-text="itemSignals.signal?.bb_position??'â€”'"></p>
                <p class="text-[9px] mt-0.5 text-slate-600" x-text="(itemSignals.signal?.bb_position||0)>1?t('above_upper'):(itemSignals.signal?.bb_position||0)<0?t('below_lower'):t('in_band')"></p>
              </div>
              <div class="card p-3 text-center">
                <p class="text-[10px] text-slate-600 mb-1"><span x-text="nameLang==='cn'?'7D åŠ¨é‡':'7D Momentum'"></span>
                  <span class="info-tip"><span class="inline-block w-3 h-3 rounded-full text-[8px] leading-3 text-center bg-slate-800 text-slate-500 ml-0.5">i</span>
                    <span class="tip-text" x-text="nameLang==='cn'?'7å¤©ä»·æ ¼å˜åŒ–ç‡ã€‚(ä»Šä»·-7å¤©å‰ä»·)/7å¤©å‰ä»·Ã—100%ã€‚æ­£å€¼=ä¸Šæ¶¨è¶‹åŠ¿ï¼Œè´Ÿå€¼=ä¸‹è·Œè¶‹åŠ¿ã€‚':'7-day price change rate. Positive=uptrend, Negative=downtrend.'"></span></span></p>
                <p class="text-xl font-bold font-mono" :class="pnlClass(itemSignals.signal?.momentum_7||0)" x-text="itemSignals.signal?.momentum_7!==null?(itemSignals.signal.momentum_7>0?'+':'')+itemSignals.signal.momentum_7+'%':'â€”'"></p>
              </div>
              <div class="card p-3 text-center">
                <p class="text-[10px] text-slate-600 mb-1"><span x-text="nameLang==='cn'?'30D åŠ¨é‡':'30D Momentum'"></span>
                  <span class="info-tip"><span class="inline-block w-3 h-3 rounded-full text-[8px] leading-3 text-center bg-slate-800 text-slate-500 ml-0.5">i</span>
                    <span class="tip-text" x-text="nameLang==='cn'?'30å¤©ä»·æ ¼å˜åŒ–ç‡ã€‚åæ˜ ä¸­æœŸè¶‹åŠ¿æ–¹å‘å’ŒåŠ›åº¦ã€‚>10% å¼ºåŠ¿ä¸Šæ¶¨ï¼Œ<-10% æ˜¾è‘—ä¸‹è·Œã€‚':'30-day price change rate. >10% strong rally, <-10% significant decline.'"></span></span></p>
                <p class="text-xl font-bold font-mono" :class="pnlClass(itemSignals.signal?.momentum_30||0)" x-text="itemSignals.signal?.momentum_30!==null?(itemSignals.signal.momentum_30>0?'+':'')+itemSignals.signal.momentum_30+'%':'â€”'"></p>
              </div>
              <div class="card p-3 text-center">
                <p class="text-[10px] text-slate-600 mb-1"><span x-text="nameLang==='cn'?'æ³¢åŠ¨ç‡':'Volatility'"></span>
                  <span class="info-tip"><span class="inline-block w-3 h-3 rounded-full text-[8px] leading-3 text-center bg-slate-800 text-slate-500 ml-0.5">i</span>
                    <span class="tip-text" x-text="nameLang==='cn'?'30æ—¥å¹´åŒ–æ³¢åŠ¨ç‡ã€‚åŸºäºæ¯æ—¥æ”¶ç›Šç‡æ ‡å‡†å·®Ã—âˆš365ã€‚é«˜æ³¢åŠ¨=ä»·æ ¼ä¸ç¨³å®š/äº¤æ˜“æœºä¼šå¤§ï¼Œä½æ³¢åŠ¨=ç¨³å®šã€‚':'30D annualized volatility. High=unstable/trading opportunities, Low=stable.'"></span></span></p>
                <p class="text-xl font-bold font-mono text-slate-300" x-text="itemSignals.signal?.volatility_30?itemSignals.signal.volatility_30+'%':'â€”'"></p>
              </div>
              <div class="card p-3 text-center">
                <p class="text-[10px] text-slate-600 mb-1"><span x-text="nameLang==='cn'?'ATH è·ç¦»':'ATH Distance'"></span>
                  <span class="info-tip"><span class="inline-block w-3 h-3 rounded-full text-[8px] leading-3 text-center bg-slate-800 text-slate-500 ml-0.5">i</span>
                    <span class="tip-text" x-text="nameLang==='cn'?'å½“å‰ä»·æ ¼å å†å²æœ€é«˜ä»·çš„ç™¾åˆ†æ¯”ã€‚>90% æ¥è¿‘å³°å€¼(è€ƒè™‘å‡ºå”®)ï¼Œ<50% è¿œç¦»é«˜ç‚¹(å¯èƒ½ä½ä¼°)ã€‚':'Price as % of all-time high. >90% near peak (sell?), <50% far from ATH.'"></span></span></p>
                <p class="text-xl font-bold font-mono" :class="(itemSignals.signal?.ath_pct||0)>90?'text-yellow-300':'text-slate-300'" x-text="itemSignals.signal?.ath_pct?itemSignals.signal.ath_pct+'%':'â€”'"></p>
                <p class="text-[9px] mt-0.5 text-slate-600" x-text="itemSignals.signal?.ath_price?'ATH Â¥'+itemSignals.signal.ath_price:''"></p>
              </div>
              <!-- Rental Yield -->
              <div class="card p-3 text-center">
                <p class="text-[10px] text-slate-600 mb-1"><span x-text="t('rental_yield')"></span>
                  <span class="info-tip"><span class="inline-block w-3 h-3 rounded-full text-[8px] leading-3 text-center bg-slate-800 text-slate-500 ml-0.5">i</span>
                    <span class="tip-text" x-text="t('rental_yield_desc')"></span></span></p>
                <p class="text-xl font-bold font-mono"
                  :class="rentalYield(itemSignals)>15?'text-emerald-400':rentalYield(itemSignals)>8?'text-yellow-300':rentalYield(itemSignals)>0?'text-orange-400':'text-slate-500'"
                  x-text="rentalYield(itemSignals)>0?rentalYield(itemSignals)+'%':'â€”'"></p>
                <p class="text-[9px] mt-0.5 text-slate-600" x-text="rentalYield(itemSignals)>15?(nameLang==='cn'?'é«˜æ”¶ç›Š':'High'):rentalYield(itemSignals)>8?(nameLang==='cn'?'ä¸­ç­‰':'Medium'):rentalYield(itemSignals)>0?(nameLang==='cn'?'åä½':'Low'):''"></p>
              </div>
            </div>

            <!-- Sell Score + Ownership -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
              <div class="card p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-[10px] text-slate-600 uppercase tracking-widest mb-1"><span x-text="t('sell_score_title')"></span>
                      <span class="info-tip"><span class="inline-block w-3 h-3 rounded-full text-[8px] leading-3 text-center bg-slate-800 text-slate-500 ml-0.5">i</span>
                        <span class="tip-text" x-text="t('sell_score_desc')"></span></span></p>
                    <p class="text-3xl font-bold font-mono" :class="scoreColor(itemSignals.signal?.sell_score)" x-text="itemSignals.signal?.sell_score??'â€”'"></p>
                    <p class="text-xs mt-1" :class="scoreColor(itemSignals.signal?.sell_score)" x-text="scoreLabel(itemSignals.signal?.sell_score)"></p>
                  </div>
                  <div class="text-right">
                    <p class="text-[10px] text-slate-600 uppercase tracking-widest mb-1"><span x-text="t('buy_opp_title')"></span> <span class="text-[8px] px-1 py-0.5 rounded bg-cyan-900/30 text-cyan-500 normal-case tracking-normal" x-text="t('buy_opp_beta')"></span></p>
                    <p class="text-xl font-bold font-mono text-cyan-400" x-text="itemSignals.signal?.opportunity_score??'â€”'"></p>
                    <p class="text-[9px] text-slate-700 mt-0.5" x-text="t('buy_opp_note')"></p>
                  </div>
                </div>
              </div>
              <div class="card p-4" x-show="itemSignals.ownership">
                <p class="text-[10px] text-slate-600 uppercase tracking-widest mb-2" x-text="t('ownership_title')"></p>
                <div class="space-y-1.5 text-xs">
                  <div class="flex justify-between"><span class="text-slate-500" x-text="t('ownership_buy')"></span><span class="font-mono text-slate-300" x-text="itemSignals.ownership?.purchase_price?'Â¥'+itemSignals.ownership.purchase_price:t('unknown')"></span></div>
                  <div class="flex justify-between"><span class="text-slate-500" x-text="t('ownership_current')"></span><span class="font-mono text-slate-300" x-text="itemSignals.ownership?.current_price?'Â¥'+itemSignals.ownership.current_price:'â€”'"></span></div>
                  <div class="flex justify-between"><span class="text-slate-500" x-text="t('ownership_pnl')"></span>
                    <span class="font-mono font-bold" :class="pnlClass(itemSignals.ownership?.pnl||0)"
                      x-text="itemSignals.ownership?.pnl!==null?((itemSignals.ownership.pnl>=0?'+':'')+'Â¥'+itemSignals.ownership.pnl+' ('+itemSignals.ownership.pnl_pct+'%)'):'â€”'"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cross-platform prices -->
            <div class="card overflow-hidden" x-show="itemSignals.platforms?.length">
              <div class="px-4 py-3 border-b" style="border-color:rgba(51,65,85,0.3)">
                <p class="text-[11px] text-slate-500 font-medium" x-text="t('cross_platform')"></p>
              </div>
              <table class="w-full text-xs">
                <thead><tr class="text-[10px] text-slate-600 uppercase" style="background:rgba(15,23,42,0.5)">
                  <th class="py-2 px-3 text-left" x-text="t('th_platform')"></th>
                  <th class="py-2 px-2 text-right" x-text="nameLang==='cn'?'å–ä»·':'Sell'"></th>
                  <th class="py-2 px-2 text-right" x-text="nameLang==='cn'?'æ±‚è´­ä»·':'Bid'"></th>
                  <th class="py-2 px-2 text-right" x-text="nameLang==='cn'?'åœ¨å”®':'Listed'"></th>
                </tr></thead>
                <tbody>
                  <template x-for="p in itemSignals.platforms">
                    <tr class="border-t" style="border-color:rgba(51,65,85,0.2)">
                      <td class="py-2 px-3 text-slate-300" x-text="p.platform"></td>
                      <td class="py-2 px-2 text-right font-mono text-slate-300" x-text="p.sell_price?'Â¥'+p.sell_price:'â€”'"></td>
                      <td class="py-2 px-2 text-right font-mono text-slate-400" x-text="p.bidding_price?'Â¥'+p.bidding_price:'â€”'"></td>
                      <td class="py-2 px-2 text-right font-mono text-slate-500" x-text="p.sell_count??'â€”'"></td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
        </template>
        <div x-show="!itemSignals">
          <p class="text-xs text-slate-600 mb-3" x-text="t('recommend_hint')"></p>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" x-show="analysisTopItems.length">
            <template x-for="ti in analysisTopItems">
              <div class="card p-3 cursor-pointer hover:ring-1 hover:ring-slate-600 transition-all"
                @click="analysisSelectedItem=ti.market_hash_name; analysisSearch=ti.market_hash_name; loadItemSignals(ti.market_hash_name)">
                <div class="flex items-center gap-2 mb-2">
                  <div class="w-8 h-8 rounded overflow-hidden flex-shrink-0" style="background:rgba(20,30,48,0.8)" x-show="ti.icon_url">
                    <img :src="iconUrl(ti.icon_url)" class="w-full h-full object-cover" @error="$el.style.opacity='0'" loading="lazy" />
                  </div>
                  <div class="min-w-0">
                    <p class="text-xs font-medium truncate" :style="rarityStyle(ti.market_hash_name)"
                      x-text="nameLang==='cn' ? (ti.name||ti.market_hash_name) : ti.market_hash_name"></p>
                    <p class="text-[10px] truncate" style="color:#475569"
                      x-text="nameLang==='cn' ? ti.market_hash_name : (ti.name||'')"></p>
                  </div>
                </div>
                <div class="flex items-center gap-3 text-[10px]">
                  <span class="font-mono" :class="scoreColor(ti.sell_score)">Score <span x-text="ti.sell_score??'â€”'"></span></span>
                  <span class="text-slate-500" x-text="ti.rsi_14?'RSI '+ti.rsi_14:'RSI â€”'"></span>
                  <span class="font-mono" :class="pnlClass(ti.momentum_30||0)"
                    x-text="ti.momentum_30!=null?((ti.momentum_30>0?'+':'')+ti.momentum_30+'%'):'â€”'"></span>
                </div>
              </div>
            </template>
          </div>
          <div x-show="!analysisTopItems.length" class="card p-8 text-center text-slate-700 text-xs" x-text="t('no_recommend')"></div>
        </div>
      </div>

      <!-- â”€â”€ Sub: Alerts â”€â”€ -->
      <div x-show="analysisTab==='alerts'">
        <div class="flex items-center gap-3 mb-4">
          <select x-model="alertFilter.severity" @change="loadAlerts(1)"
            class="px-3 py-2 rounded-lg text-xs" style="background:rgba(15,23,42,0.8); border:1px solid rgba(51,65,85,0.3); color:#94a3b8">
            <option value="" x-text="t('all_levels')"></option>
            <option value="critical" x-text="t('level_critical')"></option>
            <option value="warning" x-text="t('level_warning')"></option>
            <option value="info" x-text="t('level_info')"></option>
          </select>
          <select x-model="alertFilter.type" @change="loadAlerts(1)"
            class="px-3 py-2 rounded-lg text-xs" style="background:rgba(15,23,42,0.8); border:1px solid rgba(51,65,85,0.3); color:#94a3b8">
            <option value="" x-text="t('all_types_alert')"></option>
            <option value="profit_50">Profit>50%</option>
            <option value="profit_100">Profit>100%</option>
            <option value="near_ath">Near ATH</option>
            <option value="rsi_overbought">RSI OB</option>
            <option value="rsi_oversold">RSI OS</option>
            <option value="momentum_surge">Momentum</option>
            <option value="spread_arb">Spread</option>
          </select>
          <label class="flex items-center gap-1.5 text-xs text-slate-500">
            <input type="checkbox" x-model="alertFilter.unreadOnly" @change="loadAlerts(1)" class="rounded" /> <span x-text="t('unread_only')"></span>
          </label>
          <button @click="markAllAlertsRead()" class="ml-auto px-3 py-1.5 rounded-lg text-xs bg-slate-700 hover:bg-slate-600 text-slate-300" x-text="t('btn_mark_all_read')"></button>
        </div>

        <div class="space-y-2">
          <template x-for="a in analysisAlerts.items">
            <div class="card px-4 py-3 flex items-start gap-3" :class="a.is_read?'opacity-60':''">
              <span class="mt-0.5 w-2 h-2 rounded-full flex-shrink-0"
                :class="a.severity==='critical'?'bg-red-500':a.severity==='warning'?'bg-yellow-500':'bg-blue-500'"></span>
              <div class="flex-1 min-w-0">
                <p class="text-xs font-medium text-slate-300 truncate" x-text="a.title"></p>
                <p class="text-[10px] text-slate-600 mt-0.5" x-text="a.detail"></p>
                <p class="text-[10px] text-slate-700 mt-0.5" x-text="a.created_at?.replace('T',' ').slice(0,16)"></p>
              </div>
              <div class="flex gap-2 flex-shrink-0">
                <button x-show="!a.is_read" @click="markAlertRead(a)" class="text-[10px] text-slate-500 hover:text-slate-300" x-text="t('btn_read')"></button>
                <button @click="analysisSelectedItem=a.market_hash_name; analysisTab='detail'; loadItemSignals(a.market_hash_name)"
                  class="text-[10px] text-blue-400 hover:text-blue-300" x-text="t('btn_view')"></button>
              </div>
            </div>
          </template>
          <div x-show="!analysisAlerts.items?.length" class="card p-8 text-center text-slate-600 text-sm" x-text="t('no_alerts')"></div>
        </div>

        <!-- Pagination -->
        <div x-show="analysisAlerts.total>20" class="flex items-center justify-between mt-3 text-xs text-slate-600">
          <span><span x-text="t('total_records')"></span> <span class="text-slate-400" x-text="analysisAlerts.total"></span></span>
          <div class="flex gap-2">
            <button @click="loadAlerts(alertPage-1)" :disabled="alertPage<=1" class="px-3 py-1 rounded bg-slate-800 disabled:opacity-30">â€¹</button>
            <button @click="loadAlerts(alertPage+1)" :disabled="alertPage*20>=analysisAlerts.total" class="px-3 py-1 rounded bg-slate-800 disabled:opacity-30">â€º</button>
          </div>
        </div>
      </div>

      <!-- â”€â”€ Sub: Spreads â”€â”€ -->
      <div x-show="analysisTab==='spreads'">
        <div class="flex items-center gap-3 mb-4">
          <label class="text-xs text-slate-500" x-text="t('min_spread')"></label>
          <input type="number" x-model.number="minSpread" @change="loadSpreads(1)" min="0" step="1"
            class="w-20 px-2 py-1.5 rounded-lg text-xs font-mono" style="background:rgba(15,23,42,0.8); border:1px solid rgba(51,65,85,0.3); color:#e2e8f0" />
        </div>

        <div class="card overflow-hidden">
          <table class="w-full text-xs">
            <thead><tr class="text-[10px] text-slate-600 uppercase" style="background:rgba(15,23,42,0.5)">
              <th class="py-2 px-3 text-left" x-text="t('th_item')"></th>
              <th class="py-2 px-2 text-right">Min</th>
              <th class="py-2 px-2 text-right">Max</th>
              <th class="py-2 px-2 text-right">Spread%</th>
              <th class="py-2 px-2 text-right">#</th>
              <th class="py-2 px-2 text-left">Detail</th>
            </tr></thead>
            <tbody>
              <template x-for="s in analysisSpreads.items">
                <tr class="border-t hover:bg-slate-800/30" style="border-color:rgba(51,65,85,0.2)">
                  <td class="py-2 px-3 text-slate-300 truncate max-w-[200px] cursor-pointer"
                    @click="analysisSelectedItem=s.market_hash_name; analysisTab='detail'; loadItemSignals(s.market_hash_name)"
                    :title="s.market_hash_name" x-text="s.market_hash_name"></td>
                  <td class="py-2 px-2 text-right font-mono text-emerald-400" x-text="'Â¥'+s.min_price"></td>
                  <td class="py-2 px-2 text-right font-mono text-red-400" x-text="'Â¥'+s.max_price"></td>
                  <td class="py-2 px-2 text-right font-mono font-bold text-yellow-300" x-text="s.spread_pct+'%'"></td>
                  <td class="py-2 px-2 text-right text-slate-400" x-text="s.platform_count"></td>
                  <td class="py-2 px-2 text-[10px] text-slate-500">
                    <template x-for="p in s.platforms">
                      <span class="mr-2" x-text="p.platform+'Â¥'+p.sell_price"></span>
                    </template>
                  </td>
                </tr>
              </template>
              <tr x-show="!analysisSpreads.items?.length"><td colspan="6" class="py-6 text-center text-slate-600" x-text="t('no_arb_data')"></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â• INVENTORY TAB â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div x-show="activeTab==='inventory'">

      <!-- Mini strip -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
        <div class="card px-4 py-3">
          <p class="text-[11px] text-slate-600 mb-0.5" x-text="t('mini_cost')"></p>
          <p class="text-base font-bold text-white">Â¥<span x-text="fmt(overview.total_cost)">â€”</span></p>
        </div>
        <div class="card px-4 py-3">
          <p class="text-[11px] text-slate-600 mb-0.5" x-text="t('mini_active')"></p>
          <p class="text-base font-bold text-white" x-text="overview.total_active??'â€”'"></p>
        </div>
        <div class="card px-4 py-3">
          <p class="text-[11px] text-slate-600 mb-0.5" x-text="t('mini_coverage')"></p>
          <p class="text-base font-bold">
            <span class="text-white" x-text="overview.priced_count??'â€”'"></span>
            <span class="text-slate-700 text-sm"> / </span>
            <span class="text-slate-500 text-sm" x-text="overview.total_active??'â€”'"></span>
          </p>
        </div>
        <div class="card px-4 py-3">
          <p class="text-[11px] text-slate-600 mb-0.5" x-text="t('mini_manual')"></p>
          <p class="text-base font-bold text-yellow-300" x-text="overview.manual_price_count??'â€”'"></p>
        </div>
      </div>

      <!-- Filter bar -->
      <div class="card px-4 py-3 mb-4">
        <div class="flex flex-wrap items-center gap-2">

          <!-- Search -->
          <div class="relative flex-1 min-w-[180px]">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 pointer-events-none"
              style="color:#475569" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input type="text" x-model="filters.search"
              @input.debounce.400ms="page=1; loadItems()"
              :placeholder="t('search_placeholder')"
              class="w-full pl-9 pr-3 py-2 rounded-xl text-sm border" />
          </div>

          <!-- Status -->
          <select x-model="filters.status" @change="page=1; loadItems()"
            class="py-2 pl-3 rounded-xl text-sm border" style="min-width: 108px">
            <option value="" x-text="t('all_status')"></option>
            <option value="rented_out" x-text="t('status_rented')"></option>
            <option value="in_steam" x-text="t('status_steam')"></option>
            <option value="in_storage" x-text="t('status_storage')"></option>
          </select>

          <!-- Category filter -->
          <select x-model="filters.category" @change="page=1; loadItems()"
            class="py-2 pl-3 rounded-xl text-sm border" style="min-width: 100px">
            <option value="" x-text="t('all_types')"></option>
            <optgroup :label="nameLang==='cn'?'è¿‘æˆ˜':'Melee'">
              <option value="knife" x-text="t('cat_knife')"></option>
              <option value="glove" x-text="t('cat_glove')"></option>
            </optgroup>
            <optgroup :label="nameLang==='cn'?'æªæ¢°':'Weapons'">
              <option value="pistol" x-text="t('cat_pistol')"></option>
              <option value="rifle" x-text="t('cat_rifle')"></option>
              <option value="sniper" x-text="t('cat_sniper')"></option>
              <option value="smg" x-text="t('cat_smg')"></option>
              <option value="shotgun" x-text="t('cat_shotgun')"></option>
              <option value="mg" x-text="t('cat_mg')"></option>
            </optgroup>
            <optgroup :label="nameLang==='cn'?'é¥°å“':'Cosmetics'">
              <option value="sticker" x-text="t('cat_sticker')"></option>
              <option value="patch" x-text="nameLang==='cn'?'å¸ƒç« ':'Patch'"></option>
              <option value="graffiti" x-text="nameLang==='cn'?'æ¶‚é¸¦':'Graffiti'"></option>
              <option value="charm" x-text="nameLang==='cn'?'æŒ‚ä»¶':'Charm'"></option>
              <option value="musickit" x-text="nameLang==='cn'?'éŸ³ä¹ç›’':'Music Kit'"></option>
              <option value="agent" x-text="nameLang==='cn'?'ç‰¹å·¥':'Agent'"></option>
            </optgroup>
            <optgroup :label="nameLang==='cn'?'å®¹å™¨':'Containers'">
              <option value="case" x-text="t('cat_case')"></option>
              <option value="key" x-text="nameLang==='cn'?'é’¥åŒ™/é€šè¡Œè¯':'Key/Pass'"></option>
            </optgroup>
            <optgroup :label="nameLang==='cn'?'å“è´¨':'Quality'">
              <option value="stattrak">StatTrakâ„¢</option>
              <option value="souvenir" x-text="nameLang==='cn'?'çºªå¿µå“':'Souvenir'"></option>
            </optgroup>
            <optgroup :label="nameLang==='cn'?'ç£¨æŸ':'Wear'">
              <option value="fn" x-text="nameLang==='cn'?'å´­æ–°å‡ºå‚ FN':'Factory New'"></option>
              <option value="mw" x-text="nameLang==='cn'?'ç•¥æœ‰ç£¨æŸ MW':'Minimal Wear'"></option>
              <option value="ft" x-text="nameLang==='cn'?'ä¹…ç»æ²™åœº FT':'Field-Tested'"></option>
              <option value="ww" x-text="nameLang==='cn'?'ç ´æŸä¸å ª WW':'Well-Worn'"></option>
              <option value="bs" x-text="nameLang==='cn'?'æˆ˜ç—•ç´¯ç´¯ BS':'Battle-Scarred'"></option>
            </optgroup>
          </select>

          <!-- Priced filter -->
          <select x-model="filters.pricedFilter" @change="page=1; loadItems()"
            class="py-2 pl-3 rounded-xl text-sm border" style="min-width: 96px">
            <option value="" x-text="t('all_filter')"></option>
            <option value="priced" x-text="t('priced')"></option>
            <option value="unpriced" x-text="t('unpriced')"></option>
          </select>

          <!-- Show sold toggle -->
          <label class="pill-toggle" :class="showSold ? 'active-slate' : ''"
            @click="showSold=!showSold; page=1; loadItems()">
            <span x-text="t('show_sold')"></span>
            <div class="relative toggle-track" :style="showSold ? 'background:#475569' : 'background:#1e293b'">
              <div class="toggle-thumb" :style="showSold ? 'transform:translateX(12px)' : ''"></div>
            </div>
          </label>

          <!-- Dual price toggle -->
          <label class="pill-toggle" :class="dualPrice ? 'active-blue' : ''"
            @click="dualPrice=!dualPrice">
            <span x-text="t('dual_price')"></span>
            <div class="relative toggle-track" :style="dualPrice ? 'background:#1d4ed8' : 'background:#1e293b'">
              <div class="toggle-thumb" :style="dualPrice ? 'transform:translateX(12px)' : ''"></div>
            </div>
          </label>

          <!-- Cost sort shortcut -->
          <button @click="setSort('effective_price')"
            class="pill-toggle" :class="sortBy==='effective_price' ? 'active-blue' : ''">
            <span x-text="t('cost_sort')"></span> <span x-text="sortBy==='effective_price'?(sortOrder==='desc'?'â†“':'â†‘'):'â†•'"></span>
          </button>

          <!-- Page size -->
          <select x-model.number="pageSize" @change="page=1; loadItems()"
            class="py-2 pl-3 rounded-xl text-sm border ml-auto" style="width: 70px">
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
          </select>
        </div>
      </div>

      <!-- Table -->
      <div class="card overflow-hidden">
        <div class="tbl-wrap">
          <table class="w-full text-xs" style="border-collapse: separate; border-spacing: 0;">
            <thead>
              <tr style="border-bottom: 1px solid rgba(51,65,85,0.3);">
                <th class="py-3 px-4 text-left font-normal text-slate-700 uppercase tracking-wider w-8">#</th>
                <th class="py-3 px-4 text-left font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_item')"></th>
                <th class="py-3 px-3 text-left font-normal text-slate-700 uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" @click="setSort('status')">
                  <span x-text="t('th_status')"></span> <span x-text="sortIcon('status')"></span>
                </th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" @click="setSort('abrade')">
                  <span x-text="t('th_abrade')"></span> <span x-text="sortIcon('abrade')"></span>
                </th>
                <template x-if="!dualPrice">
                  <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" @click="setSort('effective_price')">
                    <span x-text="t('th_cost')"></span> <span x-text="sortIcon('effective_price')"></span>
                  </th>
                </template>
                <template x-if="dualPrice">
                  <th class="py-3 px-3 text-right font-normal uppercase tracking-wider" style="color:#475569" x-text="t('th_auto_price')"></th>
                </template>
                <template x-if="dualPrice">
                  <th class="py-3 px-3 text-right font-normal uppercase tracking-wider" style="color:rgba(202,138,4,0.7)" x-text="t('th_manual_price')"></th>
                </template>
                <th class="py-3 px-3 text-right font-normal uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" style="color:#047857" @click="setSort('current_price')">
                  <span x-text="t('th_market_price')"></span> <span x-text="sortIcon('current_price')"></span>
                </th>
                <th class="py-3 px-2 text-right font-normal uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" style="color:#475569" @click="setSort('pnl')">
                  <span x-text="t('th_pnl')"></span> <span x-text="sortIcon('pnl')"></span>
                </th>
                <th class="py-3 px-2 text-right font-normal uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" style="color:#475569" @click="setSort('pnl_pct')">
                  <span x-text="t('th_pnl_pct')"></span> <span x-text="sortIcon('pnl_pct')"></span>
                </th>
                <th class="py-3 px-3 text-right font-normal text-slate-700 uppercase tracking-wider hover:text-slate-400 cursor-pointer select-none transition-colors" @click="setSort('purchase_date')">
                  <span x-text="t('th_date')"></span> <span x-text="sortIcon('purchase_date')"></span>
                </th>
                <th class="py-3 px-3 text-left font-normal text-slate-700 uppercase tracking-wider" x-text="t('th_platform')"></th>
                <th class="py-3 px-4 w-10"></th>
              </tr>
            </thead>
            <tbody>
              <!-- Loading -->
              <template x-if="loading">
                <tr>
                  <td :colspan="dualPrice ? 12 : 11" class="py-24 text-center" style="color:#334155">
                    <div class="flex flex-col items-center gap-3">
                      <div class="w-6 h-6 rounded-full border-2 border-t-blue-500 animate-spin" style="border-color: rgba(51,65,85,0.4); border-top-color: #3b82f6"></div>
                      <span class="text-xs" x-text="t('loading')"></span>
                    </div>
                  </td>
                </tr>
              </template>

              <!-- Empty -->
              <template x-if="!loading && items.length === 0">
                <tr>
                  <td :colspan="dualPrice ? 12 : 11" class="py-24 text-center text-xs" style="color:#334155"
                    x-text="t('no_match')">
                  </td>
                </tr>
              </template>

              <!-- Rows -->
              <template x-for="(item, idx) in items" :key="item.id">
                <tr class="tbl-row" @click="openPanel(item)">
                  <td class="py-2.5 px-4 font-mono" style="color:#334155" x-text="(page-1)*pageSize+idx+1"></td>

                  <!-- Item name + icon -->
                  <td class="py-2.5 px-4">
                    <div class="flex items-center gap-2.5">
                      <div class="w-9 h-9 rounded-lg overflow-hidden flex-shrink-0" style="background:rgba(20,30,48,0.8)">
                        <img :src="iconUrl(item.icon_url)" class="w-full h-full object-cover"
                          @error="$el.style.opacity='0'" loading="lazy" />
                      </div>
                      <div class="min-w-0">
                        <p class="font-medium leading-tight truncate" style="max-width:260px"
                          :style="rarityStyle(item.market_hash_name, item.item_type)"
                          x-text="nameLang==='cn' ? (item.name || item.market_hash_name) : item.market_hash_name"></p>
                        <p class="leading-tight truncate mt-0.5" style="max-width:260px; color:#334155"
                          x-text="nameLang==='cn' ? item.market_hash_name : item.name"></p>
                      </div>
                    </div>
                  </td>

                  <!-- Status badge -->
                  <td class="py-2.5 px-3">
                    <span class="px-2 py-0.5 rounded-full text-[11px] font-medium tracking-wide"
                      :class="statusCls(item.status)" x-text="statusLbl(item.status)"></span>
                  </td>

                  <!-- Abrade -->
                  <td class="py-2.5 px-3 text-right font-mono" style="color:#334155"
                    x-text="item.abrade!=null ? item.abrade.toFixed(6) : 'â€”'"></td>

                  <!-- Single price -->
                  <template x-if="!dualPrice">
                    <td class="py-2.5 px-3 text-right">
                      <span x-show="item.effective_price!=null" class="font-semibold"
                        :class="item.purchase_price_manual!=null ? 'text-yellow-300' : 'text-slate-100'"
                        x-text="'Â¥'+fmt(item.effective_price)"></span>
                      <span x-show="item.effective_price==null" style="color:#1e293b">â€”</span>
                    </td>
                  </template>

                  <!-- Auto price (dual) -->
                  <template x-if="dualPrice">
                    <td class="py-2.5 px-3 text-right" style="color:#475569">
                      <span x-show="item.purchase_price!=null" x-text="'Â¥'+fmt(item.purchase_price)"></span>
                      <span x-show="item.purchase_price==null" style="color:#1e293b">â€”</span>
                    </td>
                  </template>

                  <!-- Manual price (dual) -->
                  <template x-if="dualPrice">
                    <td class="py-2.5 px-3 text-right">
                      <span x-show="item.purchase_price_manual!=null"
                        class="text-yellow-300 font-semibold"
                        x-text="'Â¥'+fmt(item.purchase_price_manual)"></span>
                      <span x-show="item.purchase_price_manual==null" style="color:#1e293b">â€”</span>
                    </td>
                  </template>

                  <!-- Current market price -->
                  <td class="py-2.5 px-3 text-right font-mono">
                    <span x-show="item.current_price != null"
                      class="text-emerald-400/80 text-xs"
                      x-text="'Â¥'+fmt(item.current_price)"></span>
                    <span x-show="item.current_price == null" style="color:#1e293b">â€”</span>
                  </td>

                  <!-- P&L amount -->
                  <td class="py-2.5 px-2 text-right font-mono">
                    <span x-show="item.pnl != null" class="text-xs font-semibold" :class="pnlClass(item.pnl)"
                      x-text="(item.pnl >= 0 ? '+Â¥' : '-Â¥') + fmt(Math.abs(item.pnl))"></span>
                    <span x-show="item.pnl == null" class="text-slate-700">â€”</span>
                  </td>
                  <!-- P&L % -->
                  <td class="py-2.5 px-2 text-right font-mono">
                    <span x-show="item.pnl_pct != null" class="text-xs font-semibold" :class="pnlClass(item.pnl_pct)"
                      x-text="(item.pnl_pct >= 0 ? '+' : '') + item.pnl_pct + '%'"></span>
                    <span x-show="item.pnl_pct == null" class="text-slate-700">â€”</span>
                  </td>

                  <!-- Date -->
                  <td class="py-2.5 px-3 text-right font-mono" style="color:#334155" x-text="item.purchase_date||'â€”'"></td>

                  <!-- Platform -->
                  <td class="py-2.5 px-3" style="color:#334155" x-text="item.purchase_platform||'â€”'"></td>

                  <!-- Edit btn -->
                  <td class="py-2.5 px-4 text-center">
                    <div class="w-6 h-6 rounded-md flex items-center justify-center transition-colors"
                      style="background: rgba(30,41,59,0.5); color:#334155"
                      @mouseenter="$el.style.color='#94a3b8'" @mouseleave="$el.style.color='#334155'">
                      <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                      </svg>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="px-5 py-3 flex items-center justify-between"
          style="border-top: 1px solid rgba(51,65,85,0.2)">
          <p class="text-xs" style="color:#334155">
            <span x-text="t('total_records')"></span> <span class="text-slate-400 font-medium" x-text="total"></span> <span x-text="t('records_unit')"></span> Â·
            <span x-text="t('page_prefix')"></span> <span class="text-slate-500" x-text="page"></span> /
            <span class="text-slate-500" x-text="Math.max(1,Math.ceil(total/pageSize))"></span>
          </p>
          <div class="flex items-center gap-1">
            <button class="pg-btn" @click="gotoPage(page-1)" :disabled="page<=1">â€¹</button>
            <template x-for="(p,i) in pageNums" :key="i">
              <template x-if="p==='...'">
                <span class="text-xs px-1" style="color:#334155">â€¦</span>
              </template>
              <template x-if="p!=='...'">
                <button class="pg-btn" :class="p===page?'active':''" @click="gotoPage(p)" x-text="p"></button>
              </template>
            </template>
            <button class="pg-btn" @click="gotoPage(page+1)" :disabled="page>=Math.ceil(total/pageSize)">â€º</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- â”€â”€ Detail Side Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <template x-teleport="body">
    <div x-show="panel" x-cloak>
      <div class="fixed inset-0 backdrop-blur-sm"
        style="background:rgba(0,0,0,0.55); z-index:1000" @click="panel=null"></div>
      <div class="fixed top-0 right-0 h-full overflow-y-auto shadow-2xl slide-right"
        style="width:380px; background:#07101f; border-left:1px solid rgba(51,65,85,0.35); z-index:1001"
        x-show="panel">
        <div class="p-5 flex flex-col min-h-full">

          <!-- Header -->
          <div class="flex items-start gap-3 mb-4">
            <div class="flex-1 min-w-0">
              <h2 class="text-sm font-semibold text-white leading-snug" x-text="panel?.market_hash_name"></h2>
              <p class="text-xs mt-0.5" style="color:#475569" x-text="panel?.name"></p>
            </div>
            <button @click="panel=null"
              class="w-7 h-7 rounded-lg flex items-center justify-center transition-colors text-base leading-none flex-shrink-0"
              style="background:rgba(30,41,59,0.8); color:#475569"
              @mouseenter="$el.style.color='#e2e8f0'" @mouseleave="$el.style.color='#475569'">âœ•</button>
          </div>

          <!-- Image -->
          <div class="rounded-xl mb-4 flex items-center justify-center h-36 overflow-hidden"
            style="background:rgba(10,18,35,0.8); border:1px solid rgba(51,65,85,0.25)">
            <img :src="iconUrl(panel?.icon_url, 200)" class="max-h-full max-w-full object-contain"
              @error="$el.style.display='none'" x-show="panel?.icon_url" />
            <span x-show="!panel?.icon_url" class="text-xs" style="color:#1e293b">No image</span>
          </div>

          <!-- Info grid -->
          <div class="grid grid-cols-2 gap-2 mb-5">
            <template x-for="[label,val,wide,yellow] in panelFields()" :key="label">
              <div class="rounded-xl p-3" :class="wide ? 'col-span-2' : ''"
                style="background:rgba(10,18,35,0.7); border:1px solid rgba(51,65,85,0.25)">
                <p class="text-[11px] mb-1" style="color:#475569" x-text="label"></p>
                <p class="text-xs font-medium font-mono"
                  :class="yellow ? 'text-yellow-300' : 'text-slate-200'"
                  x-text="val || 'â€”'"></p>
              </div>
            </template>
          </div>

          <!-- Manual price -->
          <div class="mt-auto pt-4" style="border-top:1px solid rgba(51,65,85,0.3)">
            <div class="flex items-center justify-between mb-1">
              <p class="text-sm font-medium text-slate-200" x-text="t('manual_price_title')"></p>
              <span x-show="panel?.purchase_price_manual!=null"
                class="text-[11px] px-2 py-0.5 rounded-full font-medium"
                style="background:rgba(202,138,4,0.12); color:#fbbf24" x-text="t('manual_price_set')"></span>
            </div>
            <p class="text-[11px] mb-3" style="color:#334155" x-text="t('manual_price_desc')"></p>
            <div class="flex gap-2">
              <input type="number" x-model="manualInput" :placeholder="nameLang==='cn'?'é‡‘é¢ï¼ˆå…ƒï¼‰':'Amount (Â¥)'" step="0.01" min="0"
                @keydown.enter="saveManual()"
                class="flex-1 px-3 py-2 rounded-xl text-sm border" />
              <button @click="saveManual()" :disabled="saving"
                class="px-4 py-2 rounded-xl text-sm font-semibold text-slate-900 transition-all disabled:opacity-40"
                style="background:linear-gradient(135deg,#d97706,#b45309); box-shadow:0 0 12px rgba(217,119,6,0.2)">
                <span x-show="!saving" x-text="t('btn_save')"></span><span x-show="saving">â€¦</span>
              </button>
            </div>
            <button x-show="panel?.purchase_price_manual!=null" @click="clearManual()"
              class="mt-2 text-[11px] transition-colors"
              style="color:rgba(239,68,68,0.5)"
              @mouseenter="$el.style.color='rgba(239,68,68,0.8)'"
              @mouseleave="$el.style.color='rgba(239,68,68,0.5)'"
              x-text="'Ã— '+t('btn_clear_manual')">
            </button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- â”€â”€ Import Result Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <template x-teleport="body">
    <div x-show="importResult" x-cloak
      class="fixed inset-0 flex items-center justify-center backdrop-blur-sm"
      style="background:rgba(0,0,0,0.65); z-index:9999"
      @click.self="importResult=null; loadAll()"
      @keydown.escape.window="importResult=null; loadAll()">
      <div class="flex flex-col rounded-2xl shadow-2xl fade-up"
        style="background:#07101f; border:1px solid rgba(51,65,85,0.4); width:420px; max-width:95vw; max-height:80vh">
        <!-- Header -->
        <div class="flex items-center justify-between px-5 pt-5 pb-3 flex-shrink-0">
          <div class="flex items-center gap-2">
            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs"
              style="background:rgba(34,197,94,0.12); color:#22c55e">âœ“</div>
            <h3 class="text-sm font-semibold text-white" x-text="t('import_done')"></h3>
          </div>
          <button @click="importResult=null; loadAll()"
            class="w-7 h-7 rounded-lg flex items-center justify-center text-base leading-none transition-colors"
            style="background:rgba(30,41,59,0.8); color:#475569"
            @mouseenter="$el.style.color='#e2e8f0'" @mouseleave="$el.style.color='#475569'">âœ•</button>
        </div>
        <!-- Scrollable content -->
        <div class="px-5 pb-3 overflow-y-auto flex-1 space-y-2">
          <template x-for="[sec,data] in Object.entries(importResult||{})" :key="sec">
            <div class="rounded-xl p-3.5" style="background:rgba(10,18,35,0.7); border:1px solid rgba(51,65,85,0.25)">
              <p class="text-xs font-semibold text-slate-300 mb-2.5" x-text="importLbl(sec)"></p>
              <template x-if="typeof data==='object' && data!==null">
                <div class="space-y-1.5">
                  <template x-for="[k,v] in importFields(data)" :key="k">
                    <div class="flex justify-between items-center">
                      <span class="text-[11px]" style="color:#475569" x-text="k"></span>
                      <span class="text-[11px] text-slate-200 font-mono font-medium" x-text="v"></span>
                    </div>
                  </template>
                </div>
              </template>
              <template x-if="typeof data!=='object' || data===null">
                <span class="text-[11px] text-slate-300 font-mono" x-text="data"></span>
              </template>
            </div>
          </template>
        </div>
        <!-- Sticky footer -->
        <div class="px-5 pb-5 pt-3 flex-shrink-0" style="border-top:1px solid rgba(51,65,85,0.25)">
          <button @click="importResult=null; loadAll()"
            class="w-full py-2.5 rounded-xl text-sm font-semibold text-white transition-all"
            style="background:linear-gradient(135deg,#1d4ed8,#2563eb); box-shadow:0 0 20px rgba(37,99,235,0.25)"
            @mouseenter="$el.style.boxShadow='0 0 28px rgba(37,99,235,0.4)'"
            @mouseleave="$el.style.boxShadow='0 0 20px rgba(37,99,235,0.25)'">
            <span x-text="t('btn_refresh_data')"></span>
          </button>
        </div>
      </div>
    </div>
  </template>

  <!-- â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <template x-teleport="body">
    <div x-show="toast.msg" x-cloak class="fixed bottom-6 right-6 toast-pop" style="z-index:9999">
      <div class="px-4 py-3 rounded-xl text-sm font-medium shadow-2xl"
        :style="toast.type==='success'
          ? 'background:rgba(21,128,61,0.95); color:#dcfce7; border:1px solid rgba(34,197,94,0.3)'
          : 'background:rgba(185,28,28,0.95); color:#fee2e2; border:1px solid rgba(239,68,68,0.3)'"
        x-text="toast.msg"></div>
    </div>
  </template>

  <script>
    function app() {
      return {
        activeTab: 'inventory',
        overview: {},
        items: [],
        total: 0,
        loading: false,

        page: 1,
        pageSize: 50,
        filters: { search: '', status: '', pricedFilter: '', category: '' },
        sortBy: 'first_seen_at',
        sortOrder: 'desc',
        dualPrice: false,
        showSold: false,

        // åç§°è¯­è¨€æ¨¡å¼: 'cn'=ä¸­æ–‡ä¼˜å…ˆ / 'en'=è‹±æ–‡ä¼˜å…ˆ
        nameLang: localStorage.getItem('nameLang') || 'cn',
        theme: localStorage.getItem('theme') || 'dark',

        // æ‰¹é‡æ™ºèƒ½æ”¹ä»·çŠ¶æ€
        batchRepricing: false,
        batchRepriceProgress: '',

        // å‡ºç§Ÿå¤§ä¼šå‘˜ç­‰çº§ (ç”± header select æ§åˆ¶)
        memberLevel: parseInt(localStorage.getItem('memberLevel') || '3'),

        // â”€â”€ é‡åŒ–åˆ†æ tab â”€â”€
        analysisTab: 'overview',
        ao: {},                      // analysis overview data
        itemSignals: null,           // selected item signals
        analysisAlerts: { items: [], total: 0 },
        analysisSpreads: { items: [], total: 0 },
        analysisSearch: '',
        analysisSearchResults: [],
        analysisTopItems: [],
        analysisSelectedItem: null,
        unreadAlertCount: 0,
        alertFilter: { severity: '', type: '', unreadOnly: false },
        alertPage: 1,
        minSpread: 5,
        chartDays: 90,
        scoreBucket: { show: false, label: '', min: 0, max: 0, items: [] },
        backfillRunning: false,
        backfillProgress: '',
        computingSignals: false,
        _priceChart: null,

        panel: null,
        manualInput: '',
        saving: false,

        importing: false,
        importProgress: -1,
        _progressTimer: null,
        importResult: null,
        lastImportAt: '',

        refreshing: false,
        refreshProgress: 0,
        _refreshPollTimer: null,

        tokenExpired: false,
        syncing: false,

        // Listing tab
        shelfTab: 'sell',
        shelfLoading: false,
        sellShelf: { items: [], total: 0 },
        leaseShelf: { items: [], total: 0 },
        rentedList: { items: [], total: 0, stats: '', page_size: 50 },
        rentedLoading: false,
        rentedPage: 1,
        subletList: { items: [], total: 0, stats: '', page_size: 50 },
        subletLoading: false,
        subletPage: 1,
        unlistedItems: { items: [], total: 0, total_inventory: 0, total_listed: 0, page_size: 50 },
        unlistedLoading: false,
        unlistedPage: 1,
        repriceModal: { show: false, item: null, newPrice: '', newLeaseUnit: '', newLongLeaseUnit: '', newDeposit: '', saving: false },
        loginModal: { show: false, phone: '', code: '', sessionId: '', smsSending: false, logging: false, cooldown: 0, manualToken: '' },
        authState: { has_token: false, token_source: 'none', nickname: null },
        selectedItems: [],
        quickList: {
          assetId: '', templateId: null, mode: 'sell',
          buyPrice: 0, takeProfitRatio: 0, useUndercut: true,
          previewing: false, listing: false, preview: null,
        },

        // Portfolio trend chart
        portfolioRange: '7d',
        portfolioData: [],
        _portfolioChart: null,
        monitorStatus: {},

        // æ¶¨è·Œè‰²æ¨¡å¼ï¼š'cn'=çº¢æ¶¨ç»¿è·Œï¼ˆé»˜è®¤ï¼‰ 'us'=ç»¿æ¶¨çº¢è·Œ
        colorMode: 'cn',

        // â”€â”€ i18n ç¿»è¯‘å­—å…¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        _i18n: {
          // Navbar tabs
          tab_inventory: ['æŒä»“åˆ—è¡¨', 'Inventory'],
          tab_overview: ['èµ„äº§æ¦‚è§ˆ', 'Overview'],
          tab_listing: ['ä¸Šæ¶ç®¡ç†', 'Listing'],
          tab_analysis: ['é‡åŒ–åˆ†æ', 'Analysis'],
          // Navbar buttons & status
          btn_sync: ['åŒæ­¥æ•°æ®', 'Sync Data'],
          btn_syncing: ['åŒæ­¥ä¸­â€¦', 'Syncingâ€¦'],
          btn_refresh_price: ['åˆ·æ–°å¸‚ä»·', 'Refresh Prices'],
          btn_login_youpin: ['ç™»å½•æ‚ æ‚ ', 'Login YouPin'],
          btn_switch_account: ['åˆ‡æ¢è´¦å·', 'Switch'],
          syncing_wait: ['åŒæ­¥ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…â€¦', 'Syncing, please waitâ€¦'],
          last_sync: ['ä¸Šæ¬¡åŒæ­¥', 'Last sync'],
          market_price: ['å¸‚ä»·', 'Price at'],
          color_cn_tip: ['çº¢æ¶¨ç»¿è·Œï¼ˆAè‚¡ï¼‰ï¼Œç‚¹å‡»åˆ‡æ¢', 'Red=Up Green=Down (CN), click to switch'],
          color_us_tip: ['ç»¿æ¶¨çº¢è·Œï¼ˆç¾è‚¡ï¼‰ï¼Œç‚¹å‡»åˆ‡æ¢', 'Green=Up Red=Down (US), click to switch'],
          // Overview
          total_cost: ['æ€»æŒä»“æˆæœ¬', 'Total Cost'],
          active_holdings: ['æ´»è·ƒæŒä»“', 'Active Holdings'],
          pricing_status: ['å®šä»·æƒ…å†µ', 'Pricing Status'],
          quick_actions: ['å¿«æ·æ“ä½œ', 'Quick Actions'],
          cost_rented: ['å‡ºç§Ÿ', 'Rented'],
          cost_steam: ['Steam', 'Steam'],
          price_coverage: ['å®šä»·è¦†ç›–', 'Coverage'],
          auto_priced: ['è‡ªåŠ¨å®šä»·', 'Auto'],
          manual_priced: ['æ‰‹åŠ¨å®šä»·', 'Manual'],
          unpriced: ['æœªå®šä»·', 'Unpriced'],
          goto_unpriced: ['æœªå®šä»·é¥°å“', 'Unpriced Items'],
          goto_rented: ['å‡ºç§Ÿä¸­', 'Rented Out'],
          goto_all: ['å…¨éƒ¨æŒä»“', 'All Holdings'],
          market_value: ['å½“å‰å¸‚å€¼', 'Market Value'],
          no_market_price: ['æš‚æ— å¸‚ä»·', 'No Price Data'],
          click_refresh: ['ç‚¹å‡»ã€Œåˆ·æ–°å¸‚ä»·ã€è·å–å®æ—¶æ•°æ®', 'Click "Refresh Prices" to get live data'],
          pnl_amount: ['ç›ˆäºé‡‘é¢', 'P&L Amount'],
          pnl_rate: ['ç›ˆäºç‡', 'P&L Rate'],
          based_on_estimate: ['åŸºäºå·²æœ‰å¸‚ä»·ä¼°ç®—', 'Based on available market prices'],
          need_data: ['éœ€è¦æˆæœ¬ä»· + å¸‚ä»·æ•°æ®', 'Need cost + price data'],
          wait_refresh: ['å¾…å¸‚ä»·åˆ·æ–°åè®¡ç®—', 'Pending price refresh'],
          status_distribution: ['æŒä»“çŠ¶æ€åˆ†å¸ƒ', 'Status Distribution'],
          portfolio_trend: ['ç»„åˆä»·å€¼èµ°åŠ¿', 'Portfolio Value Trend'],
          portfolio_no_data: ['æš‚æ— ç»„åˆå¿«ç…§æ•°æ®ï¼Œç³»ç»Ÿå°†æ¯30åˆ†é’Ÿè‡ªåŠ¨è®°å½•', 'No portfolio data yet. Snapshots are recorded every 30 minutes.'],
          data_points: ['ä¸ªæ•°æ®ç‚¹', 'data points'],
          system_monitor: ['ç³»ç»Ÿç›‘æ§', 'System Monitor'],
          sys_status: ['è¿è¡ŒçŠ¶æ€', 'Status'],
          sys_uptime: ['è¿è¡Œæ—¶é—´', 'Uptime'],
          sys_db_size: ['æ•°æ®åº“å¤§å°', 'DB Size'],
          sys_collector: ['é‡‡é›†å™¨', 'Collector'],
          btn_refresh: ['åˆ·æ–°', 'Refresh'],
          status_rented: ['å‡ºç§Ÿä¸­', 'Rented'],
          status_steam: ['Steamä¸­', 'In Steam'],
          status_storage: ['æ”¶è—', 'Storage'],
          status_sold: ['å·²å”®', 'Sold'],
          inv_value: ['åº“å­˜å¸‚å€¼', 'Inventory Value'],
          rented_value: ['å‡ºç§Ÿå¸‚å€¼', 'Rented Value'],
          covers: ['è¦†ç›–', 'Covers'],
          items_unit: ['ä»¶', 'items'],
          total_items: ['å…±', 'Total'],
          rented_value_note: ['å‡ºç§Ÿå¸‚å€¼åŸºäºå¸‚ä»·å¿«ç…§è®¡ç®—ï¼Œä¸æ‚ æ‚ å®˜æ–¹ä¼°å€¼å¯èƒ½ç•¥æœ‰å·®å¼‚', 'Rented value based on price snapshots, may differ slightly from YouPin official valuation'],
          // Inventory filters
          search_placeholder: ['æœç´¢é¥°å“åç§°â€¦', 'Search item nameâ€¦'],
          all_status: ['å…¨éƒ¨çŠ¶æ€', 'All Status'],
          all_types: ['å…¨éƒ¨ç±»å‹', 'All Types'],
          all_filter: ['å…¨éƒ¨', 'All'],
          priced: ['å·²å®šä»·', 'Priced'],
          show_sold: ['æ˜¾ç¤ºå·²å”®', 'Show Sold'],
          dual_price: ['åŒä»·å¯¹æ¯”', 'Dual Price'],
          cost_sort: ['æˆæœ¬æ’åº', 'Cost Sort'],
          // Table headers
          th_item: ['é¥°å“', 'Item'],
          th_status: ['çŠ¶æ€', 'Status'],
          th_abrade: ['ç£¨æŸ', 'Wear'],
          th_cost: ['æˆæœ¬ä»·', 'Cost'],
          th_auto_price: ['è‡ªåŠ¨ä»·', 'Auto'],
          th_manual_price: ['æ‰‹åŠ¨ä»·', 'Manual'],
          th_market_price: ['å¸‚ä»·', 'Market'],
          th_pnl: ['ç›ˆäº', 'P&L'],
          th_pnl_pct: ['æ¶¨è·Œ%', 'Change%'],
          th_date: ['è´­å…¥æ—¥æœŸ', 'Buy Date'],
          th_platform: ['å¹³å°', 'Platform'],
          th_daily_rent: ['æ—¥ç§Ÿé‡‘', 'Daily Rent'],
          th_deposit: ['æŠ¼é‡‘', 'Deposit'],
          th_expire: ['åˆ°æœŸæ—¶é—´', 'Expires'],
          th_renewal: ['ç»­ç§Ÿ', 'Renewal'],
          th_operation: ['æ“ä½œ', 'Actions'],
          th_market_ref: ['å¸‚åœºå‚è€ƒä»·', 'Market Ref'],
          th_market_ref_rent: ['å¸‚åœºå‚è€ƒç§Ÿé‡‘', 'Market Ref Rent'],
          th_sell_price: ['å‡ºå”®ä»·', 'Sell Price'],
          // Pagination
          total_records: ['å…±', 'Total'],
          records_unit: ['æ¡', ''],
          page_unit: ['é¡µ', ''],
          page_prefix: ['ç¬¬', 'Page'],
          // Loading
          loading: ['åŠ è½½ä¸­â€¦', 'Loadingâ€¦'],
          no_match: ['æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é¥°å“', 'No matching items found'],
          // Side panel
          panel_status: ['çŠ¶æ€', 'Status'],
          panel_source: ['æ¥æº', 'Source'],
          panel_abrade: ['ç£¨æŸå€¼', 'Wear Value'],
          panel_buy_date: ['è´­å…¥æ—¥æœŸ', 'Buy Date'],
          panel_buy_platform: ['è´­å…¥å¹³å°', 'Platform'],
          panel_auto_price: ['è‡ªåŠ¨è¯†åˆ«ä»·', 'Auto Price'],
          panel_effective: ['ç”Ÿæ•ˆä»·æ ¼', 'Effective Price'],
          panel_first_seen: ['é¦–æ¬¡å‘ç°', 'First Seen'],
          manual_price_title: ['æ‰‹åŠ¨è´­å…¥ä»·', 'Manual Buy Price'],
          manual_price_set: ['å·²æ‰‹åŠ¨è®¾ç½®', 'Manually Set'],
          manual_price_desc: ['ä¼˜å…ˆäºè‡ªåŠ¨è¯†åˆ«ä»·ï¼Œä¸è¢«è‡ªåŠ¨å¯¼å…¥è¦†ç›–ã€‚', 'Overrides auto price, not overwritten by import.'],
          btn_save: ['ä¿å­˜', 'Save'],
          btn_clear_manual: ['æ¸…é™¤æ‰‹åŠ¨ä»·æ ¼', 'Clear Manual Price'],
          // Listing tab
          shelf_sell: ['å‡ºå”®è´§æ¶', 'Sell Shelf'],
          shelf_lease: ['å‡ºç§Ÿè´§æ¶', 'Lease Shelf'],
          shelf_rented: ['å·²ç§Ÿå‡º', 'Rented Out'],
          shelf_sublet: ['è½¬ç§Ÿä¸­/0CD', 'Sublet/0CD'],
          shelf_unlisted: ['å¾…ä¸Šæ¶', 'Unlisted'],
          btn_refresh: ['åˆ·æ–°', 'Refresh'],
          btn_batch_delist: ['æ‰¹é‡ä¸‹æ¶', 'Batch Delist'],
          btn_batch_reprice: ['æ‰¹é‡æ™ºèƒ½æ”¹ä»·', 'Smart Reprice'],
          btn_repricing: ['æ”¹ä»·ä¸­â€¦', 'Repricingâ€¦'],
          btn_reprice: ['æ”¹ä»·', 'Reprice'],
          btn_delist: ['ä¸‹æ¶', 'Delist'],
          btn_cancel_sublet: ['å–æ¶ˆè½¬ç§Ÿ', 'Cancel Sublet'],
          selected_count: ['å·²é€‰', 'Selected'],
          clear_selection: ['æ¸…é™¤é€‰æ‹©', 'Clear'],
          shelf_empty: ['è´§æ¶ä¸ºç©º', 'Shelf is empty'],
          loading_shelf: ['åŠ è½½è´§æ¶â€¦', 'Loading shelfâ€¦'],
          loading_data: ['åŠ è½½ä¸­â€¦', 'Loadingâ€¦'],
          no_data: ['æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»ã€Œåˆ·æ–°ã€', 'No data, click refresh'],
          smart_listing_note: ['æ™ºèƒ½ä¸Šæ¶åŠŸèƒ½éœ€å…ˆå®Œæˆã€ŒåŒæ­¥æ•°æ®ã€â†’ã€ŒåŒæ­¥æ¨¡æ¿IDã€ä»¥è·å–å¸‚åœºå®šä»·å‚è€ƒ', 'Smart listing requires sync data + sync template IDs first'],
          need_list_note: ['éœ€è¦ä¸Šæ¶æ–°é¥°å“ï¼Ÿè¯·åˆ‡æ¢åˆ°ã€Œå¾…ä¸Šæ¶ã€æ ‡ç­¾é¡µï¼Œä»åº“å­˜ä¸­é€‰æ‹©é¥°å“å¿«é€Ÿä¸Šæ¶', 'To list new items, switch to the "Unlisted" tab'],
          shelf_empty_sync: ['è´§æ¶ä¸ºç©ºï¼Œæˆ–å°šæœªåŒæ­¥æ¨¡æ¿IDï¼ˆç”¨äºå¸‚åœºå®šä»·ï¼‰', 'Shelf empty, or template IDs not synced yet'],
          btn_sync_template: ['åŒæ­¥æ¨¡æ¿IDï¼ˆç”¨äºå¸‚åœºå®šä»·ï¼‰', 'Sync Template IDs'],
          syncing_text: ['åŒæ­¥ä¸­â€¦', 'Syncingâ€¦'],
          on_sale: ['åœ¨å”®', 'Listed'],
          subletting: ['è½¬ç§Ÿä¸­', 'Subletting'],
          // Reprice modal
          reprice_title: ['æ”¹ä»·', 'Reprice'],
          sell_price_label: ['å‡ºå”®ä»·ï¼ˆå…ƒï¼‰', 'Sell Price (Â¥)'],
          short_rent_label: ['çŸ­ç§Ÿæ—¥ç§Ÿé‡‘ï¼ˆå…ƒ/å¤©ï¼‰', 'Daily Rent (Â¥/day)'],
          long_rent_label: ['é•¿ç§Ÿæ—¥ç§Ÿé‡‘ï¼ˆå…ƒ/å¤©ï¼Œå¯é€‰ï¼‰', 'Long-term Rent (Â¥/day, optional)'],
          deposit_label: ['æŠ¼é‡‘ï¼ˆå…ƒï¼‰', 'Deposit (Â¥)'],
          long_rent_hint: ['ç•™ç©ºåˆ™æŒ‰çŸ­ç§Ÿä»·Ã—0.95', 'Leave empty for short rent Ã— 0.95'],
          btn_cancel: ['å–æ¶ˆ', 'Cancel'],
          btn_confirm_reprice: ['ç¡®è®¤æ”¹ä»·', 'Confirm'],
          saving_text: ['ä¿å­˜ä¸­â€¦', 'Savingâ€¦'],
          // Login modal
          login_title: ['æ‚ æ‚ æœ‰å“ æ‰‹æœºå·ç™»å½•', 'YouPin SMS Login'],
          login_desc: ['é€šè¿‡æ‰‹æœºå·+éªŒè¯ç è·å– App ç«¯ Tokenï¼ˆæ”¯æŒä¸Šæ¶/ä¸‹æ¶/æ”¹ä»·ç­‰æ“ä½œï¼‰', 'Get App token via phone + SMS code'],
          phone_label: ['æ‰‹æœºå·', 'Phone'],
          code_label: ['éªŒè¯ç ', 'Code'],
          btn_send_code: ['å‘é€éªŒè¯ç ', 'Send Code'],
          sending_code: ['å‘é€ä¸­â€¦', 'Sendingâ€¦'],
          btn_login: ['ç™»å½•', 'Login'],
          logging_in: ['ç™»å½•ä¸­â€¦', 'Logging inâ€¦'],
          manual_token_desc: ['æˆ–ç›´æ¥ç²˜è´´ Tokenï¼ˆä»æ‚ æ‚  App æˆ–æµè§ˆå™¨ DevTools è·å–ï¼‰', 'Or paste token directly (from YouPin App or DevTools)'],
          btn_apply: ['åº”ç”¨', 'Apply'],
          // Token banner
          token_expired_msg: ['æ‚ æ‚ æœ‰å“ Token å·²è¿‡æœŸï¼Œæ‰€æœ‰åŒæ­¥/ä¸Šæ¶åŠŸèƒ½ä¸å¯ç”¨', 'YouPin token expired, sync/listing functions unavailable'],
          token_expired_hint: ['â†’ ç™»å½• www.youpin898.com â†’ DevTools â†’ Network â†’ å¤åˆ¶ Authorization header ä¸­çš„ Bearer Token â†’ æ›´æ–° .env é‡å¯æœåŠ¡', 'â†’ Login youpin898.com â†’ DevTools â†’ Copy Bearer Token â†’ Update .env'],
          // Import result
          import_done: ['å¯¼å…¥å®Œæˆ', 'Import Complete'],
          btn_refresh_data: ['åˆ·æ–°æ•°æ®', 'Refresh Data'],
          // Analysis
          analysis_overview: ['å¸‚åœºæ€»è§ˆ', 'Overview'],
          analysis_detail: ['é¥°å“åˆ†æ', 'Item Analysis'],
          analysis_alerts: ['é¢„è­¦ä¸­å¿ƒ', 'Alerts'],
          analysis_spreads: ['å¥—åˆ©é›·è¾¾', 'Arbitrage'],
          unread_alerts: ['æœªè¯»é¢„è­¦', 'Unread Alerts'],
          avg_sell_score: ['å¹³å‡å–å‡ºè¯„åˆ†', 'Avg Sell Score'],
          avg_momentum_30: ['30D å¹³å‡åŠ¨é‡', '30D Avg Momentum'],
          data_status: ['æ•°æ®çŠ¶æ€', 'Data Status'],
          collecting: ['é‡‡é›†ä¸­â€¦', 'Collectingâ€¦'],
          last_run: ['ä¸Šæ¬¡', 'Last'],
          not_started: ['æœªå¯åŠ¨', 'Not started'],
          signal_date: ['ä¿¡å·æ—¥æœŸ', 'Signal date'],
          no_signal: ['æ— ä¿¡å·æ•°æ®', 'No signal data'],
          score_dist_title: ['å–å‡ºè¯„åˆ†åˆ†å¸ƒï¼ˆæŒä»“é¥°å“ï¼‰', 'Sell Score Distribution (Holdings)'],
          score_dist_hint: ['ç‚¹å‡»æŸ±çŠ¶æŸ¥çœ‹è¯¦æƒ…', 'Click bar for details'],
          score_hold: ['æŒæœ‰', 'Hold'],
          score_neutral: ['ä¸­æ€§', 'Neutral'],
          score_consider: ['è€ƒè™‘å–', 'Consider'],
          score_strong: ['å¼ºå–', 'Strong Sell'],
          score_urgent: ['æ€¥å–', 'Urgent'],
          top10_sell: ['Top 10 å–å‡ºä¿¡å·', 'Top 10 Sell Signals'],
          category_trends: ['åˆ†ç±»è¶‹åŠ¿', 'Category Trends'],
          btn_backfill: ['å›å¡«å†å²æ•°æ®', 'Backfill History'],
          backfilling: ['å›å¡«ä¸­â€¦', 'Backfillingâ€¦'],
          btn_compute: ['ç«‹å³è®¡ç®—ä¿¡å·', 'Compute Signals'],
          computing: ['è®¡ç®—ä¸­â€¦', 'Computingâ€¦'],
          btn_collect: ['ç«‹å³é‡‡é›†ä»·æ ¼', 'Collect Prices'],
          search_item_hint: ['æœç´¢é¥°å“åç§°â€¦', 'Search item nameâ€¦'],
          no_signal_hint: ['æš‚æ— ä¿¡å·æ•°æ®ï¼Œè¯·å…ˆè§¦å‘ä¿¡å·è®¡ç®—', 'No signal data, trigger computation first'],
          no_recommend: ['æš‚æ— æ¨èæ•°æ®ï¼Œè¯·å…ˆè§¦å‘ä¿¡å·è®¡ç®—', 'No recommendations, compute signals first'],
          recommend_hint: ['åœ¨ä¸Šæ–¹æœç´¢æ¡†è¾“å…¥é¥°å“åç§°æŸ¥çœ‹åˆ†æï¼Œæˆ–ç‚¹å‡»ä»¥ä¸‹æ¨èé¥°å“ï¼š', 'Search an item above, or click a recommendation:'],
          // Alerts sub-tab
          all_levels: ['å…¨éƒ¨çº§åˆ«', 'All Levels'],
          level_critical: ['ä¸¥é‡', 'Critical'],
          level_warning: ['è­¦å‘Š', 'Warning'],
          level_info: ['ä¿¡æ¯', 'Info'],
          all_types_alert: ['å…¨éƒ¨ç±»å‹', 'All Types'],
          unread_only: ['ä»…æœªè¯»', 'Unread Only'],
          btn_mark_all_read: ['å…¨éƒ¨å·²è¯»', 'Mark All Read'],
          btn_read: ['å·²è¯»', 'Read'],
          btn_view: ['æŸ¥çœ‹', 'View'],
          no_alerts: ['æš‚æ— é¢„è­¦è®°å½•', 'No alerts'],
          // Spreads
          min_spread: ['æœ€å°ä»·å·® %', 'Min Spread %'],
          no_arb_data: ['æš‚æ— å¥—åˆ©æ•°æ®', 'No arbitrage data'],
          // Analysis detail
          sell_score_title: ['ç»¼åˆå–å‡ºè¯„åˆ†', 'Sell Score'],
          buy_opp_title: ['ä¹°å…¥æœºä¼šè¯„åˆ†', 'Buy Opportunity'],
          buy_opp_beta: ['Î²æµ‹è¯•', 'Î² Test'],
          buy_opp_note: ['ä»…åŸºäºæŒä»“æ•°æ®ï¼Œå…¨å¸‚åœºåˆ†æå¾…å®Œå–„', 'Based on holdings only, full market analysis TBD'],
          ownership_title: ['æŒä»“ä¿¡æ¯', 'Ownership'],
          ownership_buy: ['è´­å…¥ä»·', 'Buy Price'],
          ownership_current: ['å½“å‰ä»·', 'Current'],
          ownership_pnl: ['ç›ˆäº', 'P&L'],
          cross_platform: ['è·¨å¹³å°ä»·æ ¼å¯¹æ¯”', 'Cross-Platform Prices'],
          sell_score_desc: ['ç»¼åˆ RSI(25%)ã€å¸ƒæ—å¸¦(20%)ã€åŠ¨é‡(15%)ã€ATHè·ç¦»(20%)ã€ç›ˆäº(20%) åŠ æƒè®¡ç®—ã€‚æ³¨æ„ï¼šæš‚æœªçº³å…¥ç§Ÿé‡‘å¹´åŒ–æ”¶ç›Šç‡ï¼Œé«˜ç§Ÿé‡‘æ”¶ç›Šé¥°å“å³ä½¿è¯„åˆ†é«˜ä¹Ÿå¯è€ƒè™‘ç»§ç»­æŒæœ‰å‡ºç§Ÿã€‚', 'Weighted: RSI(25%), BB(20%), Momentum(15%), ATH(20%), P&L(20%). Note: rental yield not included.'],
          label_hold: ['ç»§ç»­æŒæœ‰', 'Hold'],
          label_neutral: ['ä¸­æ€§æŒæœ‰', 'Neutral'],
          label_consider: ['è€ƒè™‘å‡ºå”®', 'Consider Sell'],
          label_strong: ['å¼ºçƒˆå‡ºå”®', 'Strong Sell'],
          label_urgent: ['ç«‹å³å‡ºå”®', 'Sell Now'],
          // Rental yield
          rental_yield: ['ç§Ÿé‡‘å¹´åŒ–ç‡', 'Rental Yield'],
          rental_yield_desc: ['åŸºäºçŸ­ç§Ÿæ—¥ç§Ÿé‡‘ä¼°ç®—ã€‚æœ‰æ•ˆå‡ºç§Ÿå¤©æ•°ï¼šæ™®é€š188å¤©/å¹´ï¼Œ0CD 310å¤©/å¹´ã€‚å¹´åŒ–ç‡ = æœ‰æ•ˆå¤©æ•° Ã— æ—¥ç§Ÿé‡‘ / é¥°å“ä»·å€¼ Ã— 100%', 'Annualized rental yield. Effective days: normal 188/yr, 0CD 310/yr.'],
          // Mini strip (inventory)
          mini_cost: ['æ€»æˆæœ¬', 'Total Cost'],
          mini_active: ['æ´»è·ƒæŒä»“', 'Active'],
          mini_coverage: ['å®šä»·è¦†ç›–', 'Coverage'],
          mini_manual: ['æ‰‹åŠ¨å®šä»·', 'Manual'],
          // Category labels
          cat_knife: ['åˆ€å…·', 'Knife'],
          cat_glove: ['æ‰‹å¥—', 'Glove'],
          cat_pistol: ['æ‰‹æª', 'Pistol'],
          cat_rifle: ['æ­¥æª', 'Rifle'],
          cat_sniper: ['ç‹™å‡»', 'Sniper'],
          cat_smg: ['å†²é”‹æª', 'SMG'],
          cat_shotgun: ['éœ°å¼¹æª', 'Shotgun'],
          cat_mg: ['æœºæª', 'MG'],
          cat_sticker: ['å°èŠ±', 'Sticker'],
          cat_case: ['ç®±å­', 'Case'],
          cat_other: ['å…¶ä»–', 'Other'],
          // Unknown
          unknown: ['æœªçŸ¥', 'Unknown'],
          // Score labels
          overbought: ['è¶…ä¹°', 'Overbought'],
          oversold: ['è¶…å–', 'Oversold'],
          neutral_rsi: ['ä¸­æ€§', 'Neutral'],
          above_upper: ['çªç ´ä¸Šè½¨', 'Above Upper'],
          below_lower: ['ä½äºä¸‹è½¨', 'Below Lower'],
          in_band: ['å¸¦å†…', 'In Band'],
          // Inventory mini-strip
          page_of: ['/', '/'],
        },

        // i18n helper: t('key') returns CN or EN string
        t(key) {
          const arr = this._i18n[key];
          if (!arr) return key;
          return this.nameLang === 'cn' ? arr[0] : arr[1];
        },

        toast: { msg: '', type: 'success' },

        // â”€â”€ Computed page numbers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        get pageNums() {
          const total = Math.max(1, Math.ceil(this.total / this.pageSize));
          const cur = this.page;
          if (total <= 7) return Array.from({ length: total }, (_, i) => i + 1);
          if (cur <= 4) return [1, 2, 3, 4, 5, '...', total];
          if (cur >= total - 3) return [1, '...', total-4, total-3, total-2, total-1, total];
          return [1, '...', cur-1, cur, cur+1, '...', total];
        },

        // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async init() {
          await this.loadAll();
          // åŠ è½½ç™»å½•çŠ¶æ€
          this._loadAuthState();
          // æ£€æŸ¥ token çŠ¶æ€
          this._checkToken();
          // å¦‚æœæœåŠ¡å™¨ä¸Šå·²æœ‰åˆ·æ–°ä»»åŠ¡åœ¨è·‘ï¼Œæ¥ç»­è½®è¯¢
          const r = await fetch('/api/youpin/market/status');
          if (r.ok) {
            const s = await r.json();
            if (s.status === 'running') {
              this.refreshing = true;
              this.refreshProgress = s.progress;
              this._startRefreshPoll();
            }
          }
          // æŒä¹…åŒ–ç”¨æˆ·åå¥½åˆ° localStorage
          this.$watch('nameLang', v => localStorage.setItem('nameLang', v));
          this.$watch('memberLevel', v => localStorage.setItem('memberLevel', v));
          // Apply saved theme
          if (this.theme === 'light') document.documentElement.classList.add('light');
          // åˆå§‹è·å–æœªè¯»é¢„è­¦æ•°ï¼ˆç”¨äº tab badgeï¼‰
          try {
            const ar = await fetch('/api/analysis/alerts?page_size=1&unread_only=true');
            if (ar.ok) { const ad = await ar.json(); this.unreadAlertCount = ad.total || 0; }
          } catch {}
        },

        async _checkToken() {
          try {
            const r = await fetch('/api/youpin/token/status');
            if (r.ok) {
              const s = await r.json();
              this.tokenExpired = !s.valid;
              if (s.valid && s.nickname) this.authState.nickname = s.nickname;
            }
          } catch {}
        },

        async _loadAuthState() {
          try {
            const r = await fetch('/api/youpin/auth/state');
            if (r.ok) this.authState = await r.json();
          } catch {}
        },

        async sendSmsCode() {
          if (!this.loginModal.phone) return this.showToast('è¯·è¾“å…¥æ‰‹æœºå·', 'error');
          this.loginModal.smsSending = true;
          try {
            const r = await fetch('/api/youpin/auth/send-sms', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ phone: this.loginModal.phone }),
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'å‘é€å¤±è´¥');
            this.loginModal.sessionId = d.session_id;
            this.showToast('éªŒè¯ç å·²å‘é€');
            // 60ç§’å€’è®¡æ—¶
            this.loginModal.cooldown = 60;
            const timer = setInterval(() => {
              this.loginModal.cooldown--;
              if (this.loginModal.cooldown <= 0) clearInterval(timer);
            }, 1000);
          } catch (e) {
            const msg = e.message || '';
            if (msg.includes('5050') || msg.includes('æ›´æ–°') || msg.includes('ç‰ˆæœ¬')) {
              this.showToast('æ‚ æ‚ æœ‰å“ API é™åˆ¶äº†ç¬¬ä¸‰æ–¹ SMS ç™»å½•ã€‚è¯·åœ¨æ‚ æ‚  App ä¸­ç™»å½•åï¼Œå°† Token å¡«å…¥ .env æ–‡ä»¶çš„ YOUPIN_TOKEN å­—æ®µï¼Œæˆ–ä½¿ç”¨ä¸‹æ–¹æ‰‹åŠ¨è¾“å…¥ Token åŠŸèƒ½ã€‚', 'error');
            } else {
              this.showToast('å‘é€å¤±è´¥ï¼š' + msg, 'error');
            }
          }
          finally { this.loginModal.smsSending = false; }
        },

        async applyManualToken() {
          const token = (this.loginModal.manualToken || '').trim();
          if (!token) return;
          try {
            const r = await fetch('/api/youpin/auth/apply-token', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ token }),
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'Token æ— æ•ˆ');
            this.showToast('Token åº”ç”¨æˆåŠŸ' + (d.nickname ? 'ï¼š' + d.nickname : ''));
            this.loginModal.show = false;
            this.tokenExpired = false;
            await this._loadAuthState();
          } catch (e) {
            this.showToast('Token æ— æ•ˆï¼š' + e.message, 'error');
          }
        },

        async doSmsLogin() {
          if (!this.loginModal.code || !this.loginModal.sessionId) return;
          this.loginModal.logging = true;
          try {
            const r = await fetch('/api/youpin/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                phone: this.loginModal.phone,
                code: this.loginModal.code,
                session_id: this.loginModal.sessionId,
              }),
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'ç™»å½•å¤±è´¥');
            this.showToast('ç™»å½•æˆåŠŸï¼š' + (d.nickname || ''));
            this.loginModal.show = false;
            this.tokenExpired = false;
            await this._loadAuthState();
          } catch (e) {
            this.showToast('ç™»å½•å¤±è´¥ï¼š' + e.message, 'error');
          }
          finally { this.loginModal.logging = false; }
        },

        // â”€â”€ æ‰¹é‡æ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        toggleSelectItem(id) {
          const idx = this.selectedItems.indexOf(id);
          if (idx >= 0) this.selectedItems.splice(idx, 1);
          else this.selectedItems.push(id);
        },

        toggleSelectAll(items, key = 'commodityId') {
          const ids = items.map(i => i[key]).filter(Boolean);
          if (ids.every(id => this.selectedItems.includes(id))) {
            this.selectedItems = this.selectedItems.filter(id => !ids.includes(id));
          } else {
            const set = new Set(this.selectedItems);
            ids.forEach(id => set.add(id));
            this.selectedItems = [...set];
          }
        },

        async batchDelist() {
          if (!this.selectedItems.length || !confirm(`ç¡®è®¤ä¸‹æ¶ ${this.selectedItems.length} ä»¶ç‰©å“ï¼Ÿ`)) return;
          try {
            const r = await fetch('/api/listing/batch-delist', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ commodity_ids: this.selectedItems }),
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'ä¸‹æ¶å¤±è´¥');
            this.showToast(`æˆåŠŸä¸‹æ¶ ${this.selectedItems.length} ä»¶ï¼ˆYouPin API çº¦éœ€ 30 ç§’æ›´æ–°åº“å­˜ï¼Œå†åˆ·æ–°å¾…ä¸Šæ¶ï¼‰`);
            this.selectedItems = [];
            await this.loadShelf();
            // 3ç§’åè‡ªåŠ¨åˆ·æ–°å¾…ä¸Šæ¶åˆ—è¡¨ï¼ˆç­‰å¾…YouPin APIåŒæ­¥å»¶è¿Ÿï¼‰
            setTimeout(() => { if (this.shelfTab === 'unlisted') this.loadUnlistedItems(1); }, 30000);
          } catch (e) { this.showToast('æ‰¹é‡ä¸‹æ¶å¤±è´¥ï¼š' + e.message, 'error'); }
        },

        async batchDisableZeroCd() {
          if (!this.selectedItems.length || !confirm(`ç¡®è®¤å–æ¶ˆ ${this.selectedItems.length} ä»¶è½¬ç§Ÿï¼Ÿ`)) return;
          try {
            const r = await fetch('/api/youpin/lease/disable-zero-cd', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ order_ids: this.selectedItems }),
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'å–æ¶ˆå¤±è´¥');
            this.showToast('å·²å–æ¶ˆ 0CD è½¬ç§Ÿ');
            this.selectedItems = [];
            await this.loadSubletList(this.subletPage);
          } catch (e) { this.showToast('æ‰¹é‡å–æ¶ˆå¤±è´¥ï¼š' + e.message, 'error'); }
        },

        get currentShelf() {
          return this.shelfTab === 'sell' ? (this.sellShelf.items || []) : (this.leaseShelf.items || []);
        },

        async loadAll() {
          await Promise.all([this.loadOverview(), this.loadItems(), this.loadPortfolioHistory(), this.loadMonitorStatus()]);
        },

        async loadOverview() {
          try {
            const r = await fetch('/api/dashboard/overview');
            if (r.ok) this.overview = await r.json();
          } catch {}
        },

        // â”€â”€ Portfolio Trend Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async loadPortfolioHistory() {
          try {
            const r = await fetch(`/api/monitoring/portfolio-history?range=${this.portfolioRange}`);
            if (!r.ok) return;
            const d = await r.json();
            this.portfolioData = d.data || [];
            this.$nextTick(() => this.renderPortfolioChart());
          } catch {}
        },

        renderPortfolioChart() {
          const el = document.getElementById('portfolioChart');
          if (!el || !this.portfolioData.length) return;

          if (this._portfolioChart) {
            this._portfolioChart.destroy();
            this._portfolioChart = null;
          }

          const data = this.portfolioData;
          const labels = data.map(d => d.timestamp);
          const isDark = !document.documentElement.classList.contains('light');
          const gridColor = isDark ? 'rgba(51,65,85,0.3)' : 'rgba(186,214,235,0.4)';
          const textColor = isDark ? '#64748b' : '#475569';

          this._portfolioChart = new Chart(el, {
            type: 'line',
            data: {
              labels,
              datasets: [
                {
                  label: this.t('market_value'),
                  data: data.map(d => d.market_value),
                  borderColor: '#10b981',
                  backgroundColor: 'rgba(16,185,129,0.08)',
                  fill: true,
                  tension: 0.3,
                  pointRadius: data.length > 50 ? 0 : 2,
                  pointHoverRadius: 4,
                  borderWidth: 2,
                },
                {
                  label: this.t('total_cost'),
                  data: data.map(d => d.total_cost),
                  borderColor: '#3b82f6',
                  backgroundColor: 'rgba(59,130,246,0.05)',
                  fill: true,
                  tension: 0.3,
                  pointRadius: data.length > 50 ? 0 : 2,
                  pointHoverRadius: 4,
                  borderWidth: 2,
                },
                {
                  label: this.t('pnl_amount'),
                  data: data.map(d => d.pnl),
                  borderColor: '#f59e0b',
                  backgroundColor: 'transparent',
                  tension: 0.3,
                  pointRadius: 0,
                  pointHoverRadius: 4,
                  borderWidth: 1.5,
                  borderDash: [4, 2],
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: 'index', intersect: false },
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: isDark ? 'rgba(15,23,42,0.95)' : 'rgba(255,255,255,0.95)',
                  titleColor: isDark ? '#e2e8f0' : '#1e293b',
                  bodyColor: isDark ? '#94a3b8' : '#475569',
                  borderColor: isDark ? 'rgba(51,65,85,0.5)' : 'rgba(186,214,235,0.5)',
                  borderWidth: 1,
                  padding: 10,
                  callbacks: {
                    title: (ctx) => {
                      const d = new Date(ctx[0].label);
                      return d.toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    },
                    label: (ctx) => `${ctx.dataset.label}: Â¥${ctx.parsed.y?.toLocaleString() ?? 'â€”'}`,
                  },
                },
              },
              scales: {
                x: {
                  type: 'time',
                  time: {
                    tooltipFormat: 'yyyy-MM-dd HH:mm',
                    displayFormats: {
                      hour: 'HH:mm',
                      day: 'MM/dd',
                      week: 'MM/dd',
                    },
                  },
                  grid: { color: gridColor },
                  ticks: { color: textColor, maxTicksLimit: 8, font: { size: 10 } },
                },
                y: {
                  grid: { color: gridColor },
                  ticks: {
                    color: textColor,
                    font: { size: 10 },
                    callback: (v) => 'Â¥' + (v >= 10000 ? (v / 10000).toFixed(1) + 'w' : v.toLocaleString()),
                  },
                },
              },
            },
          });
        },

        // â”€â”€ System Monitor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async loadMonitorStatus() {
          try {
            const r = await fetch('/api/monitoring/status');
            if (r.ok) this.monitorStatus = await r.json();
          } catch {}
        },

        async loadItems() {
          this.loading = true;
          try {
            const p = new URLSearchParams({
              page: this.page,
              page_size: this.pageSize,
              sort_by: this.sortBy,
              sort_order: this.sortOrder,
            });
            if (this.filters.search)        p.set('search', this.filters.search);
            if (this.filters.status)        p.set('status', this.filters.status);
            if (this.filters.pricedFilter)  p.set('priced_filter', this.filters.pricedFilter);
            if (this.filters.category)      p.set('category', this.filters.category);
            if (!this.showSold)             p.set('exclude_sold', '1');
            const r = await fetch('/api/dashboard/items?' + p);
            if (r.ok) { const d = await r.json(); this.items = d.items; this.total = d.total; }
          } catch {}
          finally { this.loading = false; }
        },

        // â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        gotoPage(p) {
          const max = Math.ceil(this.total / this.pageSize);
          if (p < 1 || p > max) return;
          this.page = p;
          this.loadItems();
          document.querySelector('.tbl-wrap')?.scrollTo({ top: 0, behavior: 'smooth' });
        },

        // â”€â”€ Sort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        setSort(col) {
          if (this.sortBy === col) this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
          else { this.sortBy = col; this.sortOrder = 'desc'; }
          this.page = 1;
          this.loadItems();
        },
        sortIcon(col) {
          if (this.sortBy !== col) return 'â†•';
          return this.sortOrder === 'asc' ? 'â†‘' : 'â†“';
        },

        // â”€â”€ Detail panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        openPanel(item) {
          this.panel = { ...item };
          this.manualInput = item.purchase_price_manual != null ? item.purchase_price_manual : '';
        },

        panelFields() {
          if (!this.panel) return [];
          const p = this.panel;
          const eff = p.effective_price != null ? 'Â¥' + this.fmt(p.effective_price) : null;
          const auto = p.purchase_price != null ? 'Â¥' + this.fmt(p.purchase_price) : null;
          const date = p.first_seen_at ? new Date(p.first_seen_at).toLocaleString('zh-CN') : null;
          return [
            [this.t('panel_status'),     this.statusLbl(p.status),  false, false],
            [this.t('panel_source'),     p.class_id,                 false, false],
            [this.t('panel_abrade'),     p.abrade?.toFixed(10),      true,  false],
            [this.t('panel_buy_date'),   p.purchase_date,            false, false],
            [this.t('panel_buy_platform'), p.purchase_platform,      false, false],
            [this.t('panel_auto_price'), auto,                        false, false],
            [this.t('panel_effective'),  eff, false, p.purchase_price_manual != null],
            [this.t('panel_first_seen'), date,                        true,  false],
          ];
        },

        async saveManual() {
          if (!this.panel) return;
          this.saving = true;
          try {
            const price = this.manualInput !== '' && this.manualInput !== null
              ? parseFloat(this.manualInput) : null;
            const r = await fetch(`/api/dashboard/items/${this.panel.id}/manual-price`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ price }),
            });
            if (!r.ok) throw new Error();
            const upd = await r.json();
            this.panel.purchase_price_manual = upd.purchase_price_manual;
            this.panel.effective_price = upd.effective_price;
            const row = this.items.find(i => i.id === this.panel.id);
            if (row) { row.purchase_price_manual = upd.purchase_price_manual; row.effective_price = upd.effective_price; }
            this.showToast('ä¿å­˜æˆåŠŸ âœ“');
            await this.loadOverview();
          } catch { this.showToast('ä¿å­˜å¤±è´¥', 'error'); }
          finally { this.saving = false; }
        },

        async clearManual() {
          this.manualInput = '';
          await this.saveManual();
        },

        // â”€â”€ Price Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async triggerRefreshPrices() {
          if (this.refreshing) return;
          this.refreshing = true;
          this.refreshProgress = 0;
          try {
            const r = await fetch('/api/dashboard/refresh-prices', { method: 'POST' });
            if (!r.ok) throw new Error(await r.text());
            const d = await r.json();
            if (!d.started && d.state?.status !== 'running') {
              this.showToast('å¯åŠ¨å¤±è´¥', 'error');
              this.refreshing = false;
              return;
            }
            this._startRefreshPoll();
          } catch (e) {
            this.refreshing = false;
            this.showToast('åˆ·æ–°å¯åŠ¨å¤±è´¥ï¼š' + e.message, 'error');
          }
        },

        _startRefreshPoll() {
          clearInterval(this._refreshPollTimer);
          this._refreshPollTimer = setInterval(async () => {
            try {
              const r = await fetch('/api/youpin/market/status');
              if (!r.ok) return;
              const s = await r.json();
              this.refreshProgress = s.progress;
              if (s.status === 'done' || s.status === 'error' || s.status === 'token_expired') {
                clearInterval(this._refreshPollTimer);
                this.refreshing = false;
                if (s.status === 'done') {
                  this.showToast('å¸‚ä»·åˆ·æ–°å®Œæˆ âœ“');
                  await this.loadAll();
                } else if (s.status === 'token_expired') {
                  this.tokenExpired = true;
                  this.showToast('Token å·²è¿‡æœŸï¼Œå¸‚ä»·åˆ·æ–°ä¸­æ–­', 'error');
                } else {
                  this.showToast('å¸‚ä»·åˆ·æ–°å¤±è´¥ï¼š' + (s.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
              }
            } catch {}
          }, 2500);
        },

        // â”€â”€ Listing tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async loadShelf() {
          this.shelfLoading = true;
          try {
            const [sr, lr] = await Promise.all([
              fetch('/api/listing/shelf/sell?page_size=100'),
              fetch('/api/listing/shelf/lease?page_size=100'),
            ]);
            if (sr.ok) this.sellShelf = await sr.json();
            if (lr.ok) this.leaseShelf = await lr.json();
          } catch {}
          finally { this.shelfLoading = false; }
        },

        async loadRentedList(page = 1) {
          this.rentedLoading = true;
          this.rentedPage = page;
          try {
            const p = new URLSearchParams({ page, page_size: 50 });
            const r = await fetch('/api/youpin/lease/live-list?' + p);
            if (r.ok) this.rentedList = await r.json();
          } catch {}
          finally { this.rentedLoading = false; }
        },

        async loadSubletList(page = 1) {
          this.subletLoading = true;
          this.subletPage = page;
          try {
            const p = new URLSearchParams({ page, page_size: 50 });
            const r = await fetch('/api/youpin/lease/sublet-list?' + p);
            if (r.ok) this.subletList = await r.json();
          } catch {}
          finally { this.subletLoading = false; }
        },

        async loadUnlistedItems(page = 1) {
          this.unlistedLoading = true;
          this.unlistedPage = page;
          try {
            const p = new URLSearchParams({ page, page_size: 50 });
            const r = await fetch('/api/listing/shelf/unlisted?' + p);
            if (r.ok) this.unlistedItems = await r.json();
          } catch {}
          finally { this.unlistedLoading = false; }
        },

        async cancelSubletOrder(orderId) {
          if (!orderId || !confirm('ç¡®è®¤å–æ¶ˆè¯¥é¥°å“çš„0CDè½¬ç§Ÿï¼Ÿ')) return;
          try {
            const r = await fetch('/api/youpin/lease/disable-zero-cd', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ order_ids: [orderId] }),
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'å–æ¶ˆå¤±è´¥');
            this.showToast('å·²å–æ¶ˆ0CDè½¬ç§Ÿ');
            await this.loadSubletList(this.subletPage);
          } catch (e) {
            this.showToast('å–æ¶ˆå¤±è´¥ï¼š' + e.message, 'error');
          }
        },

        openReprice(item) {
          this.repriceModal = {
            show: true, item,
            newPrice: item.price ?? '',
            newLeaseUnit: item.leaseUnitPrice ?? '',
            newLongLeaseUnit: item.longLeasePrice ?? '',
            newDeposit: item.leaseDeposit ?? '',
            saving: false,
            isSublet: false,
          };
        },

        // è½¬ç§Ÿä¸­ç‰©å“æ”¹ä»·ï¼ˆå¼ºåˆ¶ lease æ¨¡å¼ï¼Œä¸ä¾èµ– shelfTabï¼‰
        openSubletReprice(item) {
          this.repriceModal = {
            show: true, item,
            newPrice: '',
            newLeaseUnit: item.leaseUnitPrice ?? '',
            newLongLeaseUnit: item.longLeasePrice ?? '',
            newDeposit: item.leaseDeposit ?? '',
            saving: false,
            isSublet: true,
          };
        },

        // æŸ¥è¯¢è´§æ¶ç‰©å“çš„å¸‚åœºå‚è€ƒä»·ï¼ˆæŒ‰éœ€ï¼Œç‚¹å‡»ã€ŒæŸ¥ã€æŒ‰é’®è§¦å‘ï¼‰
        async fetchShelfMktPrice(item) {
          if (!item.templateId || item._mktLoading) return;
          item._mktLoading = true;
          // å¼ºåˆ¶ Alpine é‡æ–°æ¸²æŸ“
          this.sellShelf = { ...this.sellShelf };
          this.leaseShelf = { ...this.leaseShelf };
          try {
            const p = new URLSearchParams({ template_id: item.templateId });
            if (item.abrade != null) p.set('abrade', item.abrade);
            const r = await fetch('/api/youpin/market/price-info?' + p);
            if (!r.ok) {
              const err = await r.json().catch(() => ({}));
              throw new Error(err.detail || `æŸ¥è¯¢å¤±è´¥ (${r.status})`);
            }
            const d = await r.json();
            item._mktSell = d.suggested_sell;
            item._mktLease = d.suggested_lease;
          } catch (e) {
            item._mktSell = null;
            item._mktLease = null;
            this.showToast('å¸‚ä»·æŸ¥è¯¢å¤±è´¥ï¼š' + e.message, 'error');
          } finally {
            item._mktLoading = false;
            // è§¦å‘é‡æ–°æ¸²æŸ“
            this.sellShelf = { ...this.sellShelf };
            this.leaseShelf = { ...this.leaseShelf };
          }
        },

        // æ‰¹é‡æ™ºèƒ½æ”¹ä»·ï¼šå¯¹é€‰ä¸­è´§æ¶ç‰©å“æŒ‰å¸‚åœºä»·æ”¹ä»·
        async batchSmartReprice() {
          const shelf = this.currentShelf;
          const selected = shelf.filter(i => this.selectedItems.includes(i.commodityId));
          if (!selected.length) return;
          if (selected.some(i => !i.templateId)) {
            this.showToast('éƒ¨åˆ†ç‰©å“ç¼ºå°‘æ¨¡æ¿IDï¼Œæ— æ³•æ™ºèƒ½æ”¹ä»·ï¼ˆè¯·å…ˆåŒæ­¥æ¨¡æ¿IDï¼‰', 'error');
            return;
          }
          if (!confirm(`ç¡®è®¤å¯¹ ${selected.length} ä»¶ç‰©å“æŒ‰å¸‚åœºä»·æ™ºèƒ½æ”¹ä»·ï¼Ÿ`)) return;

          this.batchRepricing = true;
          const isLease = this.shelfTab === 'lease';
          const items = selected.map(i => ({
            commodity_id: i.commodityId,
            template_id: i.templateId,
            abrade: i.abrade,
            is_can_lease: isLease,
          }));

          try {
            this.batchRepriceProgress = `0/${items.length}`;
            const r = await fetch('/api/listing/batch-smart-reprice', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ items, use_undercut: true }),
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'æ‰¹é‡æ”¹ä»·å¤±è´¥');
            this.showToast(`æ‰¹é‡æ”¹ä»·å®Œæˆï¼š${d.ok_count}/${d.total} ä»¶æˆåŠŸ`);
            this.selectedItems = [];
            await this.loadShelf();
          } catch (e) {
            this.showToast('æ‰¹é‡æ”¹ä»·å¤±è´¥ï¼š' + e.message, 'error');
          } finally {
            this.batchRepricing = false;
            this.batchRepriceProgress = '';
          }
        },

        async saveReprice() {
          const { item, newPrice, newLeaseUnit, newLongLeaseUnit, newDeposit } = this.repriceModal;
          if (!item || !item.commodityId) return;
          this.repriceModal.saving = true;
          try {
            const isLease = this.shelfTab === 'lease' || this.repriceModal.isSublet;
            const body = {
              commodity_id: item.commodityId,
              is_can_sold: !isLease,
              is_can_lease: isLease,
              ...(isLease
                ? { lease_unit: parseFloat(newLeaseUnit), long_lease_unit: parseFloat(newLongLeaseUnit) || undefined, deposit: parseFloat(newDeposit) }
                : { sell_price: parseFloat(newPrice) }),
            };
            const r = await fetch('/api/listing/reprice', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body),
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'æ”¹ä»·å¤±è´¥');
            this.showToast('æ”¹ä»·æˆåŠŸ');
            this.repriceModal.show = false;
            await this.loadShelf();
          } catch (e) {
            this.showToast('æ”¹ä»·å¤±è´¥ï¼š' + e.message, 'error');
          }
          finally { this.repriceModal.saving = false; }
        },

        // æ¶¨è·Œé¢œè‰²ï¼švalä¸ºæ­£/è´Ÿï¼Œè¿”å› Tailwind class
        pnlClass(val) {
          const up = val >= 0;
          if (this.colorMode === 'cn') return up ? 'text-red-400' : 'text-emerald-400';
          return up ? 'text-emerald-400' : 'text-red-400';
        },
        pnlClassMd(val) {
          const up = val >= 0;
          if (this.colorMode === 'cn') return up ? 'text-red-600' : 'text-emerald-600';
          return up ? 'text-emerald-600' : 'text-red-600';
        },
        pnlBg(val) {
          const up = val >= 0;
          if (this.colorMode === 'cn') return up ? 'rgba(239,68,68,0.07)' : 'rgba(16,185,129,0.07)';
          return up ? 'rgba(16,185,129,0.07)' : 'rgba(239,68,68,0.07)';
        },

        async syncTemplateIds() {
          this.syncing = true;
          try {
            const r = await fetch('/api/youpin/sync/template-ids', { method: 'POST' });
            if (!r.ok) { const d = await r.json(); throw new Error(d.detail || 'Sync failed'); }
            // Poll status until done
            await new Promise((resolve) => {
              const poll = setInterval(async () => {
                try {
                  const sr = await fetch('/api/youpin/sync/template-ids/status');
                  const st = await sr.json();
                  if (st.status === 'done') {
                    clearInterval(poll);
                    const d = st.result || {};
                    this.showToast(`æ¨¡æ¿IDåŒæ­¥å®Œæˆï¼šæ›´æ–° ${d.synced||0} ä»¶ï¼Œæ˜ å°„ ${d.unique_names_mapped||0} ä¸ªå“ç±»`);
                    resolve();
                  } else if (st.status === 'error') {
                    clearInterval(poll);
                    this.showToast((this.nameLang==='cn'?'åŒæ­¥å¤±è´¥: ':'Sync failed: ') + (st.error||''), 'error');
                    resolve();
                  }
                } catch {}
              }, 2000);
              setTimeout(() => { clearInterval(poll); resolve(); }, 5 * 60 * 1000);
            });
          } catch (e) {
            this.showToast((this.nameLang==='cn'?'åŒæ­¥å¤±è´¥: ':'Sync failed: ') + e.message, 'error');
          }
          finally { this.syncing = false; }
        },

        async delistItem(commodityId) {
          if (!commodityId || !confirm('ç¡®è®¤ä¸‹æ¶è¯¥ç‰©å“ï¼Ÿ')) return;
          try {
            const r = await fetch(`/api/listing/${commodityId}`, { method: 'DELETE' });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'ä¸‹æ¶å¤±è´¥');
            this.showToast('ä¸‹æ¶æˆåŠŸï¼ˆYouPin API çº¦éœ€ 30 ç§’æ›´æ–°åº“å­˜ï¼Œè¯·ç¨ååˆ·æ–°å¾…ä¸Šæ¶åˆ—è¡¨ï¼‰');
            await this.loadShelf();
            // 5ç§’ååˆ·æ–°å¾…ä¸Šæ¶åˆ—è¡¨
            setTimeout(() => { if (this.shelfTab === 'unlisted') this.loadUnlistedItems(1); }, 30000);
          } catch (e) {
            this.showToast('ä¸‹æ¶å¤±è´¥ï¼š' + e.message, 'error');
          }
        },

        async previewListPrice() {
          if (!this.quickList.templateId) return;
          this.quickList.previewing = true;
          try {
            const p = new URLSearchParams({
              template_id: this.quickList.templateId,
              buy_price: this.quickList.buyPrice || 0,
              take_profit_ratio: this.quickList.takeProfitRatio || 0,
            });
            if (this.quickList.abrade) p.set('abrade', this.quickList.abrade);
            const r = await fetch('/api/listing/preview?' + p);
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'é¢„è§ˆå¤±è´¥');
            this.quickList.preview = d;
          } catch (e) {
            this.showToast('é¢„è§ˆå¤±è´¥ï¼š' + e.message, 'error');
          }
          finally { this.quickList.previewing = false; }
        },

        async smartListItem() {
          if (!this.quickList.assetId || !this.quickList.templateId) return;
          this.quickList.listing = true;
          try {
            const r = await fetch('/api/listing/smart', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                asset_id: this.quickList.assetId,
                template_id: this.quickList.templateId,
                mode: this.quickList.mode,
                buy_price: this.quickList.buyPrice || 0,
                take_profit_ratio: this.quickList.takeProfitRatio || 0,
                use_undercut: this.quickList.useUndercut,
                member_level: this.memberLevel,
              }),
            });
            const d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'ä¸Šæ¶å¤±è´¥');
            if (d.ok) {
              const priceInfo = d.sell_price ? `å‡ºå”®ä»· Â¥${this.fmt(d.sell_price)}` : `ç§Ÿé‡‘ Â¥${this.fmt(d.lease_info?.lease_unit)}/å¤©`;
              this.showToast(`ä¸Šæ¶æˆåŠŸ ${priceInfo}`);
              this.quickList.assetId = '';
              await this.loadShelf();
            } else {
              this.showToast(d.error || 'ä¸Šæ¶å¤±è´¥', 'error');
            }
          } catch (e) {
            this.showToast('ä¸Šæ¶å¤±è´¥ï¼š' + e.message, 'error');
          }
          finally { this.quickList.listing = false; }
        },

        // â”€â”€ Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async triggerImport() {
          this.importing = true;
          this.importProgress = 0;
          const stepMap = { stock: 0, lease: 25, buy: 50, sell: 75 };

          try {
            // 1) Fire-and-forget: start background import
            const r = await fetch('/api/youpin/import/all', { method: 'POST' });
            if (!r.ok) throw new Error(await r.text());
            const start = await r.json();
            if (start.started === false && start.state?.status !== 'running') {
              this.showToast(start.message || 'Import busy', 'error');
              this.importing = false;
              return;
            }

            // 2) Poll /import/status every 2s until done/error
            await new Promise((resolve, reject) => {
              this._importPoll = setInterval(async () => {
                try {
                  const sr = await fetch('/api/youpin/import/status');
                  const st = await sr.json();
                  // progress bar: base from completed steps + partial for current
                  const base = (st.completed || []).length * 25;
                  this.importProgress = Math.min(base + 10, 95);

                  if (st.status === 'done') {
                    clearInterval(this._importPoll);
                    this.importProgress = 100;
                    setTimeout(() => { this.importProgress = -1; }, 700);
                    this.importResult = st.results;
                    this.lastImportAt = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    resolve();
                  } else if (st.status === 'error') {
                    clearInterval(this._importPoll);
                    this.importProgress = -1;
                    this.showToast((this.nameLang==='cn'?'å¯¼å…¥å‡ºé”™: ':'Import error: ') + (st.error || 'unknown'), 'error');
                    resolve();
                  }
                } catch (pe) {
                  // network glitch during poll â€” ignore, retry next tick
                }
              }, 2000);

              // safety timeout: 15 minutes
              setTimeout(() => {
                clearInterval(this._importPoll);
                this.importProgress = -1;
                this.showToast(this.nameLang==='cn'?'å¯¼å…¥è¶…æ—¶ï¼Œè¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹':'Import timeout, refresh page', 'error');
                resolve();
              }, 15 * 60 * 1000);
            });
          } catch (e) {
            this.importProgress = -1;
            this.showToast((this.nameLang==='cn'?'å¯¼å…¥å¤±è´¥: ':'Import failed: ') + e.message, 'error');
          } finally {
            this.importing = false;
          }
        },

        // â”€â”€ é‡åŒ–åˆ†æ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        async loadAnalysis() {
          try {
            const r = await fetch('/api/analysis/overview');
            if (r.ok) this.ao = await r.json();
            this.unreadAlertCount = this.ao.unread_alerts || 0;
          } catch {}
        },

        loadAnalysisSubTab(tab) {
          if (tab === 'overview') this.loadAnalysis();
          else if (tab === 'detail') this.loadTopItems();
          else if (tab === 'alerts') this.loadAlerts(1);
          else if (tab === 'spreads') this.loadSpreads(1);
        },

        async loadTopItems() {
          if (this.analysisTopItems.length) return;
          try {
            const r = await fetch('/api/analysis/rankings?sort_by=sell_score&sort_order=desc&page_size=6');
            if (r.ok) { const d = await r.json(); this.analysisTopItems = d.items || []; }
          } catch {}
        },

        async openScoreBucket(i) {
          const ranges = [[0,30],[30,50],[50,70],[70,85],[85,100]];
          const labels = [this.t('score_hold'),this.t('score_neutral'),this.t('score_consider'),this.t('score_strong'),this.t('score_urgent')];
          const [min, max] = ranges[i];
          this.scoreBucket = { show: true, label: labels[i], min, max, items: [] };
          try {
            const r = await fetch(`/api/analysis/rankings?sort_by=sell_score&sort_order=desc&min_score=${min}&max_score=${max}&page_size=50`);
            if (r.ok) { const d = await r.json(); this.scoreBucket.items = d.items || []; }
          } catch {}
        },

        async loadAlerts(page) {
          this.alertPage = page || 1;
          const p = new URLSearchParams({ page: this.alertPage, page_size: 20 });
          if (this.alertFilter.severity) p.set('severity', this.alertFilter.severity);
          if (this.alertFilter.type) p.set('alert_type', this.alertFilter.type);
          if (this.alertFilter.unreadOnly) p.set('unread_only', 'true');
          try {
            const r = await fetch('/api/analysis/alerts?' + p);
            if (r.ok) this.analysisAlerts = await r.json();
          } catch {}
        },

        async markAlertRead(a) {
          await fetch(`/api/analysis/alerts/${a.id}/read`, { method: 'PATCH' });
          a.is_read = true;
          this.unreadAlertCount = Math.max(0, this.unreadAlertCount - 1);
        },

        async markAllAlertsRead() {
          await fetch('/api/analysis/alerts/read-all', { method: 'POST' });
          this.analysisAlerts.items.forEach(a => a.is_read = true);
          this.unreadAlertCount = 0;
        },

        async loadSpreads(page) {
          const p = new URLSearchParams({ page, page_size: 30, min_spread: this.minSpread });
          try {
            const r = await fetch('/api/analysis/spreads?' + p);
            if (r.ok) this.analysisSpreads = await r.json();
          } catch {}
        },

        async searchAnalysisItems() {
          const q = this.analysisSearch.trim();
          try {
            const r = await fetch('/api/analysis/search-items?q=' + encodeURIComponent(q) + '&limit=15');
            if (r.ok) { const d = await r.json(); this.analysisSearchResults = d.items || []; }
          } catch {}
        },

        async loadItemSignals(name) {
          this.itemSignals = null;
          try {
            const r = await fetch(`/api/analysis/signals?market_hash_name=${encodeURIComponent(name)}&days=${this.chartDays}`);
            if (r.ok) {
              this.itemSignals = await r.json();
              this.$nextTick(() => this.renderPriceChart());
            }
          } catch {}
        },

        renderPriceChart() {
          if (this._priceChart) { this._priceChart.destroy(); this._priceChart = null; }
          const el = document.getElementById('priceChart');
          if (!el || !this.itemSignals?.chart_data?.length) return;

          const data = this.itemSignals.chart_data;
          const labels = data.map(d => {
            const s = d.date;
            return s.slice(0,4)+'-'+s.slice(4,6)+'-'+s.slice(6,8);
          });
          const closes = data.map(d => d.close);
          const ma7 = data.map(d => d.ma7);
          const ma30 = data.map(d => d.ma30);
          const bbUp = data.map(d => d.bb_upper);
          const bbLow = data.map(d => d.bb_lower);

          this._priceChart = new Chart(el.getContext('2d'), {
            type: 'line',
            data: {
              labels,
              datasets: [
                { label: this.nameLang==='cn'?'æ”¶ç›˜ä»·':'Close', data: closes, borderColor: '#3b82f6', borderWidth: 2, pointRadius: 0, fill: false, tension: 0.1 },
                { label: 'MA7', data: ma7, borderColor: '#f59e0b', borderWidth: 1, borderDash: [5,3], pointRadius: 0, fill: false },
                { label: 'MA30', data: ma30, borderColor: '#8b5cf6', borderWidth: 1, borderDash: [8,4], pointRadius: 0, fill: false },
                { label: 'BB Upper', data: bbUp, borderColor: 'rgba(100,116,139,0.4)', borderWidth: 1, pointRadius: 0, fill: false },
                { label: 'BB Lower', data: bbLow, borderColor: 'rgba(100,116,139,0.4)', borderWidth: 1, pointRadius: 0, fill: '-1',
                  backgroundColor: 'rgba(100,116,139,0.05)' },
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: 'index', intersect: false },
              plugins: {
                legend: { labels: { color: '#94a3b8', boxWidth: 12, font: { size: 10 } } },
                tooltip: { titleFont: { size: 11 }, bodyFont: { size: 11 } },
              },
              scales: {
                x: { ticks: { color: '#475569', maxTicksLimit: 10, font: { size: 9 } }, grid: { color: 'rgba(51,65,85,0.2)' } },
                y: { ticks: { color: '#475569', font: { size: 10 } }, grid: { color: 'rgba(51,65,85,0.2)' } },
              }
            }
          });
        },

        async triggerBackfill() {
          this.backfillRunning = true;
          this.backfillProgress = 'å¯åŠ¨ä¸­â€¦';
          try {
            await fetch('/api/analysis/backfill', { method: 'POST' });
            const poll = setInterval(async () => {
              try {
                const r = await fetch('/api/analysis/collector/status');
                if (r.ok) {
                  const d = await r.json();
                  const bf = d.backfill;
                  this.backfillProgress = `${bf.done}/${bf.total} ${bf.progress||''}`;
                  if (bf.status !== 'running') {
                    clearInterval(poll);
                    this.backfillRunning = false;
                    this.showToast(bf.status === 'done' ? 'å†å²æ•°æ®å›å¡«å®Œæˆ' : 'å›å¡«å¼‚å¸¸: ' + bf.progress, bf.status === 'done' ? 'success' : 'error');
                    this.loadAnalysis();
                  }
                }
              } catch {}
            }, 3000);
          } catch (e) {
            this.backfillRunning = false;
            this.showToast('å›å¡«å¯åŠ¨å¤±è´¥', 'error');
          }
        },

        async triggerComputeNow() {
          this.computingSignals = true;
          try {
            const r = await fetch('/api/analysis/compute-now', { method: 'POST' });
            if (r.ok) {
              const d = await r.json();
              this.showToast(d.message || 'ä¿¡å·è®¡ç®—å®Œæˆ', 'success');
              this.loadAnalysis();
            } else {
              this.showToast('è®¡ç®—å¤±è´¥', 'error');
            }
          } catch (e) { this.showToast('è®¡ç®—å¤±è´¥: ' + e.message, 'error'); }
          finally { this.computingSignals = false; }
        },

        async collectNow() {
          try {
            // Trigger price collection manually via a direct call
            this.showToast('ä»·æ ¼é‡‡é›†å·²è§¦å‘ï¼Œåå°è¿è¡Œä¸­ï¼ˆçº¦8åˆ†é’Ÿï¼‰', 'success');
            // The scheduler's collect_prices will handle it; alternatively we could add a manual endpoint
          } catch {}
        },

        toggleTheme() {
          this.theme = this.theme === 'dark' ? 'light' : 'dark';
          localStorage.setItem('theme', this.theme);
          document.documentElement.classList.toggle('light', this.theme === 'light');
        },

        scoreColor(s) {
          if (s == null) return 'text-slate-400';
          if (s >= 85) return 'text-red-400';
          if (s >= 70) return 'text-orange-400';
          if (s >= 50) return 'text-yellow-400';
          if (s >= 30) return 'text-slate-400';
          return 'text-emerald-400';
        },
        scoreLabel(s) {
          if (s == null) return '';
          if (s >= 85) return this.t('label_urgent');
          if (s >= 70) return this.t('label_strong');
          if (s >= 50) return this.t('label_consider');
          if (s >= 30) return this.t('label_neutral');
          return this.t('label_hold');
        },
        catLabel(c) {
          const key = 'cat_' + c;
          return this.t(key) !== key ? this.t(key) : c;
        },

        // â”€â”€ Rental yield calculation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // çŸ­ç§Ÿå¹´åŒ–ç‡ = æœ‰æ•ˆå‡ºç§Ÿå¤©æ•°(188å¤©/å¹´, 0CD 310å¤©) Ã— æ—¥ç§Ÿé‡‘ / é¥°å“ä»·å€¼ Ã— 100%
        // è¿™é‡Œç”¨ ownership.current_price ä½œä¸ºé¥°å“ä»·å€¼å‚è€ƒï¼Œæ—¥ç§Ÿé‡‘éœ€ä»è´§æ¶æ•°æ®è·å–
        // ç”±äºå‰ç«¯æ— æ³•ç›´æ¥è·å–æ—¥ç§Ÿé‡‘ï¼Œæš‚ç”¨ä¼°ç®—ï¼šrented_out çš„ç‰©å“æŒ‰å¸‚ä»·Ã—0.01%/å¤©ä¼°ç®—
        // TODO: åç«¯è¡¥å…… daily_rent å­—æ®µåå¯ç²¾ç¡®è®¡ç®—
        rentalYield(signals) {
          if (!signals?.ownership) return 0;
          const price = signals.ownership.current_price;
          if (!price || price <= 0) return 0;
          // å°è¯•ä» leaseShelf æŸ¥æ‰¾æ—¥ç§Ÿé‡‘
          const allShelf = [...(this.leaseShelf.items||[]), ...(this.subletList.items||[])];
          const match = allShelf.find(i => (i.commodityHashName||i.marketHashName||'') === signals.market_hash_name);
          if (match) {
            const dailyRent = match.leaseUnitPrice || match.LeaseUnitPrice || 0;
            if (dailyRent > 0) {
              // æ™®é€šçŸ­ç§Ÿ 188å¤©/å¹´
              return Math.round(188 * dailyRent / price * 100 * 10) / 10;
            }
          }
          return 0;
        },

        // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        // è´§æ¶å›¾ç‰‡ URLï¼ˆä¼˜å…ˆç”¨ imgUrlï¼Œfallback icon_urlï¼‰
        shelfImgUrl(item) {
          const raw = item.imgUrl || item.imgurl || item.icon_url || item.IconUrl;
          if (!raw) return '';
          // æ‚ æ‚ è‡ªæœ‰ CDN åœ°å€ï¼ˆé steam è·¯å¾„ï¼‰ç›´æ¥è¿”å›
          if (raw.startsWith('http')) return raw;
          // Steam economy icon è·¯å¾„
          return `https://community.fastly.steamstatic.com/economy/image/${raw}/62fx62f`;
        },

        // CS2 å“è´¨è‰² â€” ç²¾ç¡®åŒ¹é…æ¸¸æˆå†… rarity é¢œè‰²
        // Consumer=#b0c3d9, Industrial=#5e98d9, Mil-Spec=#4b69ff, Restricted=#8847ff,
        // Classified=#d32ce6, Covert=#eb4b4b, Contraband=#e4ae39, â˜…é‡‘è‰²=#ffd700
        _rarityStyles: {
          contraband:  'color:#e4ae39',    // ç¦å¿Œ (Howlç­‰) â€” é‡‘æ©™
          covert:      'color:#eb4b4b',    // éšç§˜ â€” çº¢
          classified:  'color:#d32ce6',    // ä¿å¯† â€” ç²‰ç´«
          restricted:  'color:#8847ff',    // å—é™ â€” ç´«
          milspec:     'color:#4b69ff',    // å†›è§„ â€” è“
          industrial:  'color:#5e98d9',    // å·¥ä¸š â€” å¤©è“
          consumer:    'color:#b0c3d9',    // æ¶ˆè´¹ â€” æµ…ç°è“
          gold:        'color:#ffd700',    // â˜… é‡‘è‰²
          stattrak:    'color:#cf6a32',    // StatTrakâ„¢ æ©™
          souvenir:    'color:#ffD700',    // çºªå¿µå“ é‡‘
          highgrade:   'color:#b0c3d9',    // High Grade
          base:        'color:#b0c3d9',    // é»˜è®¤
        },

        rarityClass(hashName, itemType) {
          // ä» item_type ç²¾ç¡®åˆ¤æ–­ (å¦‚ "Covert Rifle", "Classified Pistol")
          if (itemType) {
            const t = itemType.toLowerCase();
            if (t.includes('contraband')) return '';
            if (t.includes('extraordinary') || t.includes('covert')) {
              return '';
            }
            if (t.includes('classified')) return '';
            if (t.includes('restricted')) return '';
            if (t.includes('mil-spec') || t.includes('mil_spec')) return '';
            if (t.includes('industrial')) return '';
            if (t.includes('consumer') || t.includes('base grade')) return '';
            if (t.includes('high grade')) return '';
          }
          return '';
        },

        // Returns inline style for rarity color
        rarityStyle(hashName, itemType) {
          const S = this._rarityStyles;
          // 1. Use item_type if available (precise from Steam API)
          if (itemType) {
            const t = itemType.toLowerCase();
            if (t.includes('contraband')) return S.contraband;
            if (t.includes('extraordinary') || t.includes('covert')) {
              if (hashName && hashName.startsWith('â˜…')) return S.gold;
              return S.covert;
            }
            if (t.includes('classified')) return S.classified;
            if (t.includes('restricted')) return S.restricted;
            if (t.includes('mil-spec') || t.includes('mil_spec')) return S.milspec;
            if (t.includes('industrial')) return S.industrial;
            if (t.includes('consumer') || t.includes('base grade')) return S.consumer;
            if (t.includes('high grade')) return S.highgrade;
          }
          // 2. Fallback: pattern match on name
          if (!hashName) return S.base;
          // â˜… items (knives/gloves) â†’ Gold
          if (hashName.startsWith('â˜…')) return S.gold;
          // Contraband
          if (hashName.includes('M4A4 | Howl')) return S.contraband;
          // StatTrakâ„¢ â€” show orange accent
          if (hashName.startsWith('StatTrakâ„¢')) return S.stattrak;
          // Souvenir
          if (hashName.startsWith('Souvenir')) return S.souvenir;
          // Covert weapons (known covert skins by weapon prefix heuristic)
          const covertSkins = ['AWP | Dragon Lore','AWP | Gungnir','AK-47 | Wild Lotus','AK-47 | Gold Arabesque',
            'Desert Eagle | Ocean Drive','M4A4 | Temukau','AK-47 | Inheritance','M4A1-S | Welcome to the Jungle'];
          if (covertSkins.some(s => hashName.includes(s))) return S.covert;
          // Stickers, Cases, Keys â€” typically consumer/industrial
          if (hashName.startsWith('Sticker |') || hashName.startsWith('Patch |')) return S.highgrade;
          if (hashName.includes(' Case') || hashName.includes('Capsule')) return S.milspec;
          if (hashName.startsWith('Sealed Graffiti')) return S.industrial;
          if (hashName.startsWith('Charm |')) return S.restricted;
          if (hashName.startsWith('Music Kit |') || hashName.startsWith('StatTrakâ„¢ Music Kit')) return S.highgrade;
          // Default: base grade
          return S.base;
        },

        fmt(n) {
          if (n == null) return 'â€”';
          return Number(n).toLocaleString('zh-CN', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        },
        pct(part, total) {
          if (!total || part == null) return 0;
          return Math.round(part / total * 100);
        },
        iconUrl(url, size = 62) {
          if (!url) return '';
          if (url.startsWith('http')) return url;
          return `https://community.fastly.steamstatic.com/economy/image/${url}/${size}fx${size}f`;
        },
        statusLbl(s) {
          const map = {
            in_steam: this.t('status_steam'),
            rented_out: this.t('status_rented'),
            in_storage: this.t('status_storage'),
            sold: this.t('status_sold'),
          };
          return map[s] || s || 'â€”';
        },
        statusCls(s) {
          return {
            in_steam:   'bg-blue-500/10 text-blue-400',
            rented_out: 'bg-green-500/10 text-green-400',
            in_storage: 'bg-purple-500/10 text-purple-400',
            sold:       'bg-slate-800 text-slate-600',
          }[s] || 'bg-slate-800 text-slate-600';
        },
        importLbl(k) {
          if (this.nameLang === 'en') return { stock:'Stock (STEAM)', lease:'Lease (rented)', buy:'Buy Records', sell:'Sell Records' }[k] || k;
          return { stock:'åº“å­˜ (STEAM_PROTECTED)', lease:'ç§Ÿèµ (rented_out)', buy:'è´­ä¹°è®°å½•åŒ¹é…', sell:'å‡ºå”®è®°å½•æ ‡è®°' }[k] || k;
        },
        importFields(data) {
          const lm = this.nameLang === 'cn' ? {
            total_fetched:'æ‹‰å–æ¡æ•°', upserted:'å†™å…¥/æ›´æ–°', skipped:'è·³è¿‡',
            total_records:'æ‹‰å–æ¡æ•°', updated:'åŒ¹é…æ›´æ–°', not_found_in_db:'æœªåœ¨åº“å­˜',
            stats:'ç§Ÿèµç»Ÿè®¡', valuation:'æ‚ æ‚ ä¼°å€¼',
          } : {
            total_fetched:'Fetched', upserted:'Upserted', skipped:'Skipped',
            total_records:'Records', updated:'Matched', not_found_in_db:'Not in DB',
            stats:'Lease Stats', valuation:'Valuation',
          };
          return Object.entries(data)
            .filter(([k]) => !['items','not_found_names'].includes(k))
            .map(([k,v]) => [lm[k]||k, v]);
        },
        showToast(msg, type = 'success') {
          this.toast = { msg, type };
          setTimeout(() => { this.toast = { msg:'', type:'success' }; }, 3000);
        },
      };
    }
  </script>
</body>
</html>
